<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FANTINAL - Author Sanctuary</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --bg: #010409; --card: #0d1117; --gold: #d4af37; --text: #f0f6fc; 
            --text-dim: #8b949e; --red: #ff3e3e; --green: #238636;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; }
        h1, h2, h3, .logo { font-family: 'Cinzel', serif; letter-spacing: 2px; color: var(--gold); }
        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.05); }
        .btn { padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-gold { background: linear-gradient(45deg, #d4af37, #fef08a); color: #000; width: 100%; }
        input, textarea, select { width: 100%; padding: 14px; margin: 10px 0; background: #161b22; border: 1px solid #30363d; color: white; border-radius: 12px; box-sizing: border-box; }
        .view { display: none; }
        .active-view { display: block; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #161b22; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid var(--gold); }
        .novel-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #30363d; }
    </style>
</head>
<body>

<div id="loading" style="text-align:center; margin-top:50px;"><h2>Verifying Authority...</h2></div>

<div id="denied-view" class="view" style="text-align:center; margin-top:50px;">
    <h1>Access Denied</h1>
    <p>You do not have Author privileges. Contact Admin.</p>
    <button onclick="window.location.href='index.html'" class="btn btn-gold" style="width:200px;">Back to Library</button>
</div>

<div id="dashboard-view" class="view">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 class="logo">Author Portal</h2>
        <button onclick="auth.signOut()" style="color:var(--red); background:none; border:none; cursor:pointer;">LOGOUT</button>
    </div>

    <div class="card">
        <h3>Sales Analytics</h3>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="startDate" class="datepicker" placeholder="Start Date">
            <input type="text" id="endDate" class="datepicker" placeholder="End Date">
        </div>
        <button onclick="filterSales()" class="btn btn-gold">Filter Report</button>
        
        <div class="stats-grid" style="margin-top:20px;">
            <div class="stat-box">
                <small>Gross Sales</small><br>
                <b id="totalSales">0</b> ü™ô
            </div>
            <div class="stat-box">
                <small>Your Profit (<span id="pRateText">0</span>%)</small><br>
                <b id="yourProfit" style="color:var(--green)">0</b> ü™ô
            </div>
        </div>
    </div>

    <div class="card">
        <h3>My Approved Novels</h3>
        <div id="myNovelsList"></div>
    </div>
</div>

<div id="manage-view" class="view">
    <button onclick="showView('dashboard-view')" class="btn" style="background:none; color:var(--gold); padding:0; margin-bottom:20px;">‚Üê BACK TO DASHBOARD</button>
    <h2 id="currentNovelTitle">Manage Chapters</h2>
    
    <div class="card">
        <h4>Post New Chapter</h4>
        <input type="hidden" id="editChId">
        <input type="number" id="chNum" placeholder="Chapter Number (e.g. 5)">
        <input type="text" id="chTitle" placeholder="Chapter Title">
        <textarea id="chContent" rows="10" placeholder="Write your legendary content here..."></textarea>
        <input type="number" id="chCost" placeholder="Coin Price (0 for Free)">
        <button id="saveChBtn" onclick="saveChapter()" class="btn btn-gold">Publish Chapter</button>
    </div>

    <div class="card">
        <h4>Existing Chapters</h4>
        <div id="chapterList"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, collection, query, where, orderBy, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const config = { apiKey: "AIzaSyBxh92A7E6Egtk4kYB23Wmlelq13YYh1J0", authDomain: "fantinal-publishing-5b960.firebaseapp.com", projectId: "fantinal-publishing-5b960", storageBucket: "fantinal-publishing-5b960.firebasestorage.app", messagingSenderId: "961612304854", appId: "1:961612304854:web:6bf7b03072ed83b58b9477" };
    const app = initializeApp(config);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null, userData = null, selectedNovelId = null;

    flatpickr(".datepicker", { dateFormat: "Y-m-d" });

    onAuthStateChanged(auth, async (user) => {
        document.getElementById('loading').style.display = 'none';
        if (user) {
            currentUser = user;
            const uSnap = await getDoc(doc(db, "users", user.uid));
            if (uSnap.exists() && uSnap.data().role === 'author') {
                userData = uSnap.data();
                showView('dashboard-view');
                loadAuthorDashboard();
            } else {
                showView('denied-view');
            }
        } else {
            window.location.href = "index.html"; // ·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äô·Äõ·Äæ·Ä≠·Äõ·ÄÑ·Ä∫ ·Äô·Ä∞·Äõ·ÄÑ·Ä∫·Ä∏·ÄÖ·Ä¨·Äô·Äª·ÄÄ·Ä∫·Äî·Äæ·Ä¨·Äï·Äº·Äî·Ä∫·Äú·ÄΩ·Äæ·Äê·Ä∫
        }
    });

    async function loadAuthorDashboard() {
        document.getElementById('pRateText').innerText = (userData.profitRate * 100).toFixed(0);
        
        // Load Novels
        const q = query(collection(db, "novels"), where("authorId", "==", currentUser.uid), where("status", "==", "approved"));
        const snap = await getDocs(q);
        const list = document.getElementById('myNovelsList');
        list.innerHTML = snap.empty ? "<p>No approved novels yet.</p>" : "";
        snap.forEach(d => {
            const n = d.data();
            list.innerHTML += `
                <div class="novel-item">
                    <span>${n.title}</span>
                    <button onclick="manageNovel('${d.id}', '${n.title}')" class="btn btn-gold" style="width:100px; padding:5px;">MANAGE</button>
                </div>`;
        });
    }

    window.filterSales = async () => {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        if(!start || !end) return alert("Select Date Range");

        const q = query(collection(db, "transactions"), 
                    where("authorId", "==", currentUser.uid),
                    where("date", ">=", new Date(start)),
                    where("date", "<=", new Date(end)));
        
        const snap = await getDocs(q);
        let total = 0;
        snap.forEach(d => total += (Number(d.data().amount) || 0));
        
        document.getElementById('totalSales').innerText = total.toLocaleString();
        document.getElementById('yourProfit').innerText = (total * userData.profitRate).toLocaleString();
    };

    window.manageNovel = async (nid, title) => {
        selectedNovelId = nid;
        document.getElementById('currentNovelTitle').innerText = title;
        showView('manage-view');
        loadChapters();
    };

    async function loadChapters() {
        const q = query(collection(db, "novels", selectedNovelId, "chapters"), orderBy("num", "desc"));
        const snap = await getDocs(q);
        const list = document.getElementById('chapterList');
        list.innerHTML = "";
        snap.forEach(d => {
            const c = d.data();
            list.innerHTML += `
                <div class="novel-item">
                    <span>Ch ${c.num}: ${c.title}</span>
                    <div>
                        <button onclick="editChapter('${d.id}', ${c.num}, '${c.title}', \`${c.content}\`, ${c.cost})" style="color:var(--gold); background:none; border:none; cursor:pointer;">Edit</button>
                        <button onclick="deleteChapter('${d.id}')" style="color:var(--red); background:none; border:none; cursor:pointer; margin-left:10px;">Del</button>
                    </div>
                </div>`;
        });
    }

    window.saveChapter = async () => {
        const cid = document.getElementById('editChId').value;
        const data = {
            num: Number(document.getElementById('chNum').value),
            title: document.getElementById('chTitle').value,
            content: document.getElementById('chContent').value,
            cost: Number(document.getElementById('chCost').value) || 0,
            lastUpdate: serverTimestamp()
        };

        if(cid) {
            await updateDoc(doc(db, "novels", selectedNovelId, "chapters", cid), data);
        } else {
            await addDoc(collection(db, "novels", selectedNovelId, "chapters"), data);
        }
        
        alert("Chapter Saved Successfully!");
        resetChForm(); loadChapters();
    };

    window.editChapter = (id, num, title, content, cost) => {
        document.getElementById('editChId').value = id;
        document.getElementById('chNum').value = num;
        document.getElementById('chTitle').value = title;
        document.getElementById('chContent').value = content;
        document.getElementById('chCost').value = cost;
        document.getElementById('saveChBtn').innerText = "Update Chapter";
    };

    window.deleteChapter = async (id) => {
        if(confirm("Delete this chapter forever?")) {
            await deleteDoc(doc(db, "novels", selectedNovelId, "chapters", id));
            loadChapters();
        }
    };

    function resetChForm() {
        document.getElementById('editChId').value = "";
        document.getElementById('chNum').value = "";
        document.getElementById('chTitle').value = "";
        document.getElementById('chContent').value = "";
        document.getElementById('chCost').value = "";
        document.getElementById('saveChBtn').innerText = "Publish Chapter";
    }

    window.showView = (id) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
        document.getElementById(id).classList.add('active-view');
    };
</script>
</body>
</html>
