<!DOCTYPE html>
<html>
<head>
    <title>Fantinal Admin V3 - Manager</title>
    <style>
        :root { --gold: #D4AF37; --bg: #0B1120; --card: #111827; }
        body { background: var(--bg); color: white; font-family: sans-serif; padding: 20px; }
        .box { background: var(--card); padding: 20px; border: 1px solid var(--gold); border-radius: 10px; max-width: 600px; margin: 20px auto; }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; background: #1F2937; border: 1px solid #374151; color: white; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--gold); border: none; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 5px; }
        .list-item { background: #1F2937; padding: 10px; margin: 5px 0; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; }
        .edit-btn { background: #3B82F6; width: auto; padding: 5px 10px; font-size: 0.8rem; }
        .del-btn { background: #EF4444; width: auto; padding: 5px 10px; font-size: 0.8rem; margin-left: 5px; }
    </style>
</head>
<body>

<div id="novel-manager" class="box">
    <h2 style="color:var(--gold)">üìñ Novel Management</h2>
    <div id="novel-list-admin">Loading novels...</div>
</div>

<div id="edit-modal" class="box" style="display:none; border-color: #3B82F6;">
    <h2 style="color:#3B82F6">Edit Novel</h2>
    <input type="hidden" id="edit-id">
    <input type="text" id="edit-title" placeholder="Title">
    <input type="text" id="edit-author" placeholder="Author">
    <textarea id="edit-desc" rows="3"></textarea>
    <input type="text" id="edit-cover" placeholder="Cover URL">
    <button onclick="updateNovel()">UPDATE NOW</button>
    <button style="background:gray" onclick="closeEdit()">CANCEL</button>
</div>

<div class="box">
    <h2>‚ûï Add New Chapter</h2>
    <select id="novel-select-chapter"><option>Select Novel</option></select>
    <input type="number" id="c-num" placeholder="Chapter No.">
    <input type="text" id="c-title" placeholder="Chapter Title">
    <textarea id="c-content" placeholder="Content" rows="8"></textarea>
    <input type="number" id="c-cost" placeholder="Coins Cost">
    <button onclick="saveChapter()">PUBLISH</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBxh92A7E6Egtk4kYB23Wmlelq13YYh1J0",
    authDomain: "fantinal-publishing-5b960.firebaseapp.com",
    projectId: "fantinal-publishing-5b960",
    storageBucket: "fantinal-publishing-5b960.firebasestorage.app",
    messagingSenderId: "961612304854",
    appId: "1:961612304854:web:6bf7b03072ed83b58b9477"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ·Äù·Äê·Äπ·Äë·ÄØ·Äô·Äª·Ä¨·Ä∏·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·ÄÜ·ÄΩ·Ä≤·Äë·ÄØ·Äê·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
  async function refreshAdminList() {
    const snap = await getDocs(collection(db, "novels"));
    const listDiv = document.getElementById('novel-list-admin');
    const select = document.getElementById('novel-select-chapter');
    listDiv.innerHTML = "";
    select.innerHTML = "<option value=''>Select Novel</option>";

    snap.forEach(d => {
      const n = d.data();
      // List for Admin Edit
      listDiv.innerHTML += `
        <div class="list-item">
            <span>${n.title}</span>
            <div>
                <button class="edit-btn" onclick="openEdit('${d.id}', '${n.title}', '${n.author}', '${n.desc}', '${n.cover}')">Edit</button>
                <button class="del-btn" onclick="deleteNovel('${d.id}')">Del</button>
            </div>
        </div>`;
      // Dropdown for Chapter
      select.innerHTML += `<option value="${d.id}">${n.title}</option>`;
    });
  }
  refreshAdminList();

  // Edit Novel Open
  window.openEdit = (id, title, author, desc, cover) => {
    document.getElementById('edit-modal').style.display = 'block';
    document.getElementById('edit-id').value = id;
    document.getElementById('edit-title').value = title;
    document.getElementById('edit-author').value = author;
    document.getElementById('edit-desc').value = desc;
    document.getElementById('edit-cover').value = cover;
    window.scrollTo(0,0);
  };

  window.closeEdit = () => document.getElementById('edit-modal').style.display = 'none';

  // Update Novel Logic
  window.updateNovel = async () => {
    const id = document.getElementById('edit-id').value;
    const ref = doc(db, "novels", id);
    await updateDoc(ref, {
      title: document.getElementById('edit-title').value,
      author: document.getElementById('edit-author').value,
      desc: document.getElementById('edit-desc').value,
      cover: document.getElementById('edit-cover').value
    });
    alert("Updated!");
    location.reload();
  };

  // Delete Novel
  window.deleteNovel = async (id) => {
    if(confirm("Are you sure? All chapters will stay but novel link will be gone.")){
        await deleteDoc(doc(db, "novels", id));
        refreshAdminList();
    }
  };

  // Chapter Logic
  window.saveChapter = async () => {
    const nid = document.getElementById('novel-select-chapter').value;
    if(!nid) return alert("Select novel first!");
    await addDoc(collection(db, "novels", nid, "chapters"), {
      num: Number(document.getElementById('c-num').value),
      title: document.getElementById('c-title').value,
      content: document.getElementById('c-content').value,
      cost: Number(document.getElementById('c-cost').value),
      createdAt: serverTimestamp()
    });
    alert("Chapter Published!");
    location.reload();
  };
</script>
</body>
</html>
