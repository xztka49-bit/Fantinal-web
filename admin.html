<!DOCTYPE html>
<html>
<head>
    <title>Fantinal Admin - Master Control</title>
    <style>
        :root { --gold: #D4AF37; --bg: #0B1120; --card: #111827; --blue: #3B82F6; --red: #EF4444; --green: #10B981; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        .box { background: var(--card); padding: 20px; border: 1px solid var(--gold); border-radius: 12px; margin-bottom: 25px; }
        h2 { color: var(--gold); border-bottom: 1px solid #374151; padding-bottom: 10px; margin-top: 0; font-size: 1.2rem; }
        
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; background: #1F2937; border: 1px solid #374151; color: white; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--gold); border: none; font-weight: bold; border-radius: 6px; cursor: pointer; margin-top: 5px; color: #000; }
        
        .list-item { background: #1F2937; padding: 12px; margin: 8px 0; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; border-left: 4px solid var(--gold); }
        .btn-group { display: flex; gap: 5px; }
        .btn-sm { width: auto; padding: 6px 12px; font-size: 0.8rem; color: white; }
        
        /* Modal Style for Edit */
        #edit-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; width: 90%; max-width: 500px; background: var(--card); border: 2px solid var(--blue); }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 90; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="color: var(--gold); text-align: center;">FANTINAL MASTER ADMIN</h1>

    <div class="box" style="border-color: var(--green);">
        <h2 style="color: var(--green);">üéüÔ∏è Gift Code Generator</h2>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="gift-amount" placeholder="Coin Amount (e.g. 1000)">
            <button onclick="generateGiftCode()" style="background: var(--green); color: white; width: 200px;">Create Code</button>
        </div>
        <div id="recent-code" style="margin-top: 10px; color: var(--green); font-weight: bold; text-align: center;"></div>
    </div>

    <div class="box">
        <h2>üìñ Add New Novel</h2>
        <input type="text" id="n-title" placeholder="Novel Title">
        <input type="text" id="n-author" placeholder="Author Name">
        <textarea id="n-desc" placeholder="Novel Description" rows="2"></textarea>
        <input type="text" id="n-cover" placeholder="Cover Image URL">
        <button onclick="saveNovel()">UPLOAD NOVEL</button>
    </div>

    <div class="box">
        <h2>üìë Chapter Manager (Add & Edit)</h2>
        <select id="novel-select-main" onchange="loadChaptersForEdit()">
            <option value="">-- Select Novel to Manage Chapters --</option>
        </select>
        
        <div id="chapter-list-area" style="margin: 15px 0; max-height: 300px; overflow-y: auto;">
            </div>

        <hr style="border: 0.5px solid #374151; margin: 20px 0;">
        <h4 id="form-mode-title">Add New Chapter</h4>
        <input type="number" id="c-num" placeholder="Chapter No.">
        <input type="text" id="c-title" placeholder="Chapter Title">
        <textarea id="c-content" placeholder="Story Content..." rows="6"></textarea>
        <input type="number" id="c-cost" placeholder="Coins Cost">
        <button id="chapter-btn" onclick="saveChapter()">PUBLISH CHAPTER</button>
    </div>

    <div class="box">
        <h2>‚öôÔ∏è Existing Novels</h2>
        <div id="novel-list-admin"></div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closeEdit()"></div>
<div id="edit-modal" class="box">
    <h2 id="edit-header">Edit Content</h2>
    <input type="hidden" id="edit-type"> <input type="hidden" id="edit-id">
    <input type="hidden" id="edit-parent-id">
    <div id="edit-fields"></div>
    <button onclick="updateData()" id="update-btn" style="background: var(--blue); color: white;">UPDATE</button>
    <button onclick="closeEdit()" style="background: #4B5563; color: white; margin-top: 10px;">CANCEL</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, serverTimestamp, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBxh92A7E6Egtk4kYB23Wmlelq13YYh1J0",
    authDomain: "fantinal-publishing-5b960.firebaseapp.com",
    projectId: "fantinal-publishing-5b960",
    storageBucket: "fantinal-publishing-5b960.firebasestorage.app",
    messagingSenderId: "961612304854",
    appId: "1:961612304854:web:6bf7b03072ed83b58b9477"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- 1. Load Data ---
  async function refreshAll() {
    const snap = await getDocs(collection(db, "novels"));
    const listDiv = document.getElementById('novel-list-admin');
    const select = document.getElementById('novel-select-main');
    listDiv.innerHTML = "";
    select.innerHTML = '<option value="">-- Select Novel to Manage Chapters --</option>';

    snap.forEach(d => {
      const n = d.data();
      listDiv.innerHTML += `
        <div class="list-item">
            <span>${n.title}</span>
            <div class="btn-group">
                <button class="btn-sm" style="background: var(--blue)" onclick="openNovelEdit('${d.id}', '${n.title}', '${n.author}', '${n.desc}', '${n.cover}')">Edit</button>
                <button class="btn-sm" style="background: var(--red)" onclick="deleteNovel('${d.id}')">Del</button>
            </div>
        </div>`;
      select.innerHTML += `<option value="${d.id}">${n.title}</option>`;
    });
  }
  refreshAll();

  // --- 2. Gift Code System ---
  window.generateGiftCode = async () => {
    const amt = document.getElementById('gift-amount').value;
    if(!amt) return alert("Enter amount!");
    const code = "FAN-" + Math.random().toString(36).substr(2, 8).toUpperCase();
    await addDoc(collection(db, "gift_codes"), {
      code: code, amount: Number(amt), isUsed: false, createdAt: serverTimestamp()
    });
    document.getElementById('recent-code').innerText = "Generated Code: " + code;
    alert("Code Created: " + code);
  };

  // --- 3. Novel Actions ---
  window.saveNovel = async () => {
    await addDoc(collection(db, "novels"), {
      title: document.getElementById('n-title').value,
      author: document.getElementById('n-author').value,
      desc: document.getElementById('n-desc').value,
      cover: document.getElementById('n-cover').value,
      createdAt: serverTimestamp()
    });
    alert("Novel Saved!"); refreshAll();
  };

  // --- 4. Chapter Actions & Edit ---
  window.loadChaptersForEdit = async () => {
    const nid = document.getElementById('novel-select-main').value;
    const listDiv = document.getElementById('chapter-list-area');
    if(!nid) { listDiv.innerHTML = ""; return; }
    
    listDiv.innerHTML = "Loading...";
    const q = query(collection(db, "novels", nid, "chapters"), orderBy("num", "asc"));
    const snap = await getDocs(q);
    listDiv.innerHTML = "";
    snap.forEach(d => {
        const c = d.data();
        listDiv.innerHTML += `
        <div class="list-item" style="border-left-color: var(--blue); font-size: 0.9rem;">
            <span>Ch-${c.num}: ${c.title}</span>
            <div class="btn-group">
                <button class="btn-sm" style="background: var(--blue)" onclick="openChapterEdit('${nid}', '${d.id}', ${c.num}, '${c.title}', \`${c.content.replace(/`/g, '\\`')}\`, ${c.cost})">Edit</button>
                <button class="btn-sm" style="background: var(--red)" onclick="deleteChapter('${nid}', '${d.id}')">Del</button>
            </div>
        </div>`;
    });
  };

  window.saveChapter = async () => {
    const nid = document.getElementById('novel-select-main').value;
    if(!nid) return alert("Select a novel!");
    await addDoc(collection(db, "novels", nid, "chapters"), {
      num: Number(document.getElementById('c-num').value),
      title: document.getElementById('c-title').value,
      content: document.getElementById('c-content').value,
      cost: Number(document.getElementById('c-cost').value),
      createdAt: serverTimestamp()
    });
    alert("Chapter Published!"); loadChaptersForEdit();
  };

  // --- 5. Universal Edit Logic ---
  window.openNovelEdit = (id, title, author, desc, cover) => {
    showModal("Edit Novel", "novel", id, "");
    document.getElementById('edit-fields').innerHTML = `
        <input type="text" id="up-title" value="${title}">
        <input type="text" id="up-author" value="${author}">
        <textarea id="up-desc" rows="3">${desc}</textarea>
        <input type="text" id="up-cover" value="${cover}">
    `;
  };

  window.openChapterEdit = (nid, cid, num, title, content, cost) => {
    showModal("Edit Chapter", "chapter", cid, nid);
    document.getElementById('edit-fields').innerHTML = `
        <input type="number" id="up-num" value="${num}">
        <input type="text" id="up-title" value="${title}">
        <textarea id="up-content" rows="8">${content}</textarea>
        <input type="number" id="up-cost" value="${cost}">
    `;
  };

  function showModal(title, type, id, pid) {
    document.getElementById('edit-modal').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('edit-header').innerText = title;
    document.getElementById('edit-type').value = type;
    document.getElementById('edit-id').value = id;
    document.getElementById('edit-parent-id').value = pid;
  }

  window.closeEdit = () => {
    document.getElementById('edit-modal').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
  };

  window.updateData = async () => {
    const type = document.getElementById('edit-type').value;
    const id = document.getElementById('edit-id').value;
    const pid = document.getElementById('edit-parent-id').value;

    if(type === "novel") {
        await updateDoc(doc(db, "novels", id), {
            title: document.getElementById('up-title').value,
            author: document.getElementById('up-author').value,
            desc: document.getElementById('up-desc').value,
            cover: document.getElementById('up-cover').value
        });
    } else {
        await updateDoc(doc(db, "novels", pid, "chapters", id), {
            num: Number(document.getElementById('up-num').value),
            title: document.getElementById('up-title').value,
            content: document.getElementById('up-content').value,
            cost: Number(document.getElementById('up-cost').value)
        });
    }
    alert("Updated Successfully!"); closeEdit(); refreshAll(); loadChaptersForEdit();
  };

  window.deleteNovel = async (id) => { if(confirm("Delete Novel?")) { await deleteDoc(doc(db, "novels", id)); refreshAll(); } };
  window.deleteChapter = async (nid, cid) => { if(confirm("Delete Chapter?")) { await deleteDoc(doc(db, "novels", nid, "chapters", cid)); loadChaptersForEdit(); } };

</script>
</body>
</html>
