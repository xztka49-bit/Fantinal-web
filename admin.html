<!DOCTYPE html>
<html>
<head>
    <title>Fantinal Admin - Full Fixed</title>
    <style>
        :root { --gold: #D4AF37; --bg: #0B1120; --card: #111827; --blue: #3B82F6; --red: #EF4444; --green: #10B981; }
        body { background: var(--bg); color: white; font-family: sans-serif; padding: 20px; }
        .box { background: var(--card); padding: 20px; border: 1px solid var(--gold); border-radius: 12px; margin-bottom: 20px; }
        h2 { color: var(--gold); font-size: 1.1rem; border-bottom: 1px solid #374151; padding-bottom: 8px; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; background: #1F2937; border: 1px solid #374151; color: white; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--gold); border: none; font-weight: bold; border-radius: 6px; cursor: pointer; margin-top: 5px; }
        .list-item { background: #1F2937; padding: 10px; margin: 8px 0; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; border-left: 4px solid var(--gold); }
        .btn-sm { width: auto; padding: 6px 12px; font-size: 0.8rem; color: white; border-radius: 4px; border: none; cursor: pointer; margin-left: 5px; }
        #edit-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 500px; background: var(--card); border: 2px solid var(--blue); box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 900; }
    </style>
</head>
<body>

<div style="max-width: 800px; margin: auto;">
    <h1 style="color: var(--gold); text-align: center;">FANTINAL ADMIN PRO</h1>

    <div class="box" style="border-color: var(--green);">
        <h2 style="color: var(--green);">üéüÔ∏è Auto Gift Code Generator</h2>
        <div style="display:flex; gap:10px;">
            <input type="number" id="gift-amount" placeholder="Amount (e.g. 5000)" oninput="autoGenCode()">
            <input type="text" id="gift-code-display" readonly placeholder="Auto Code" style="background: #000; color: var(--green); font-weight: bold;">
        </div>
        <button id="gift-btn" onclick="saveGiftCode()" style="background: var(--green); color: white; display:none;">ACTIVATE THIS CODE</button>
    </div>

    <div class="box">
        <h2>üìñ Add Novel</h2>
        <input type="text" id="n-title" placeholder="Title">
        <input type="text" id="n-author" placeholder="Author">
        <textarea id="n-desc" placeholder="Summary" rows="2"></textarea>
        <input type="text" id="n-cover" placeholder="Cover Image URL">
        <button onclick="saveNovel()">SAVE NOVEL</button>
    </div>

    <div class="box">
        <h2>üìë Chapter Manager</h2>
        <select id="novel-select" onchange="loadChapters()"><option value="">-- Select Novel --</option></select>
        <div id="chapter-list" style="margin: 15px 0;"></div>
        <hr style="border:0.5px solid #374151;">
        <h4>Add Chapter</h4>
        <input type="number" id="c-num" placeholder="No.">
        <input type="text" id="c-title" placeholder="Chapter Title">
        <textarea id="c-content" rows="5" placeholder="Story..."></textarea>
        <input type="number" id="c-cost" placeholder="Coins">
        <button onclick="saveChapter()" style="background: var(--blue); color: white;">PUBLISH CHAPTER</button>
    </div>

    <div class="box">
        <h2>‚öôÔ∏è Novel List</h2>
        <div id="novel-list-admin"></div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closeEdit()"></div>
<div id="edit-modal" class="box">
    <h2 id="edit-header" style="color: var(--blue);">Edit Content</h2>
    <div id="edit-fields"></div>
    <button onclick="applyUpdate()" style="background: var(--blue); color: white;">UPDATE NOW</button>
    <button onclick="closeEdit()" style="background: #4B5563; color: white;">CANCEL</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBxh92A7E6Egtk4kYB23Wmlelq13YYh1J0",
        authDomain: "fantinal-publishing-5b960.firebaseapp.com",
        projectId: "fantinal-publishing-5b960",
        storageBucket: "fantinal-publishing-5b960.firebasestorage.app",
        messagingSenderId: "961612304854",
        appId: "1:961612304854:web:6bf7b03072ed83b58b9477"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Load Data
    async function init() {
        const snap = await getDocs(collection(db, "novels"));
        const list = document.getElementById('novel-list-admin');
        const sel = document.getElementById('novel-select');
        list.innerHTML = ""; sel.innerHTML = '<option value="">-- Select Novel --</option>';
        snap.forEach(d => {
            const n = d.data();
            list.innerHTML += `<div class="list-item"><span>${n.title}</span><button class="btn-sm" style="background:var(--red)" onclick="deleteNovel('${d.id}')">Delete</button></div>`;
            sel.innerHTML += `<option value="${d.id}">${n.title}</option>`;
        });
    }
    init();

    // Auto Gift Code Logic
    window.autoGenCode = () => {
        const amt = document.getElementById('gift-amount').value;
        const codeDisplay = document.getElementById('gift-code-display');
        const btn = document.getElementById('gift-btn');
        if(amt > 0) {
            const code = "FAN-" + Math.random().toString(36).substr(2, 6).toUpperCase() + "-" + amt;
            codeDisplay.value = code;
            btn.style.display = 'block';
        } else { btn.style.display = 'none'; codeDisplay.value = ""; }
    };

    window.saveGiftCode = async () => {
        const code = document.getElementById('gift-code-display').value;
        const amt = document.getElementById('gift-amount').value;
        await addDoc(collection(db, "gift_codes"), { code, amount: Number(amt), isUsed: false });
        alert("Gift Code Activated: " + code);
        document.getElementById('gift-amount').value = "";
        window.autoGenCode();
    };

    window.saveNovel = async () => {
        await addDoc(collection(db, "novels"), {
            title: document.getElementById('n-title').value,
            author: document.getElementById('n-author').value,
            desc: document.getElementById('n-desc').value,
            cover: document.getElementById('n-cover').value,
            createdAt: serverTimestamp()
        });
        alert("Novel Added!"); init();
    };

    window.loadChapters = async () => {
        const nid = document.getElementById('novel-select').value;
        const list = document.getElementById('chapter-list');
        if(!nid) return list.innerHTML = "";
        const q = query(collection(db, "novels", nid, "chapters"), orderBy("num", "asc"));
        const snap = await getDocs(q);
        list.innerHTML = "";
        snap.forEach(d => {
            const c = d.data();
            list.innerHTML += `<div class="list-item" style="border-left-color: var(--blue)">
                <span>Ch-${c.num}: ${c.title}</span>
                <button class="btn-sm" style="background:var(--blue)" onclick="openEditCh('${nid}', '${d.id}', ${c.num}, '${c.title}', \`${c.content.replace(/`/g, '\\`')}\`, ${c.cost})">Edit</button>
            </div>`;
        });
    };

    window.saveChapter = async () => {
        const nid = document.getElementById('novel-select').value;
        await addDoc(collection(db, "novels", nid, "chapters"), {
            num: Number(document.getElementById('c-num').value),
            title: document.getElementById('c-title').value,
            content: document.getElementById('c-content').value,
            cost: Number(document.getElementById('c-cost').value),
            createdAt: serverTimestamp()
        });
        alert("Chapter Added!"); loadChapters();
    };

    // Global Edit Logic
    let currentEditData = {};
    window.openEditCh = (nid, cid, num, title, content, cost) => {
        currentEditData = { nid, cid };
        document.getElementById('edit-modal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('edit-fields').innerHTML = `
            <input type="number" id="up-num" value="${num}">
            <input type="text" id="up-title" value="${title}">
            <textarea id="up-content" rows="8">${content}</textarea>
            <input type="number" id="up-cost" value="${cost}">
        `;
    };

    window.closeEdit = () => {
        document.getElementById('edit-modal').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    };

    window.applyUpdate = async () => {
        const { nid, cid } = currentEditData;
        await updateDoc(doc(db, "novels", nid, "chapters", cid), {
            num: Number(document.getElementById('up-num').value),
            title: document.getElementById('up-title').value,
            content: document.getElementById('up-content').value,
            cost: Number(document.getElementById('up-cost').value)
        });
        alert("Updated!"); closeEdit(); loadChapters();
    };

    window.deleteNovel = async (id) => { if(confirm("Delete?")) { await deleteDoc(doc(db, "novels", id)); init(); } };
</script>
</body>
</html>
