<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FANTINAL PRESTIGE LUXURY V26</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;400;600;800&display=swap');
        :root { --gold: #d4af37; --dark: #05070a; --glass: rgba(15, 15, 20, 0.85); }
        body { background: var(--dark); color: #e2e8f0; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        .luxury-font { font-family: 'Cinzel', serif; }
        .glass-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(212, 175, 55, 0.15); border-radius: 20px; }
        .gold-text { background: linear-gradient(135deg, #d4af37, #f9e29c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-premium { background: linear-gradient(135deg, #d4af37, #f9e29c); color: black; font-weight: 800; transition: 0.3s; }
        .btn-premium:active { transform: scale(0.95); }
        .sidebar { position: fixed; right: -100%; top: 0; width: 85%; height: 100%; background: var(--dark); z-index: 5000; transition: 0.4s cubic-bezier(0.77, 0, 0.175, 1); border-left: 1px solid rgba(212, 175, 55, 0.2); }
        .sidebar.active { right: 0; }
        input, select, textarea { background: rgba(255,255,255,0.03) !important; border: 1px solid rgba(212, 175, 55, 0.2) !important; padding: 14px; border-radius: 12px; color: white; width: 100%; margin-bottom: 15px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .chat-bubble { max-width: 80%; padding: 12px; border-radius: 15px; margin-bottom: 10px; font-size: 12px; }
    </style>
</head>
<body class="no-scrollbar">

    <div id="notiBox" class="fixed top-6 right-6 z-[9999] flex flex-col gap-3"></div>
    <div id="overlay" class="fixed inset-0 bg-black/80 hidden z-[4000] backdrop-blur-md" onclick="toggleMenu()"></div>

    <div id="sidebar" class="sidebar p-8">
        <div class="flex justify-between items-center mb-10">
            <h2 class="luxury-font text-xl gold-text font-bold">PRESTIGE</h2>
            <button onclick="toggleMenu()" class="text-2xl">‚úï</button>
        </div>
        <div class="glass-card p-6 mb-8">
            <p id="userEmail" class="text-[10px] opacity-40 uppercase mb-2">Member</p>
            <p id="uBalance" class="text-2xl font-black luxury-font">0 C</p>
            <p class="text-[8px] text-gold uppercase font-bold tracking-widest">Available Credits</p>
        </div>
        <nav class="space-y-3">
            <div onclick="showSection('homeSection'); toggleMenu()" class="p-4 glass-card text-xs font-bold uppercase tracking-widest cursor-pointer">Home Library</div>
            <div onclick="showSection('chatSection'); toggleMenu()" class="p-4 glass-card text-xs font-bold uppercase tracking-widest cursor-pointer text-blue-400">Global Lounge</div>
            <div onclick="showSection('depositSection'); toggleMenu()" class="p-4 btn-premium rounded-xl text-xs font-black uppercase text-center cursor-pointer">Top Up Credits</div>
            <div onclick="showSection('transferSection'); toggleMenu()" class="p-4 glass-card text-xs font-bold uppercase tracking-widest cursor-pointer">Transfer Coins</div>
            <div onclick="showSection('giftSection'); toggleMenu()" class="p-4 glass-card text-xs font-bold uppercase tracking-widest cursor-pointer">Redeem Code</div>
            <div onclick="auth.signOut()" class="p-4 text-red-500 text-center text-[10px] font-black uppercase mt-10 cursor-pointer">Sign Out</div>
        </nav>
    </div>

    <nav class="sticky top-0 z-[3000] px-6 py-5 glass-card border-none flex justify-between items-center">
        <h1 onclick="location.reload()" class="luxury-font text-2xl font-black gold-text cursor-pointer">FANTINAL</h1>
        <button onclick="toggleMenu()" class="p-2 text-gold"><svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 8h20M4 16h20M4 24h20"/></svg></button>
    </nav>

    <main class="max-w-xl mx-auto p-6 pb-32">
        
        <div id="authSection" class="hidden py-10 text-center">
            <h2 class="luxury-font text-4xl gold-text mb-12">ACCESS</h2>
            <div class="glass-card p-8 space-y-2">
                <input type="email" id="lEmail" placeholder="Email">
                <input type="password" id="lPass" placeholder="Password">
                <button onclick="login()" class="w-full btn-premium py-4 uppercase text-xs tracking-widest mt-4 rounded-xl">Login</button>
                <button onclick="register()" class="w-full text-[9px] opacity-40 uppercase mt-4">Create Account</button>
            </div>
        </div>

        <div id="homeSection" class="hidden">
            <input type="text" id="searchInput" oninput="searchBooks()" placeholder="Search archives..." class="mb-6">
            <div id="bookGrid" class="grid grid-cols-2 gap-6"></div>
            <div id="adminBtn" class="hidden mt-12 space-y-4">
                <button onclick="showSection('vsDashboard')" class="w-full py-4 glass-card text-gold text-[10px] font-black uppercase">V&S Analytics</button>
                <button onclick="showSection('adminDashboard')" class="w-full py-4 bg-red-900/20 text-red-500 border border-red-500/40 rounded-xl text-[10px] font-black uppercase">Admin Terminal</button>
            </div>
        </div>

        <div id="chatSection" class="hidden">
            <button onclick="showSection('homeSection')" class="mb-4 text-[10px] font-bold">‚Üê BACK</button>
            <div class="glass-card flex flex-col h-[70vh]">
                <div id="chatBody" class="flex-1 overflow-y-auto p-4 no-scrollbar"></div>
                <div class="p-4 flex gap-2 border-t border-white/5">
                    <input type="text" id="chatInput" placeholder="Write message..." class="mb-0">
                    <button onclick="sendChat()" class="btn-premium px-6 rounded-xl text-[10px] font-black">SEND</button>
                </div>
            </div>
        </div>

        <div id="vsDashboard" class="hidden">
            <button onclick="showSection('homeSection')" class="mb-6 text-[10px] font-bold">‚Üê EXIT</button>
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="glass-card p-6 text-center"><p class="text-[8px] opacity-40 uppercase">Total Views</p><p id="vTotal" class="text-2xl font-black luxury-font">0</p></div>
                <div class="glass-card p-6 text-center"><p class="text-[8px] opacity-40 uppercase">Total Sales</p><p id="sTotal" class="text-2xl font-black luxury-font gold-text">0 C</p></div>
            </div>
            <h3 class="luxury-font text-sm gold-text mb-4">Content Performance</h3>
            <div id="vsList" class="space-y-3"></div>
        </div>

        <div id="adminDashboard" class="hidden">
            <button onclick="showSection('homeSection')" class="mb-6 text-[10px] font-bold text-red-500">‚Üê EXIT TERMINAL</button>
            
            <div class="glass-card p-6 mb-8">
                <p class="text-[10px] font-black gold-text mb-4">REVENUE ANALYTICS</p>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <input type="date" id="revStart" class="text-xs">
                    <input type="date" id="revEnd" class="text-xs">
                </div>
                <div class="flex justify-between items-center bg-white/5 p-4 rounded-xl">
                    <div><p class="text-[8px] opacity-40">TOTAL INCOME</p><p id="admIncome" class="text-xl font-black">0 C</p></div>
                    <div class="text-right"><p class="text-[8px] opacity-40">GIFT DISBURSED</p><p id="admGiftPool" class="text-xl font-black text-blue-400">0 C</p></div>
                </div>
                <button onclick="calculateRevenue()" class="w-full mt-4 py-3 bg-white/10 rounded-xl text-[9px] font-bold uppercase">Generate Report</button>
            </div>

            <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6 bg-white/5 p-1 rounded-xl">
                <button onclick="setTab('nov')" class="adm-t px-6 py-3 rounded-lg text-[9px] font-black bg-gold text-black uppercase">Books</button>
                <button onclick="setTab('pay')" class="adm-t px-6 py-3 rounded-lg text-[9px] font-black uppercase">Orders</button>
                <button onclick="setTab('users')" class="adm-t px-6 py-3 rounded-lg text-[9px] font-black uppercase">Users</button>
                <button onclick="setTab('gift')" class="adm-t px-6 py-3 rounded-lg text-[9px] font-black uppercase">Gifts</button>
            </div>

            <div id="tab-nov">
                <button onclick="openNovelForm()" class="w-full btn-premium py-4 text-[10px] font-black uppercase mb-4 rounded-xl">+ REGISTER BOOK</button>
                <div id="admNovList" class="space-y-3"></div>
            </div>
            <div id="tab-pay" class="hidden space-y-3"></div>
            <div id="tab-users" class="hidden space-y-3"></div>
            <div id="tab-gift" class="hidden">
                <input type="number" id="gAmt" placeholder="Coin Amount">
                <button onclick="generateGift()" class="w-full btn-premium py-4 text-[10px] font-black uppercase rounded-xl">Create Code</button>
                <div id="admGiftList" class="mt-6 space-y-3"></div>
            </div>
        </div>

        <div id="depositSection" class="hidden">
            <button onclick="showSection('homeSection')" class="mb-6 text-[10px] font-bold">‚Üê BACK</button>
            <div class="glass-card p-6 mb-6 border-l-4 border-gold">
                <p class="text-xs font-bold gold-text mb-2">PAYMENT INFORMATION</p>
                <p class="text-[11px] mb-1 opacity-80 font-bold">KBZ Pay / Wave Pay</p>
                <p class="text-xl font-black tracking-widest mb-1">09 759 741 746</p>
                <p class="text-xs font-bold opacity-60 uppercase mb-3">THU KHA AUNG</p>
                <div class="p-3 bg-white/5 rounded-lg text-center border border-white/10">
                    <p class="text-[10px] font-black uppercase gold-text">Exchange Rate: 1 Coin = 1 MMK</p>
                </div>
            </div>
            <div class="glass-card p-6">
                <select id="payAmt">
                    <option value="1000">1,000 MMK (1000 C)</option>
                    <option value="5000">5,000 MMK (5000 C)</option>
                    <option value="10000">10,000 MMK (10000 C)</option>
                </select>
                <input type="text" id="payTid" placeholder="Transaction ID (Last 6 digits)">
                <button onclick="submitPay()" class="w-full btn-premium py-4 text-xs font-black uppercase rounded-xl mt-2">Submit Order</button>
            </div>
        </div>

        <div id="chapterView" class="hidden">
            <button onclick="showSection('homeSection')" class="mb-6 text-[10px] font-bold">‚Üê LIBRARY</button>
            <h2 id="bTitle" class="luxury-font text-3xl font-black gold-text mb-6">...</h2>
            <div id="admChapAdd" class="hidden mb-6">
                <button onclick="openChapForm()" class="w-full py-4 border border-gold/40 text-gold text-[10px] font-black uppercase rounded-xl">+ ADD CHAPTER</button>
            </div>
            <div id="chapList" class="space-y-3"></div>
        </div>

        <div id="readerSection" class="hidden fixed inset-0 bg-[#05070a] z-[6000] p-8 overflow-y-auto">
            <div class="max-w-xl mx-auto pb-20">
                <button onclick="showSection('chapterView')" class="text-gold text-2xl mb-10">‚úï</button>
                <div id="readerBody" class="text-lg leading-[2] text-slate-300"></div>
            </div>
        </div>

        <div id="novelForm" class="hidden"><h2 class="luxury-font text-xl mb-6">NOVEL EDITOR</h2><input id="nTitle" placeholder="Title"><input id="nCover" placeholder="Cover URL"><select id="nGenre"><option>Fan Fiction</option><option>Life</option><option>True</option><option>Mega</option></select><button onclick="saveNovel()" class="w-full btn-premium py-4 uppercase rounded-xl">Save Archive</button></div>
        <div id="chapForm" class="hidden"><h2 class="luxury-font text-xl mb-6">CHAPTER EDITOR</h2><input id="cTitle" placeholder="Chapter Title"><textarea id="cContent" rows="12" placeholder="The narrative..."></textarea><input type="number" id="cPrice" placeholder="Price (0 = Free)"><button onclick="saveChap()" class="w-full btn-premium py-4 uppercase rounded-xl">Commit Chapter</button></div>

        <div id="giftSection" class="hidden"><div class="glass-card p-8"><h2 class="luxury-font text-xl gold-text mb-6">REDEEM TOKEN</h2><input id="redeemIn" placeholder="Token Code"><button onclick="redeemGift()" class="w-full btn-premium py-4 rounded-xl">Claim Credits</button></div></div>
        <div id="transferSection" class="hidden"><div class="glass-card p-8"><h2 class="luxury-font text-xl gold-text mb-6">COIN TRANSFER</h2><input id="tEmail" placeholder="Recipient Email"><input type="number" id="tAmt" placeholder="Amount"><button onclick="transferCoins()" class="w-full btn-premium py-4 rounded-xl">Confirm Transfer</button></div></div>

    </main>

    <script>
        // CONFIG (Update with your Firebase keys)
        const firebaseConfig = {
            apiKey: "AIzaSyBxh92A7E6Egtk4kYB23Wmlelq13YYh1J0",
            authDomain: "fantinal-publishing-5b960.firebaseapp.com",
            projectId: "fantinal-publishing-5b960",
            storageBucket: "fantinal-publishing-5b960.firebasestorage.app",
            messagingSenderId: "961612304854",
            appId: "1:961612304854:web:6bf7b03072ed83b58b9477",
            measurementId: "G-3X5NP67TX7"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();

        let curU = null, curB = null, curE = null, allB = [];

        // AUTH & MONITORING
        auth.onAuthStateChanged(user => {
            if(user) {
                curU = user;
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    const d = doc.data();
                    document.getElementById('uBalance').innerText = (d.coins || 0) + " C";
                    document.getElementById('userEmail').innerText = user.email;
                    if(user.email === 'xztka49@gmail.com') {
                        document.getElementById('adminBtn').classList.remove('hidden');
                        document.getElementById('admChapAdd').classList.remove('hidden');
                    }
                });
                showSection('homeSection'); loadBooks(); loadChat();
            } else showSection('authSection');
        });

        async function login() { await auth.signInWithEmailAndPassword(document.getElementById('lEmail').value, document.getElementById('lPass').value); }
        async function register() {
            const r = await auth.createUserWithEmailAndPassword(document.getElementById('lEmail').value, document.getElementById('lPass').value);
            await db.collection('users').doc(r.user.uid).set({ email: r.user.email, coins: 0, bought: [], date: new Date() });
        }

        // NOVEL SYSTEM (Point 3)
        async function loadBooks() {
            const snap = await db.collection('books').get();
            allB = snap.docs.map(d => ({id: d.id, ...d.data()}));
            document.getElementById('bookGrid').innerHTML = allB.map(b => `
                <div class="glass-card overflow-hidden" onclick="openBook('${b.id}')">
                    <img src="${b.cover}" class="h-44 w-full object-cover">
                    <div class="p-4"><p class="text-[9px] gold-text font-bold uppercase">${b.genre}</p><p class="text-[10px] font-black truncate">${b.title}</p></div>
                </div>`).join('');
            
            if(curU.email === 'xztka49@gmail.com') {
                document.getElementById('admNovList').innerHTML = allB.map(b => `
                    <div class="glass-card p-4 flex justify-between items-center">
                        <span class="text-[10px] font-bold truncate w-32">${b.title}</span>
                        <div class="flex gap-3">
                            <button onclick="editNovel('${b.id}')" class="text-blue-400 text-[10px] font-bold">EDIT</button>
                            <button onclick="deleteNovel('${b.id}')" class="text-red-500 text-[10px] font-bold">DEL</button>
                        </div>
                    </div>`).join('');
                loadAdminStats();
            }
        }

        async function openBook(id) {
            curB = id; showSection('chapterView');
            const b = allB.find(x => x.id === id);
            document.getElementById('bTitle').innerText = b.title;
            await db.collection('books').doc(id).update({ views: firebase.firestore.FieldValue.increment(1) });
            loadChaps();
        }

        // CHAPTER SYSTEM (Point 4)
        async function loadChaps() {
            const snap = await db.collection('books').doc(curB).collection('chapters').orderBy('date', 'asc').get();
            const uDoc = await db.collection('users').doc(curU.uid).get();
            const bought = uDoc.data().bought || [];
            
            document.getElementById('chapList').innerHTML = snap.docs.map((doc, i) => {
                const c = doc.data();
                const canRead = c.price === 0 || bought.includes(doc.id) || curU.email === 'xztka49@gmail.com';
                return `<div class="p-4 glass-card flex justify-between items-center">
                    <div><p class="text-[7px] opacity-40">EP ${i+1}</p><p class="text-[10px] font-black uppercase">${c.title}</p></div>
                    <div class="flex gap-4">
                        ${curU.email === 'xztka49@gmail.com' ? `
                            <button onclick="editChap('${doc.id}')" class="text-blue-400 text-[9px] font-bold">EDIT</button>
                            <button onclick="deleteChap('${doc.id}')" class="text-red-500 text-[9px] font-bold">DEL</button>
                        ` : ''}
                        <button onclick="readChap('${doc.id}', ${c.price}, \`${c.content.replace(/`/g, "'")}\`)" class="text-gold text-[9px] font-black">
                            ${canRead ? 'READ' : 'UNLOCK ' + c.price + 'C'}
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        async function readChap(id, price, content) {
            const uRef = db.collection('users').doc(curU.uid);
            const uDoc = await uRef.get();
            if(price > 0 && !(uDoc.data().bought || []).includes(id) && curU.email !== 'xztka49@gmail.com') {
                if(uDoc.data().coins < price) return showNoti("Low Credits", "error");
                if(!confirm(`Buy for ${price} Coins?`)) return;
                await uRef.update({ coins: firebase.firestore.FieldValue.increment(-price), bought: firebase.firestore.FieldValue.arrayUnion(id) });
                await db.collection('books').doc(curB).update({ sales: firebase.firestore.FieldValue.increment(price) });
            }
            document.getElementById('readerBody').innerText = content; showSection('readerSection');
        }

        // GLOBAL CHAT (Point 7 - Fixed)
        async function sendChat() {
            const msg = document.getElementById('chatInput').value; if(!msg) return;
            await db.collection('chat').add({ email: curU.email, msg, date: new Date() });
            document.getElementById('chatInput').value = "";
        }

        function loadChat() {
            db.collection('chat').orderBy('date', 'asc').limitToLast(50).onSnapshot(snap => {
                document.getElementById('chatBody').innerHTML = snap.docs.map(doc => `
                    <div class="mb-3">
                        <p class="text-[8px] font-bold gold-text uppercase mb-1">${doc.data().email}</p>
                        <div class="bg-white/5 p-3 rounded-xl text-xs inline-block">${doc.data().msg}</div>
                    </div>`).join('');
                document.getElementById('chatBody').scrollTo(0, 9999);
            });
        }

        // DEPOSIT & ADMIN INCOME (Point 1, 2)
        async function submitPay() {
            const amt = parseInt(document.getElementById('payAmt').value);
            const tid = document.getElementById('payTid').value;
            if(tid.length < 6) return showNoti("Invalid TID", "error");
            await db.collection('coinRequests').add({ 
                uid: curU.uid, email: curU.email, amt, tid, status: 'pending', date: new Date() 
            });
            showNoti("Order Submitted"); showSection('homeSection');
        }

        async function loadAdminStats() {
            // Orders
            db.collection('coinRequests').where('status', '==', 'pending').onSnapshot(snap => {
                document.getElementById('tab-pay').innerHTML = snap.docs.map(doc => `
                    <div class="glass-card p-4">
                        <p class="text-[10px] font-bold gold-text">${doc.data().email}</p>
                        <p class="text-xl font-black">${doc.data().amt} C <span class="text-[9px] opacity-40">TID: ${doc.data().tid}</span></p>
                        <div class="flex gap-2 mt-4">
                            <button onclick="approvePay('${doc.id}', '${doc.data().uid}', ${doc.data().amt})" class="flex-1 py-2 bg-green-600 rounded-lg text-[9px] font-black uppercase">Approve</button>
                            <button onclick="rejectPay('${doc.id}')" class="flex-1 py-2 bg-red-600 rounded-lg text-[9px] font-black uppercase">Reject</button>
                        </div>
                    </div>`).join('');
            });
            // Users List (Point 9)
            const uSnap = await db.collection('users').get();
            document.getElementById('tab-users').innerHTML = uSnap.docs.map(doc => `
                <div class="p-3 glass-card flex justify-between text-[10px] font-bold">
                    <span>${doc.data().email}</span><span class="text-gold">${doc.data().coins} C</span>
                </div>`).join('');
            // V&S Analytics (Point 10)
            let tv = 0, ts = 0;
            document.getElementById('vsList').innerHTML = allB.map(b => {
                tv += (b.views || 0); ts += (b.sales || 0);
                return `<div class="p-3 glass-card flex justify-between text-[10px] font-bold"><span>${b.title}</span><span class="gold-text">${b.views||0} üëÅ / ${b.sales||0} C</span></div>`;
            }).join('');
            document.getElementById('vTotal').innerText = tv; document.getElementById('sTotal').innerText = ts + " C";
            calculateRevenue();
        }

        async function approvePay(id, uid, amt) {
            await db.collection('users').doc(uid).update({ coins: firebase.firestore.FieldValue.increment(amt) });
            await db.collection('coinRequests').doc(id).update({ status: 'approved' });
            showNoti("Approved & Coin Sent");
        }

        async function rejectPay(id) {
            await db.collection('coinRequests').doc(id).update({ status: 'rejected' });
            showNoti("Rejected");
        }

        async function calculateRevenue() {
            const start = document.getElementById('revStart').value ? new Date(document.getElementById('revStart').value) : new Date(0);
            const end = document.getElementById('revEnd').value ? new Date(document.getElementById('revEnd').value) : new Date();
            
            const snap = await db.collection('coinRequests').where('status', '==', 'approved').get();
            let total = 0;
            snap.forEach(doc => { if(doc.data().date.toDate() >= start && doc.data().date.toDate() <= end) total += doc.data().amt; });
            document.getElementById('admIncome').innerText = total + " C";

            const gSnap = await db.collection('giftClaims').get();
            let gTotal = 0;
            gSnap.forEach(doc => { if(doc.data().date.toDate() >= start && doc.data().date.toDate() <= end) gTotal += doc.data().amt; });
            document.getElementById('admGiftPool').innerText = gTotal + " C";
        }

        // GIFT SYSTEM (Point 5)
        async function generateGift() {
            const amt = parseInt(document.getElementById('gAmt').value);
            const code = "Luxe-" + Math.random().toString(36).substring(2,7).toUpperCase();
            await db.collection('giftCodes').add({ code, amt, used: false, date: new Date() });
            loadGifts();
        }

        function loadGifts() {
            db.collection('giftCodes').orderBy('date', 'desc').onSnapshot(snap => {
                document.getElementById('admGiftList').innerHTML = snap.docs.map(doc => `
                    <div class="p-3 glass-card flex justify-between text-[10px] font-bold">
                        <span>${doc.data().code} (${doc.data().amt} C)</span>
                        <span class="${doc.data().used ? 'text-red-500':'text-green-500'}">${doc.data().used ? 'USED':'ALIVE'}</span>
                    </div>`).join('');
            });
        }

        async function redeemGift() {
            const code = document.getElementById('redeemIn').value;
            const snap = await db.collection('giftCodes').where('code', '==', code).where('used', '==', false).get();
            if(snap.empty) return showNoti("Invalid or Used Code", "error");
            const g = snap.docs[0];
            await db.collection('users').doc(curU.uid).update({ coins: firebase.firestore.FieldValue.increment(g.data().amt) });
            await g.ref.update({ used: true });
            await db.collection('giftClaims').add({ uid: curU.uid, amt: g.data().amt, date: new Date() });
            showNoti("Success! Coin Added"); showSection('homeSection');
        }

        // TRANSFER (Point 8)
        async function transferCoins() {
            const email = document.getElementById('tEmail').value;
            const amt = parseInt(document.getElementById('tAmt').value);
            const uRef = db.collection('users').doc(curU.uid);
            const uDoc = await uRef.get();
            if(uDoc.data().coins < amt) return showNoti("Insufficient Balance", "error");
            
            const target = await db.collection('users').where('email', '==', email).get();
            if(target.empty) return showNoti("Recipient not found", "error");
            
            await uRef.update({ coins: firebase.firestore.FieldValue.increment(-amt) });
            await target.docs[0].ref.update({ coins: firebase.firestore.FieldValue.increment(amt) });
            showNoti("Transfer Successful"); showSection('homeSection');
        }

        // NOVEL/CHAP EDIT & DELETE (Point 3, 4)
        function editNovel(id) { curE = id; const b = allB.find(x=>x.id===id); document.getElementById('nTitle').value = b.title; document.getElementById('nCover').value = b.cover; showSection('novelForm'); }
        async function deleteNovel(id) { if(confirm("Del Archive?")) { await db.collection('books').doc(id).delete(); loadBooks(); } }
        async function saveNovel() {
            const d = { title: document.getElementById('nTitle').value, cover: document.getElementById('nCover').value, genre: document.getElementById('nGenre').value };
            if(curE) await db.collection('books').doc(curE).update(d);
            else await db.collection('books').add({...d, views: 0, sales: 0, date: new Date()});
            showSection('homeSection'); loadBooks();
        }

        let curCE = null;
        function editChap(id) { curCE = id; showSection('chapForm'); }
        async function deleteChap(id) { if(confirm("Del Chap?")) { await db.collection('books').doc(curB).collection('chapters').doc(id).delete(); loadChaps(); } }
        async function saveChap() {
            const d = { title: document.getElementById('cTitle').value, content: document.getElementById('cContent').value, price: parseInt(document.getElementById('cPrice').value), date: new Date() };
            if(curCE) await db.collection('books').doc(curB).collection('chapters').doc(curCE).update(d);
            else await db.collection('books').doc(curB).collection('chapters').add(d);
            showSection('chapterView'); loadChaps();
        }

        // UTILS
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('hidden'); }
        function showSection(id) { 
            document.querySelectorAll('main > div').forEach(s => s.classList.add('hidden')); 
            document.getElementById(id).classList.remove('hidden'); 
            window.scrollTo(0,0);
        }
        function setTab(t) {
            document.querySelectorAll('.adm-t').forEach(b => b.classList.remove('bg-gold','text-black'));
            event.target.classList.add('bg-gold','text-black');
            ['tab-nov','tab-pay','tab-users','tab-gift'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            if(t==='gift') loadGifts();
        }
        function showNoti(m, t="success") {
            const b = document.createElement('div');
            b.className = `p-4 glass-card border-l-4 ${t==='success'?'border-gold':'border-red-500'} text-[10px] font-bold`;
            b.innerText = m.toUpperCase(); document.getElementById('notiBox').appendChild(b);
            setTimeout(() => b.remove(), 3000);
        }
        function searchBooks() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allB.filter(b => b.title.toLowerCase().includes(q));
            document.getElementById('bookGrid').innerHTML = filtered.map(b => `
                <div class="glass-card overflow-hidden" onclick="openBook('${b.id}')">
                    <img src="${b.cover}" class="h-44 w-full object-cover">
                    <div class="p-4"><p class="text-[9px] gold-text font-bold uppercase">${b.genre}</p><p class="text-[10px] font-black truncate">${b.title}</p></div>
                </div>`).join('');
        }
        function openNovelForm() { curE = null; document.getElementById('nTitle').value = ""; showSection('novelForm'); }
        function openChapForm() { curCE = null; document.getElementById('cTitle').value = ""; showSection('chapForm'); }
    </script>
</body>
</html>
