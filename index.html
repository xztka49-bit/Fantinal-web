<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FANTINAL - Global Emperor Publishing</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020617; --card: #0f172a; --gold: #d4af37; --text: #f8fafc; --text-dim: #94a3b8;
            --v0: #64748b; --v1: #22c55e; --v2: #cd7f32; --v3: #c0c0c0; --v4: #fbbf24; --v5: #d946ef; --v6: #f43f5e;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 90px; }
        h1, h2, h3, .logo { font-family: 'Cinzel', serif; }

        /* --- ANIMATIONS --- */
        @keyframes glowV6 { 0%, 100% { box-shadow: 0 0 5px #f43f5e; border-color: #f43f5e; } 50% { box-shadow: 0 0 20px #f43f5e; border-color: #fff; } }
        @keyframes glowV5 { 0%, 100% { box-shadow: 0 0 5px #d946ef; } 50% { box-shadow: 0 0 15px #d946ef; } }
        .btn:active { transform: scale(0.95); transition: 0.1s; }
        .view { display: none; padding: 20px; animation: fadeIn 0.4s ease; }
        .active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI ELEMENTS --- */
        .card { background: var(--card); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .btn-gold { background: linear-gradient(45deg, var(--gold), #fef08a); color: #000; font-weight: bold; border: none; padding: 12px; border-radius: 10px; cursor: pointer; width: 100%; box-shadow: 0 4px 15px rgba(212,175,55,0.2); }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; background: #1e293b; border: 1px solid #334155; color: white; border-radius: 10px; }

        /* --- VIP CHAT FRAMES --- */
        .chat-msg { padding: 12px; border-radius: 12px; margin-bottom: 10px; font-size: 0.9rem; position: relative; }
        .frame-v5 { border: 2px solid var(--v5); background: rgba(217, 70, 239, 0.1); animation: glowV5 2s infinite; }
        .frame-v6 { border: 2px solid var(--v6); background: rgba(0,0,0,0.4); animation: glowV6 2s infinite; }
        .name-v4 { color: var(--v4); font-weight: bold; }
        .name-v5 { color: var(--v5); font-weight: bold; text-shadow: 0 0 5px var(--v5); }
        .name-v6 { color: #fff; font-weight: 900; text-shadow: 0 0 10px #f43f5e, 0 0 20px #f43f5e; }

        /* --- DAILY CLAIM --- */
        .claim-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .day-box { background: #020617; border: 1px solid #334155; padding: 10px 5px; border-radius: 8px; text-align: center; font-size: 0.7rem; }
        .day-box.active { border-color: var(--gold); background: rgba(212,175,55,0.1); color: var(--gold); }

        /* --- NAVIGATION --- */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid var(--gold); z-index: 1000; }
        .nav-item { color: var(--text-dim); font-size: 0.7rem; text-align: center; cursor: pointer; }
        .nav-item.active { color: var(--gold); }

        /* --- NOVEL GRID --- */
        .novel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .novel-card { border-radius: 12px; overflow: hidden; position: relative; cursor: pointer; }
        .novel-card img { width: 100%; height: 230px; object-fit: cover; }
    </style>
</head>
<body>

<header style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--gold); background: var(--card);">
    <div class="logo" style="color:var(--gold)">FANTINAL</div>
    <div id="uStat" style="text-align: right; display: none;">
        <div style="color:var(--gold); font-weight: bold;">ü™ô <span id="headCoins">0</span></div>
        <div id="headVip"></div>
    </div>
    <button id="loginBtn" onclick="login()" class="btn-gold" style="width:auto; padding: 5px 15px;">LOGIN</button>
</header>

<div id="home-view" class="view active-view">
    <input type="text" id="search" placeholder="Search stories..." oninput="searchStories()">
    <div class="novel-grid" id="novelGrid"></div>
</div>

<div id="detail-view" class="view">
    <div onclick="showView('home-view')" style="color:var(--gold); cursor:pointer; margin-bottom:15px;">‚Üê BACK</div>
    <div id="novelInfo"></div>
    <div class="card">
        <h4>Reviews & Ratings</h4>
        <div id="reviewList"></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <select id="revRate" style="width:70px;"><option>5</option><option>4</option><option>3</option><option>2</option><option>1</option></select>
            <input type="text" id="revText" placeholder="Write a review...">
            <button onclick="postReview()" class="btn-gold" style="width:80px;">POST</button>
        </div>
    </div>
    <div id="chList" class="card"></div>
</div>

<div id="reader-view" class="view">
    <div onclick="showView('detail-view')" style="color:var(--gold); cursor:pointer;">‚Üê EXIT</div>
    <h2 id="readTitle" style="color:var(--gold); margin-top:20px;"></h2>
    <div id="readContent" style="line-height:2.2; font-size:1.2rem; white-space:pre-wrap;"></div>
    <div style="display:flex; gap:10px; margin-top:30px;">
        <button id="prevBtn" class="btn-gold" style="background:#334155; color:white;">PREV</button>
        <button id="nextBtn" class="btn-gold">NEXT</button>
    </div>
</div>

<div id="shop-view" class="view">
    <div class="card" style="text-align:center; border: 1px solid var(--gold);">
        <h1 style="color:var(--gold); margin:0;">ü™ô <span id="shopCoins">0</span></h1>
    </div>
    <div class="card" style="border-color:var(--v1);">
        <h4 style="margin:0; color:var(--v1);">Gift Code</h4>
        <input type="text" id="giftInput" placeholder="Enter Code">
        <button class="btn-gold" style="background:var(--v1); color:white;" onclick="redeemGift()">CLAIM</button>
    </div>
    <div id="pkgGrid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
    <div id="topupForm" class="card" style="display:none; border-color:var(--gold); margin-top:20px;">
        <h4 style="color:var(--gold)">Payment: 09759731746 (THU KHA AUNG)</h4>
        <input type="text" id="tName" placeholder="Sender Name">
        <input type="text" id="tID" placeholder="Transaction Last 6 Digits">
        <button class="btn-gold" onclick="submitTopup()">SUBMIT TOPUP</button>
    </div>
</div>

<div id="chat-view" class="view">
    <h3>Global Chat</h3>
    <div id="chatBox" class="card" style="height:400px; overflow-y:auto; display:flex; flex-direction:column-reverse;"></div>
    <div style="display:flex; gap:10px; margin-top:10px;">
        <input type="text" id="chatMsg" placeholder="Say something...">
        <button onclick="sendChat()" class="btn-gold" style="width:80px;">SEND</button>
    </div>
</div>

<div id="profile-view" class="view">
    <div class="card" style="text-align:center;">
        <h2 id="pName">User</h2>
        <div id="pVip"></div>
        <button onclick="toggleEditName()" style="background:none; border:none; color:var(--gold); cursor:pointer;">[ Edit Name ]</button>
        <div id="editNameDiv" style="display:none; margin-top:10px;">
            <input type="text" id="newName" placeholder="New Username">
            <button class="btn-gold" onclick="updateName()">Update</button>
        </div>
    </div>

    <div id="claimDiv" class="card" style="display:none;">
        <h4 style="margin:0; color:var(--gold);">Daily Rewards</h4>
        <div class="claim-grid" id="claimGrid"></div>
        <button id="claimBtn" class="btn-gold" style="margin-top:10px;" onclick="claimDaily()">CLAIM</button>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <button class="btn-gold" style="background:#1e293b; color:white;" onclick="showView('history-view')">History</button>
        <button class="btn-gold" style="background:#1e293b; color:white;" onclick="showView('transfer-view')">Transfer</button>
    </div>

    <div id="adminBtn" style="display:none; margin-top:20px;">
        <button class="btn-gold" onclick="showView('admin-view')">ADMIN PANEL</button>
    </div>
</div>

<div id="transfer-view" class="view">
    <div onclick="showView('profile-view')" style="color:var(--gold); cursor:pointer;">‚Üê BACK</div>
    <div class="card">
        <h3>Transfer Coins</h3>
        <input type="text" id="tfEmail" placeholder="Recipient Email">
        <input type="number" id="tfAmt" placeholder="Amount">
        <button class="btn-gold" onclick="transferCoins()">TRANSFER NOW</button>
    </div>
</div>

<div id="history-view" class="view">
    <div onclick="showView('profile-view')" style="color:var(--gold); cursor:pointer;">‚Üê BACK</div>
    <h3>Coin History</h3>
    <div class="card" style="overflow-x:auto;"><table id="hTable" style="width:100%; font-size:0.8rem;"><thead><tr style="text-align:left;"><th>Date</th><th>Type</th><th>Amt</th><th>Status</th></tr></thead><tbody id="hBody"></tbody></table></div>
</div>

<div id="admin-view" class="view">
    <div onclick="showView('profile-view')" style="color:var(--gold); cursor:pointer; margin-bottom:20px;">‚Üê CLOSE</div>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
        <button class="btn-gold" onclick="openAdmTab('a-approvals')">Approvals</button>
        <button class="btn-gold" onclick="openAdmTab('a-vs')">V & S</button>
        <button class="btn-gold" onclick="openAdmTab('a-novels')">Novels</button>
        <button class="btn-gold" onclick="openAdmTab('a-gifts')">Gifts</button>
    </div>

    <div id="a-approvals" class="adm-tab card">
        <h4>Topup Requests</h4>
        <div id="pendingReqs"></div>
    </div>

    <div id="a-vs" class="adm-tab card" style="display:none;">
        <h4>Views & Sales Analytics</h4>
        <div id="vsList"></div>
    </div>

    <div id="a-novels" class="adm-tab card" style="display:none;">
        <h4>Manage Novels & Chapters</h4>
        <input type="text" id="anID" placeholder="Novel ID (for Edit)">
        <input type="text" id="anTit" placeholder="Title">
        <input type="text" id="anAut" placeholder="Author">
        <input type="text" id="anCov" placeholder="Cover URL">
        <textarea id="anDes" placeholder="Description"></textarea>
        <input type="number" id="anVip" placeholder="Lifetime VIP Price">
        <button class="btn-gold" onclick="saveNovel()">SAVE NOVEL</button>
        <hr>
        <select id="anSel"></select>
        <input type="text" id="acID" placeholder="Chapter ID (for Edit)">
        <input type="number" id="acNum" placeholder="Ch Number">
        <input type="text" id="acTit" placeholder="Ch Title">
        <textarea id="acCon" rows="5" placeholder="Content"></textarea>
        <input type="number" id="acCost" placeholder="Cost">
        <button class="btn-gold" onclick="saveChapter()">SAVE CHAPTER</button>
    </div>

    <div id="a-gifts" class="adm-tab card" style="display:none;">
        <h4>Gift Code System</h4>
        <input type="number" id="agAmt" placeholder="Amount">
        <button class="btn-gold" onclick="genGift()">GENERATE</button>
        <div id="giftLog" style="margin-top:15px; font-size:0.7rem;"></div>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="showView('home-view')">üè†<br>Home</div>
    <div class="nav-item" onclick="showView('shop-view')">üí∞<br>Shop</div>
    <div class="nav-item" onclick="showView('chat-view')">üí¨<br>Chat</div>
    <div class="nav-item" onclick="showView('profile-view')">üë§<br>Account</div>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, query, getDocs, getDoc, updateDoc, increment, setDoc, addDoc, where, orderBy, limit, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const config = { apiKey: "AIzaSyBxh92A7E6Egtk4kYB23Wmlelq13YYh1J0", authDomain: "fantinal-publishing-5b960.firebaseapp.com", projectId: "fantinal-publishing-5b960", storageBucket: "fantinal-publishing-5b960.firebasestorage.app", messagingSenderId: "961612304854", appId: "1:961612304854:web:6bf7b03072ed83b58b9477" };
    const app = initializeApp(config);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const prov = new GoogleAuthProvider();

    const ADMIN = "xztka49@gmail.com";
    let curU = null, uData = null;

    // --- VIP & REWARDS DATA ---
    function getVip(spent) {
        if(spent >= 3000000) return {lv:6, t:"Emperor", c:"v6", nc:"name-v6", fc:"frame-v6"};
        if(spent >= 1000000) return {lv:5, t:"King", c:"v5", nc:"name-v5", fc:"frame-v5"};
        if(spent >= 400000) return {lv:4, t:"Master", c:"v4", nc:"name-v4", fc:""};
        if(spent >= 120000) return {lv:3, t:"Silver", c:"v3", nc:"", fc:""};
        if(spent >= 50000) return {lv:2, t:"Bronze", c:"v2", nc:"", fc:""};
        if(spent >= 10000) return {lv:1, t:"Warrior", c:"v1", nc:"", fc:""};
        return {lv:0, t:"Newbie", c:"v0", nc:"", fc:""};
    }

    const claimTable = {
        2: [25, 50, 75, 100, 125, 150, 175],
        3: [50, 100, 150, 200, 250, 300, 350],
        4: [75, 150, 325, 400, 475, 550, 625],
        5: [100, 200, 300, 400, 500, 600, 700],
        6: [200, 400, 600, 800, 1000, 1200, 1400]
    };

    // --- AUTH ---
    window.login = () => signInWithPopup(auth, prov);

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            curU = user;
            onSnapshot(doc(db, "users", user.uid), (s) => {
                if(s.exists()){
                    uData = s.data();
                    syncUI();
                } else {
                    setDoc(doc(db, "users", user.uid), { name: user.displayName, email: user.email, coins: 0, spent: 0, lastClaim: 0, claimCount: 0 });
                }
            });
            if(user.email === ADMIN) document.getElementById('adminBtn').style.display = 'block';
            loadHistory();
        }
    });

    function syncUI() {
        const v = getVip(uData.spent);
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('uStat').style.display = 'block';
        document.getElementById('headCoins').innerText = uData.coins;
        document.getElementById('shopCoins').innerText = uData.coins;
        document.getElementById('headVip').innerHTML = `<span class="vip-tag ${v.c}">${v.t}</span>`;
        document.getElementById('pName').innerText = uData.name;
        document.getElementById('pVip').innerHTML = `<span class="vip-tag ${v.c}">${v.t}</span>`;
        
        if(v.lv >= 2) {
            document.getElementById('claimDiv').style.display = 'block';
            const grid = document.getElementById('claimGrid'); grid.innerHTML = "";
            const day = uData.claimCount % 7;
            claimTable[v.lv].forEach((amt, i) => {
                grid.innerHTML += `<div class="day-box ${i===day?'active':''}">D${i+1}<br>ü™ô${amt}</div>`;
            });
            const can = (Date.now() - (uData.lastClaim || 0)) > 86400000;
            document.getElementById('claimBtn').disabled = !can;
            document.getElementById('claimBtn').innerText = can ? "CLAIM" : "LOCKED";
        }
    }

    // --- PROFILE ---
    window.toggleEditName = () => { const d = document.getElementById('editNameDiv'); d.style.display = d.style.display==='none'?'block':'none'; };
    window.updateName = async () => {
        const n = document.getElementById('newName').value;
        if(n) { await updateDoc(doc(db, "users", curU.uid), { name: n }); toggleEditName(); }
    };

    window.claimDaily = async () => {
        const v = getVip(uData.spent);
        const amt = claimTable[v.lv][uData.claimCount % 7];
        await updateDoc(doc(db, "users", curU.uid), { coins: increment(amt), lastClaim: Date.now(), claimCount: increment(1) });
        alert("Claimed ü™ô" + amt);
    };

    // --- CHAT ---
    window.sendChat = async () => {
        const m = document.getElementById('chatMsg').value; if(!m) return;
        const v = getVip(uData.spent);
        await addDoc(collection(db, "chat"), { name: uData.name, text: m, nCls: v.nc, fCls: v.fc, date: serverTimestamp() });
        document.getElementById('chatMsg').value = "";
    };
    onSnapshot(query(collection(db, "chat"), orderBy("date", "desc"), limit(30)), (s) => {
        const b = document.getElementById('chatBox'); b.innerHTML = "";
        s.forEach(d => {
            const c = d.data();
            b.innerHTML += `<div class="chat-msg ${c.fCls}"><span class="${c.nCls}">${c.name || 'Null'}</span>: ${c.text}</div>`;
        });
    });

    // --- SHOP & TRANSFER ---
    const pkgs = [1000, 2000, 5000, 10000, 30000, 50000];
    pkgs.forEach(p => document.getElementById('pkgGrid').innerHTML += `<div class="card" onclick="openTopup(${p})" style="text-align:center; cursor:pointer;">ü™ô ${p}</div>`);
    
    let selPkg = 0;
    window.openTopup = (p) => { selPkg = p; document.getElementById('topupForm').style.display='block'; };
    window.submitTopup = async () => {
        const id = document.getElementById('tID').value;
        if(id.length < 6) return alert("Invalid ID");
        await addDoc(collection(db, "transactions"), { uid: curU.uid, userName: uData.name, amount: selPkg, tid: id, sender: document.getElementById('tName').value, status: "Pending", type: "Topup", date: serverTimestamp() });
        alert("Wait for Admin Approval..."); document.getElementById('topupForm').style.display='none';
    };

    window.transferCoins = async () => {
        const email = document.getElementById('tfEmail').value;
        const amt = Number(document.getElementById('tfAmt').value);
        if(uData.coins < amt) return alert("No coins!");
        const q = query(collection(db, "users"), where("email", "==", email), limit(1));
        const s = await getDocs(q);
        if(s.empty) return alert("User not found!");
        await updateDoc(doc(db, "users", curU.uid), { coins: increment(-amt) });
        await updateDoc(doc(db, "users", s.docs[0].id), { coins: increment(amt) });
        await addDoc(collection(db, "transactions"), { uid: curU.uid, type: "Transfer", amount: amt, status: "Approved", date: serverTimestamp() });
        alert("Sent!");
    };

    // --- NOVELS & CHAPTERS ---
    onSnapshot(collection(db, "novels"), (s) => {
        const g = document.getElementById('novelGrid'); g.innerHTML = "";
        const sel = document.getElementById('anSel'); sel.innerHTML = "";
        const vs = document.getElementById('vsList'); vs.innerHTML = "";
        s.forEach(d => {
            const n = d.data();
            g.innerHTML += `<div class="novel-card" onclick="openNovel('${d.id}')"><img src="${n.cover}"><p>${n.title}</p></div>`;
            sel.innerHTML += `<option value="${d.id}">${n.title}</option>`;
            vs.innerHTML += `<div><b>${n.title}</b>: Views ${n.views || 0} | Lifetime Sales ${n.sales || 0}</div>`;
        });
    });

    window.openNovel = async (id) => {
        const n = (await getDoc(doc(db, "novels", id))).data();
        await updateDoc(doc(db, "novels", id), { views: increment(1) });
        showView('detail-view'); curNid = id;
        document.getElementById('novelInfo').innerHTML = `
            <img src="${n.cover}" style="width:100%; height:250px; object-fit:cover; border-radius:15px;">
            <h2>${n.title}</h2><p>By ${n.author}</p><p>${n.desc}</p>
            <button class="btn-gold" onclick="buyLife('${id}',${n.vipPrice})">Lifetime VIP (ü™ô${n.vipPrice})</button>
        `;
        loadChs(id); loadRevs(id);
    };

    async function loadChs(nid) {
        const s = await getDocs(query(collection(db, "novels", nid, "chapters"), orderBy("num", "asc")));
        const l = document.getElementById('chList'); l.innerHTML = "<h4>Chapters</h4>";
        s.forEach(d => {
            const c = d.data();
            l.innerHTML += `<div onclick="readCh('${nid}','${d.id}',${c.cost},${c.num})" class="card" style="padding:10px; cursor:pointer;">Ch ${c.num}: ${c.title} <span style="float:right;">ü™ô${c.cost}</span></div>`;
        });
    }

    window.readCh = async (nid, cid, cost, num) => {
        const isLife = (await getDoc(doc(db, "users", curU.uid, "unlocked_novels", nid))).exists();
        const isCh = (await getDoc(doc(db, "users", curU.uid, "unlocked_chapters", cid))).exists();
        if(isLife || isCh || cost === 0) {
            const c = (await getDoc(doc(db, "novels", nid, "chapters", cid))).data();
            showView('reader-view');
            document.getElementById('readTitle').innerText = "Chapter " + num + ": " + c.title;
            document.getElementById('readContent').innerText = c.content;
            window.scrollTo(0,0);
            updateNav(nid, num);
        } else {
            if(uData.coins < cost) return alert("Need coins!");
            if(confirm("Unlock Chapter for ü™ô" + cost + "?")) {
                await updateDoc(doc(db, "users", curU.uid), { coins: increment(-cost), spent: increment(cost) });
                await setDoc(doc(db, "users", curU.uid, "unlocked_chapters", cid), { date: serverTimestamp() });
                readCh(nid, cid, cost, num);
            }
        }
    };

    window.buyLife = async (nid, price) => {
        if(uData.coins < price) return alert("Need coins!");
        await updateDoc(doc(db, "users", curU.uid), { coins: increment(-price), spent: increment(price) });
        await setDoc(doc(db, "users", curU.uid, "unlocked_novels", nid), { date: serverTimestamp() });
        await updateDoc(doc(db, "novels", nid), { sales: increment(1) });
        alert("Novel Unlocked!");
    };

    // --- REVIEWS ---
    async function loadRevs(nid) {
        const s = await getDocs(collection(db, "novels", nid, "reviews"));
        const l = document.getElementById('reviewList'); l.innerHTML = "";
        s.forEach(d => {
            const r = d.data();
            l.innerHTML += `<div style="font-size:0.8rem; margin-bottom:5px;"><b>${r.name}:</b> ${r.text} (${r.rate}‚≠ê) 
                ${curU.email===ADMIN ? `<button onclick="delRev('${nid}','${d.id}')">Del</button>` : ''}</div>`;
        });
    }
    window.postReview = async () => {
        const t = document.getElementById('revText').value;
        const r = document.getElementById('revRate').value;
        await addDoc(collection(db, "novels", curNid, "reviews"), { name: uData.name, text: t, rate: r, date: serverTimestamp() });
        loadRevs(curNid);
    };
    window.delRev = async (nid, rid) => { await deleteDoc(doc(db, "novels", nid, "reviews", rid)); loadRevs(nid); };

    // --- ADMIN PANEL ---
    window.openAdmTab = (id) => { document.querySelectorAll('.adm-tab').forEach(t => t.style.display='none'); document.getElementById(id).style.display='block'; if(id==='a-approvals') loadAdmReqs(); if(id==='a-gifts') loadAdmGifts(); };
    
    window.saveNovel = async () => {
        const id = document.getElementById('anID').value;
        const d = { title: document.getElementById('anTit').value, author: document.getElementById('anAut').value, cover: document.getElementById('anCov').value, desc: document.getElementById('anDes').value, vipPrice: Number(document.getElementById('anVip').value) };
        id ? await updateDoc(doc(db, "novels", id), d) : await addDoc(collection(db, "novels"), { ...d, views: 0, sales: 0 });
        alert("Novel Saved");
    };

    window.saveChapter = async () => {
        const nid = document.getElementById('anSel').value;
        const cid = document.getElementById('acID').value;
        const d = { num: Number(document.getElementById('acNum').value), title: document.getElementById('acTit').value, content: document.getElementById('acCon').value, cost: Number(document.getElementById('acCost').value) };
        cid ? await updateDoc(doc(db, "novels", nid, "chapters", cid), d) : await addDoc(collection(db, "novels", nid, "chapters"), d);
        alert("Chapter Saved");
    };

    async function loadAdmReqs() {
        onSnapshot(query(collection(db, "transactions"), where("status", "==", "Pending")), (s) => {
            const l = document.getElementById('pendingReqs'); l.innerHTML = "";
            s.forEach(d => {
                const r = d.data();
                l.innerHTML += `<div class="card">${r.userName} - ü™ô${r.amount}<br>${r.tid} | ${r.sender}<br>
                    <button onclick="approve('${d.id}','${r.uid}',${r.amount})">Approve</button> <button onclick="reject('${d.id}')">Reject</button></div>`;
            });
        });
    }

    window.approve = async (id, uid, amt) => {
        await updateDoc(doc(db, "transactions", id), { status: "Approved" });
        await updateDoc(doc(db, "users", uid), { coins: increment(amt) });
        alert("Approved");
    };

    window.genGift = async () => {
        const a = Number(document.getElementById('agAmt').value);
        const c = "FANT-" + Math.random().toString(36).substr(2,8).toUpperCase();
        await addDoc(collection(db, "gifts"), { code: c, amount: a, used: false, date: serverTimestamp() });
        loadAdmGifts();
    };

    async function loadAdmGifts() {
        const s = await getDocs(query(collection(db, "gifts"), orderBy("date", "desc")));
        const l = document.getElementById('giftLog'); l.innerHTML = "";
        s.forEach(d => { const g = d.data(); l.innerHTML += `<div>${g.code} - ü™ô${g.amount} (${g.used?'Used':'Active'})</div>`; });
    }

    // --- UTILS ---
    window.showView = (id) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
        document.getElementById(id).classList.add('active-view');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    };

    async function loadHistory() {
        onSnapshot(query(collection(db, "transactions"), where("uid", "==", curU.uid), orderBy("date", "desc")), (s) => {
            const b = document.getElementById('hBody'); b.innerHTML = "";
            s.forEach(d => {
                const h = d.data();
                const dt = h.date ? h.date.toDate().toLocaleDateString() : 'Pending';
                b.innerHTML += `<tr><td>${dt}</td><td>${h.type}</td><td>${h.amount}</td><td style="color:${h.status==='Approved'?'#22c55e':'#fbbf24'}">${h.status}</td></tr>`;
            });
        });
    }

    window.redeemGift = async () => {
        const c = document.getElementById('giftInput').value;
        const q = query(collection(db, "gifts"), where("code", "==", c), where("used", "==", false), limit(1));
        const s = await getDocs(q);
        if(s.empty) return alert("Invalid Code");
        await updateDoc(doc(db, "users", curU.uid), { coins: increment(s.docs[0].data().amount) });
        await updateDoc(doc(db, "gifts", s.docs[0].id), { used: true });
        alert("Redeemed!");
    };
</script>
</body>
</html>
