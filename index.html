<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantinal - Master Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #2563eb; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; }
        .card { background: var(--card); border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; }
        .sidebar { position: fixed; left: -100%; top: 0; width: 85%; height: 100%; background: #111827; z-index: 100; transition: 0.4s; padding: 25px; border-right: 1px solid #1f2937; }
        .sidebar.active { left: 0; box-shadow: 20px 0 50px rgba(0,0,0,0.8); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; z-index: 90; backdrop-filter: blur(8px); }
        .overlay.active { display: block; }
        .genre-btn { padding: 10px 20px; border-radius: 12px; font-size: 12px; background: #334155; color: white; white-space: nowrap; transition: 0.3s; font-weight: 600; }
        .genre-btn.active { background: var(--accent); }
        input, select, textarea { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 14px; background: #0f172a; color: white; border: 1px solid #334155; outline: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .admin-tab-btn { flex: 1; padding: 10px 5px; font-size: 9px; background: #334155; border-radius: 10px; font-weight: 700; color: #94a3b8; }
        .admin-tab-btn.active { background: var(--accent); color: white; }
    </style>
</head>
<body>
    <div id="overlay" class="overlay" onclick="toggleMenu()"></div>
    
    <div id="sidebar" class="sidebar overflow-y-auto no-scrollbar">
        <h2 class="text-2xl font-black text-blue-500 mb-8 tracking-tighter">PROFILE</h2>
        <div class="mb-8 p-6 bg-slate-800 rounded-3xl border border-blue-500/20">
            <p id="userEmail" class="font-bold text-sm mb-4 text-blue-300 truncate">-</p>
            <div class="grid grid-cols-2 gap-4 border-t border-slate-700 pt-4">
                <div><p class="text-[10px] text-gray-500 uppercase">Balance</p><p id="userBalance" class="text-xl font-black text-yellow-500">0 C</p></div>
                <div><p class="text-[10px] text-gray-500 text-right uppercase">Spent</p><p id="userSpent" class="text-xl font-black text-red-400 text-right">0 C</p></div>
            </div>
            <button onclick="showSection('buyCoinSection')" class="w-full mt-5 bg-blue-600 py-3 rounded-xl font-bold text-xs">COIN TOPUP</button>
            <button onclick="showSection('giftRedeemSection')" class="w-full mt-2 bg-purple-600 py-3 rounded-xl font-bold text-xs">REDEEM GIFT CODE</button>
        </div>
        <div id="userHistory" class="space-y-2 mb-10 text-[10px]"></div>
        <button onclick="auth.signOut()" class="w-full bg-red-600/20 text-red-500 py-3 rounded-xl text-xs font-black">LOGOUT</button>
    </div>

    <nav class="bg-slate-950/80 backdrop-blur-md p-4 sticky top-0 z-50 flex justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-4">
            <button onclick="toggleMenu()" class="text-2xl">☰</button>
            <h1 class="text-xl font-black text-white" onclick="location.reload()">FANTINAL</h1>
        </div>
        <div id="adminIndicator" class="hidden bg-red-600 px-3 py-1 rounded-full text-[9px] font-black animate-pulse">ADMIN</div>
    </nav>

    <main class="max-w-md mx-auto p-5 pb-20">
        
        <div id="authSection" class="hidden mt-10">
            <div class="flex bg-slate-800 p-1 rounded-2xl mb-8">
                <button onclick="switchAuthTab('login')" id="loginTabBtn" class="flex-1 py-3 rounded-xl font-bold text-sm bg-blue-600">Login</button>
                <button onclick="switchAuthTab('register')" id="registerTabBtn" class="flex-1 py-3 rounded-xl font-bold text-sm">Register</button>
            </div>
            <div id="loginForm" class="card p-8">
                <h3 class="text-xl font-black mb-6">Welcome Back</h3>
                <input type="email" id="logEmail" placeholder="Email"><input type="password" id="logPass" placeholder="Password">
                <button onclick="login()" class="w-full bg-blue-600 py-4 rounded-xl font-black">LOGIN</button>
            </div>
            <div id="registerForm" class="card p-8 hidden">
                <h3 class="text-xl font-black mb-6">Create Account</h3>
                <input type="email" id="regEmail" placeholder="Email"><input type="password" id="regPass" placeholder="Password">
                <button onclick="register()" class="w-full bg-blue-600 py-4 rounded-xl font-black">REGISTER</button>
            </div>
        </div>

        <div id="bookStore" class="hidden">
            <div id="adSlider" class="flex overflow-x-auto gap-3 mb-6 no-scrollbar rounded-2xl h-44"></div>
            <div class="flex gap-2 overflow-x-auto mb-6 pb-2 no-scrollbar">
                <button onclick="loadBooks('All')" class="genre-btn active">All</button>
                <button onclick="loadBooks('Fan Fiction')" class="genre-btn">Fan Fiction</button>
                <button onclick="loadBooks('Life')" class="genre-btn">Life</button>
                <button onclick="loadBooks('True')" class="genre-btn">True</button>
                <button onclick="loadBooks('Mega')" class="genre-btn">Mega</button>
            </div>
            <div id="bookList" class="grid grid-cols-2 gap-4"></div>
            <div id="adminEntry" class="hidden mt-12"><button onclick="showSection('adminDashboard')" class="w-full bg-indigo-600 py-4 rounded-2xl text-xs font-black">ADMIN PANEL</button></div>
        </div>

        <div id="giftRedeemSection" class="hidden">
            <button onclick="showSection('bookStore')" class="text-blue-400 mb-6 text-xs font-bold">← BACK</button>
            <div class="card p-8 text-center">
                <h2 class="text-2xl font-black mb-2 text-purple-400">Gift Redeem</h2>
                <p class="text-xs text-gray-400 mb-8">Enter your 10-digit code below</p>
                <input type="text" id="giftInput" placeholder="GiftXXXXXXXX" class="text-center font-black tracking-widest uppercase">
                <button onclick="redeemGift()" class="w-full bg-purple-600 py-4 rounded-xl font-black shadow-xl">CLAIM COINS</button>
            </div>
        </div>

        <div id="adminDashboard" class="hidden">
            <button onclick="showSection('bookStore')" class="text-blue-400 mb-6 text-xs font-bold">← EXIT</button>
            <div class="flex gap-1 mb-6 bg-slate-900 p-1.5 rounded-xl border border-white/5">
                <button onclick="switchAdminTab('stats')" class="admin-tab-btn active">STATS</button>
                <button onclick="switchAdminTab('requests')" class="admin-tab-btn">REQUESTS</button>
                <button onclick="switchAdminTab('gift')" class="admin-tab-btn">GIFT CODE</button>
                <button onclick="switchAdminTab('finance')" class="admin-tab-btn">FINANCE</button>
                <button onclick="switchAdminTab('upload')" class="admin-tab-btn">UPLOAD</button>
            </div>

            <div id="tab-stats">
                <div class="flex gap-2 mb-4 bg-slate-800 p-1 rounded-lg">
                    <button onclick="loadCharts('view')" id="chart-view" class="flex-1 py-2 text-[9px] font-bold rounded bg-blue-600">VIEWS</button>
                    <button onclick="loadCharts('sale')" id="chart-sale" class="flex-1 py-2 text-[9px] font-bold rounded">SALES</button>
                    <button onclick="loadCharts('user')" id="chart-user" class="flex-1 py-2 text-[9px] font-bold rounded">USERS</button>
                </div>
                <div id="chartContainer" class="card p-5 text-xs space-y-3"></div>
            </div>

            <div id="tab-gift" class="hidden">
                <div class="flex gap-2 mb-4">
                    <button onclick="switchGiftSubTab('gen')" id="gBtn-gen" class="flex-1 py-2 text-[9px] font-bold rounded bg-blue-600">GENERATE</button>
                    <button onclick="switchGiftSubTab('report')" id="gBtn-report" class="flex-1 py-2 text-[9px] font-bold rounded bg-slate-800">REPORTS</button>
                </div>

                <div id="gift-gen-area" class="card p-6">
                    <h4 class="text-xs font-black mb-4">COIN GENERATOR</h4>
                    <input type="number" id="giftAmount" placeholder="Enter Coin Amount (e.g. 100000)">
                    <button onclick="generateGiftCode()" class="w-full bg-purple-600 py-4 rounded-xl font-black mb-4">GENERATE GIFT CODE</button>
                    <div id="generatedCodeBox" class="hidden p-4 bg-slate-950 border-2 border-dashed border-purple-500 rounded-xl text-center">
                        <p class="text-[10px] text-gray-500 mb-1">Copy your code:</p>
                        <p id="newCodeTxt" class="text-xl font-black text-white tracking-widest"></p>
                    </div>
                </div>

                <div id="gift-report-area" class="hidden">
                    <div class="grid grid-cols-4 gap-1 mb-4">
                        <button onclick="loadGiftReports('All')" class="g-filter-btn py-2 text-[8px] bg-blue-600 rounded">All</button>
                        <button onclick="loadGiftReports('Gift1')" class="g-filter-btn py-2 text-[8px] bg-slate-800 rounded">Gift1</button>
                        <button onclick="loadGiftReports('Gift0')" class="g-filter-btn py-2 text-[8px] bg-slate-800 rounded">Gift0</button>
                        <button onclick="loadGiftReports('Gift00')" class="g-filter-btn py-2 text-[8px] bg-slate-800 rounded">Gift00</button>
                    </div>
                    <div class="bg-purple-600/10 p-4 rounded-xl mb-4 text-center border border-purple-600/20">
                        <p class="text-[10px] text-purple-400 font-bold uppercase">Total Gifted Coins</p>
                        <h2 id="totalGiftDisplay" class="text-2xl font-black text-purple-400">0 C</h2>
                    </div>
                    <div id="giftLog" class="card p-4 text-[10px] space-y-2 max-h-64 overflow-y-auto"></div>
                </div>
            </div>

            <div id="tab-finance" class="hidden">
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <input type="date" id="finStart" class="text-xs"><input type="date" id="finEnd" class="text-xs">
                </div>
                <button onclick="calculateFinanceRange()" class="w-full bg-blue-600 py-3 rounded-xl text-xs font-black mb-4">FILTER RANGE</button>
                <div class="bg-green-600/10 p-6 rounded-2xl text-center border border-green-600/20 mb-4">
                    <p class="text-[10px] text-green-500 font-bold uppercase">Total Income</p>
                    <h2 id="totalRevDisplay" class="text-3xl font-black text-green-400">0 MMK</h2>
                </div>
                <div id="financeLog" class="card p-4 text-[10px] space-y-2"></div>
            </div>

            <div id="tab-requests" class="hidden"><div id="requestList" class="space-y-4"></div></div>
            <div id="tab-upload" class="hidden">
                <div class="card p-6 mb-4"><input type="text" id="bTitle" placeholder="Novel Name"><input type="text" id="bCover" placeholder="Cover URL"><select id="bGenre"><option value="Fan Fiction">Fan Fiction</option><option value="Life">Life</option><option value="True">True</option><option value="Mega">Mega</option></select><button onclick="uploadBook()" class="w-full bg-blue-600 py-3 rounded-xl font-bold">PUBLISH</button></div>
                <div class="card p-6"><input type="text" id="ad1" placeholder="Ad 1"><input type="text" id="ad2" placeholder="Ad 2"><input type="text" id="ad3" placeholder="Ad 3"><input type="text" id="ad4" placeholder="Ad 4"><button onclick="saveAds()" class="bg-green-600 w-full py-3 rounded-xl font-bold">SAVE ADS</button></div>
            </div>
        </div>

        <div id="chapterView" class="hidden">
            <button onclick="showSection('bookStore')" class="text-blue-400 mb-6 text-xs font-bold">← BACK</button>
            <div class="card p-5 mb-6 border-t-4 border-yellow-500 flex justify-between items-center">
                <div><p class="text-[10px] text-gray-500">VIP ACCESS</p><h3 id="vipPriceTag" class="text-2xl font-black text-yellow-500">0 C</h3></div>
                <button id="buyVipBtn" onclick="handleVipPurchase()" class="bg-yellow-600 px-6 py-2 rounded-xl text-xs font-black">GET VIP</button>
            </div>
            <div id="adminChapterBtn" class="hidden mb-6"><button onclick="prepareAddChapter()" class="bg-blue-600 py-3 rounded-xl text-xs font-bold w-full">+ NEW CHAPTER</button></div>
            <div id="chapterList" class="space-y-3"></div>
        </div>

        <div id="addChapterForm" class="hidden">
            <input type="text" id="cTitle" placeholder="Title"><textarea id="cContent" rows="15" placeholder="Content..."></textarea><input type="number" id="cPrice" placeholder="Price"><button onclick="uploadChapter()" class="w-full bg-blue-600 py-4 rounded-xl font-black mb-3">SAVE</button><button onclick="showSection('chapterView')" class="w-full text-gray-500 font-bold">CANCEL</button>
        </div>

        <div id="readerSystem" class="hidden fixed inset-0 bg-slate-950 text-slate-200 z-[200] p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-10">
                <button onclick="showSection('chapterView')" class="text-blue-400 font-bold">← BACK</button>
                <div id="readerTitle" class="text-xs font-bold truncate max-w-[150px]">Title</div>
            </div>
            <div id="readerContent" class="whitespace-pre-wrap leading-relaxed text-lg pb-32 font-serif"></div>
            <div class="fixed bottom-0 left-0 right-0 p-4 bg-slate-900 border-t border-white/5 flex gap-4">
                <button id="prevBtn" class="flex-1 bg-slate-800 py-3 rounded-xl text-xs font-bold opacity-50">PREVIOUS</button>
                <button id="nextBtn" class="flex-1 bg-blue-600 py-3 rounded-xl text-xs font-bold opacity-50">NEXT</button>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBxh92A7E6Egtk4kYB23Wmlelq13YYh1J0",
            authDomain: "fantinal-publishing-5b960.firebaseapp.com",
            projectId: "fantinal-publishing-5b960",
            storageBucket: "fantinal-publishing-5b960.firebasestorage.app",
            messagingSenderId: "961612304854",
            appId: "1:961612304854:web:6bf7b03072ed83b58b9477"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore();
        let currentBookId = ""; let currentBookTitle = ""; let editChapterId = null;
        let allChapters = []; let currentIdx = 0;

        // UI Helpers
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); if(document.getElementById('sidebar').classList.contains('active')) loadUserStats(); }
        function showSection(id) { document.querySelectorAll('main > div').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); if(id === 'bookStore') { document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); } window.scrollTo(0,0); }
        function switchAuthTab(tab) { ['loginForm', 'registerForm'].forEach(f => document.getElementById(f).classList.add('hidden')); document.getElementById(tab+'Form').classList.remove('hidden'); ['loginTabBtn', 'registerTabBtn'].forEach(b => document.getElementById(b).classList.remove('bg-blue-600')); document.getElementById(tab+'TabBtn').classList.add('bg-blue-600'); }
        function switchAdminTab(tab) { document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); ['stats', 'requests', 'gift', 'finance', 'upload'].forEach(t => document.getElementById('tab-'+t).classList.add('hidden')); document.getElementById('tab-'+tab).classList.remove('hidden'); if(tab==='finance') listenFinance(); if(tab==='gift') listenGift(); if(tab==='stats') loadCharts('view'); }
        function switchGiftSubTab(sub) { ['gift-gen-area', 'gift-report-area'].forEach(a => document.getElementById(a).classList.add('hidden')); document.getElementById('gift-'+sub+'-area').classList.remove('hidden'); ['gBtn-gen', 'gBtn-report'].forEach(b => document.getElementById(b).classList.replace('bg-blue-600','bg-slate-800')); document.getElementById('gBtn-'+sub).classList.replace('bg-slate-800','bg-blue-600'); }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('userEmail').innerText = user.email;
                if (user.email === 'xztka49@gmail.com') { 
                    document.getElementById('adminEntry').classList.remove('hidden'); document.getElementById('adminIndicator').classList.remove('hidden');
                    document.getElementById('adminChapterBtn').classList.remove('hidden'); 
                }
                db.collection('users').doc(user.uid).onSnapshot(doc => { if(doc.exists) { document.getElementById('userBalance').innerText = (doc.data().coins || 0) + " C"; document.getElementById('userSpent').innerText = (doc.data().spent || 0) + " C"; } });
                showSection('bookStore'); loadBooks('All'); loadAds();
            } else { showSection('authSection'); }
        });

        // --- Gift Code Logic ---
        async function generateGiftCode() {
            const amt = parseInt(document.getElementById('giftAmount').value);
            if(!amt) return alert("Amount Required");
            let prefix = "Gift000";
            if(amt >= 100000) prefix = "Gift1";
            else if(amt >= 10000) prefix = "Gift0";
            else if(amt >= 1000) prefix = "Gift00";
            
            const random = Math.floor(100000 + Math.random() * 900000);
            const fullCode = prefix + random;
            
            await db.collection('giftCodes').doc(fullCode).set({
                code: fullCode, amount: amt, status: 'unused', prefix: prefix, createdAt: new Date()
            });
            
            document.getElementById('newCodeTxt').innerText = fullCode;
            document.getElementById('generatedCodeBox').classList.remove('hidden');
        }

        async function redeemGift() {
            const code = document.getElementById('giftInput').value.trim();
            const ref = db.collection('giftCodes').doc(code);
            const doc = await ref.get();
            if(!doc.exists || doc.data().status !== 'unused') return alert("Invalid or Used Code!");
            
            const amt = doc.data().amount;
            const uid = auth.currentUser.uid;
            
            await db.collection('users').doc(uid).update({ coins: firebase.firestore.FieldValue.increment(amt) });
            await ref.update({ status: 'used', usedBy: auth.currentUser.email, usedAt: new Date() });
            
            // Add to Global Gift Total (Not Income)
            const finRef = db.collection('admin').doc('finance');
            await finRef.update({ totalGifted: firebase.firestore.FieldValue.increment(amt) });
            
            alert(`Success! You got ${amt} Coins.`);
            document.getElementById('giftInput').value = "";
            showSection('bookStore');
        }

        function listenGift() {
            db.collection('admin').doc('finance').onSnapshot(doc => {
                document.getElementById('totalGiftDisplay').innerText = (doc.data().totalGifted || 0) + " C";
            });
            loadGiftReports('All');
        }

        async function loadGiftReports(prefix) {
            document.querySelectorAll('.g-filter-btn').forEach(b => b.classList.replace('bg-blue-600','bg-slate-800'));
            event.target.classList.replace('bg-slate-800','bg-blue-600');
            let q = db.collection('giftCodes').where('status', '==', 'used').orderBy('usedAt', 'desc');
            if(prefix !== 'All') q = q.where('prefix', '==', prefix);
            
            const snap = await q.limit(50).get();
            let html = ""; let sub = 0;
            snap.forEach(d => {
                sub += d.data().amount;
                html += `<div class="flex justify-between border-b border-white/5 pb-2">
                    <div><p class="font-bold text-purple-400">${d.data().code}</p><p class="text-[8px] text-gray-500">${d.data().usedBy}</p></div>
                    <p class="font-bold">+${d.data().amount} C</p>
                </div>`;
            });
            document.getElementById('giftLog').innerHTML = `<b>Selected Total: ${sub} C</b><br>${html}`;
        }

        // --- Finance System (Corrected) ---
        function listenFinance() {
            db.collection('admin').doc('finance').onSnapshot(doc => {
                document.getElementById('totalRevDisplay').innerText = (doc.data().totalIncome || 0) + " MMK";
            });
            calculateFinanceRange();
        }

        async function approveCoin(rid, uid, amt, status) {
            if(status === 'approved') {
                await db.collection('users').doc(uid).update({ coins: firebase.firestore.FieldValue.increment(amt) });
                const finRef = db.collection('admin').doc('finance');
                await finRef.update({ totalIncome: firebase.firestore.FieldValue.increment(amt) });
            }
            await db.collection('coinRequests').doc(rid).update({ status: status });
            alert("Success!");
        }

        async function calculateFinanceRange() {
            const start = document.getElementById('finStart').value ? new Date(document.getElementById('finStart').value) : new Date(0);
            const end = document.getElementById('finEnd').value ? new Date(document.getElementById('finEnd').value) : new Date();
            end.setHours(23,59,59);
            const snap = await db.collection('coinRequests').where('status', '==', 'approved').where('date', '>=', start).where('date', '<=', end).get();
            let subtotal = 0; let log = "";
            snap.forEach(d => { subtotal += d.data().amount; log += `<div class="flex justify-between border-b border-white/5 pb-1"><span>${d.data().buyerName}</span><span class="text-green-500">+${d.data().amount}</span></div>`; });
            document.getElementById('financeLog').innerHTML = `<b>Range Total: ${subtotal} MMK</b><br>${log}`;
        }

        // --- Reader Navigation ---
        async function loadChapters(bookId) {
            const snap = await db.collection('books').doc(bookId).collection('chapters').orderBy('date', 'asc').get();
            allChapters = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            const list = document.getElementById('chapterList'); list.innerHTML = "";
            const uDoc = await db.collection('users').doc(auth.currentUser.uid).get();
            const unlocked = uDoc.data().unlocked || []; const isVip = (uDoc.data().vipBooks || []).includes(bookId);
            const isAdmin = auth.currentUser.email === 'xztka49@gmail.com';
            
            allChapters.forEach((c, index) => {
                const isLocked = c.price > 0 && !unlocked.includes(c.id) && !isVip;
                list.innerHTML += `<div class="card p-4 flex justify-between items-center">
                    <span class="text-xs font-bold truncate max-w-[150px]">${c.title}</span>
                    <button onclick="handleChapter(${index})" class="${isLocked?'bg-orange-600':'bg-blue-600'} px-4 py-1.5 rounded-lg text-[10px] font-bold">${isLocked?'Buy':'Read'}</button>
                </div>`;
            });
        }

        async function handleChapter(index) {
            currentIdx = index;
            const c = allChapters[index];
            const userRef = db.collection('users').doc(auth.currentUser.uid);
            const uDoc = await userRef.get();
            const isVip = (uDoc.data().vipBooks || []).includes(currentBookId);
            const unlocked = uDoc.data().unlocked || [];

            if(c.price > 0 && !unlocked.includes(c.id) && !isVip) {
                if((uDoc.data().coins||0) < c.price) return alert("Not enough coins!");
                if(confirm("Unlock Chapter?")) {
                    await userRef.update({ 
                        coins: firebase.firestore.FieldValue.increment(-c.price), 
                        spent: firebase.firestore.FieldValue.increment(c.price), 
                        unlocked: firebase.firestore.FieldValue.arrayUnion(c.id),
                        history: firebase.firestore.FieldValue.arrayUnion({ book: currentBookTitle, chapter: c.title, price: c.price, date: new Date().toLocaleString() })
                    });
                    await db.collection('books').doc(currentBookId).update({ sales: firebase.firestore.FieldValue.increment(c.price) });
                    openReader(index);
                }
            } else openReader(index);
        }

        function openReader(index) {
            currentIdx = index;
            const c = allChapters[index];
            document.getElementById('readerTitle').innerText = c.title;
            document.getElementById('readerContent').innerText = c.content;
            showSection('readerSystem');
            
            const prev = document.getElementById('prevBtn');
            const next = document.getElementById('nextBtn');
            
            if(index > 0) { prev.onclick = () => handleChapter(index - 1); prev.classList.remove('opacity-50'); }
            else { prev.onclick = null; prev.classList.add('opacity-50'); }
            
            if(index < allChapters.length - 1) { next.onclick = () => handleChapter(index + 1); next.classList.remove('opacity-50'); }
            else { next.onclick = null; next.classList.add('opacity-50'); }
            window.scrollTo(0,0);
        }

        // --- Core Essentials ---
        async function loadBooks(genre) {
            const snap = await db.collection('books').orderBy('createdAt', 'desc').get();
            const list = document.getElementById('bookList'); list.innerHTML = "";
            snap.forEach(doc => {
                const b = doc.data(); if (genre !== 'All' && b.genre !== genre) return;
                list.innerHTML += `<div class="card cursor-pointer" onclick="openBook('${doc.id}', '${b.title}')"><img src="${b.cover}" class="h-44 w-full object-cover"><div class="p-3 text-[10px] font-bold truncate">${b.title}</div></div>`;
            });
        }
        async function openBook(id, title) { currentBookId = id; currentBookTitle = title; showSection('chapterView'); db.collection('books').doc(id).onSnapshot(doc => { if(doc.exists) document.getElementById('vipPriceTag').innerText = (doc.data().vipPrice || 5000) + " C"; }); loadChapters(id); }
        async function loadAds() { const doc = await db.collection('settings').doc('ads').get(); if(doc.exists) document.getElementById('adSlider').innerHTML = doc.data().images.map(i => `<img src="${i}" class="min-w-full h-full object-cover rounded-2xl">`).join(''); }
        async function saveAds() { const images = [document.getElementById('ad1').value, document.getElementById('ad2').value, document.getElementById('ad3').value, document.getElementById('ad4').value].filter(i => i); await db.collection('settings').doc('ads').set({ images }); alert("Ads Saved!"); }
        async function uploadBook() { await db.collection('books').add({ title: document.getElementById('bTitle').value, cover: document.getElementById('bCover').value, genre: document.getElementById('bGenre').value, views: 0, sales: 0, vips: 0, createdAt: new Date() }); alert("Published!"); loadBooks('All'); }
        async function uploadChapter() { const data = { title: document.getElementById('cTitle').value, content: document.getElementById('cContent').value, price: parseInt(document.getElementById('cPrice').value)||0, date: new Date() }; await db.collection('books').doc(currentBookId).collection('chapters').add(data); showSection('chapterView'); loadChapters(currentBookId); }
        async function login() { try { await auth.signInWithEmailAndPassword(document.getElementById('logEmail').value, document.getElementById('logPass').value); } catch(e) { alert(e.message); } }
        async function register() { try { const cred = await auth.createUserWithEmailAndPassword(document.getElementById('regEmail').value, document.getElementById('regPass').value); await db.collection('users').doc(cred.user.uid).set({ email: cred.user.email, coins: 0, spent: 0, unlocked: [], vipBooks: [], history: [] }); } catch(e) { alert(e.message); } }
        function loadPendingRequests() { db.collection('coinRequests').where('status', '==', 'pending').onSnapshot(snap => { document.getElementById('requestList').innerHTML = snap.docs.map(doc => `<div class="card p-4"><p><b>${doc.data().buyerName}</b> (${doc.data().amount})</p><div class="flex gap-2 mt-2"><button onclick="approveCoin('${doc.id}','${doc.data().uid}',${doc.data().amount},'approved')" class="bg-blue-600 py-1 rounded-lg flex-1">Approve</button><button onclick="approveCoin('${doc.id}','${doc.data().uid}',0,'rejected')" class="bg-red-600 py-1 rounded-lg flex-1">Reject</button></div></div>`).join(''); }); }
        async function requestCoins() { const d = { uid: auth.currentUser.uid, email: auth.currentUser.email, amount: parseInt(document.getElementById('coinPackage').value), buyerName: document.getElementById('buyerName').value, transId: document.getElementById('transId').value, status: 'pending', date: new Date() }; await db.collection('coinRequests').add(d); alert("Requested!"); showSection('bookStore'); }
        async function loadCharts(type) {
            const snap = await db.collection(type === 'user' ? 'users' : 'books').get();
            let html = "";
            snap.forEach(d => {
                const b = d.data();
                if(type === 'user') html += `<div class="flex justify-between border-b border-white/5 pb-1"><span>${b.email}</span><span>${b.coins} C</span></div>`;
                else if(type === 'view') html += `<div class="flex justify-between border-b border-white/5 pb-1"><span>${b.title}</span><span>${b.views || 0}</span></div>`;
                else html += `<div class="flex justify-between border-b border-white/5 pb-1"><span>${b.title}</span><span>${b.sales || 0} C</span></div>`;
            });
            document.getElementById('chartContainer').innerHTML = html;
        }
    </script>
</body>
</html>
