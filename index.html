<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FANTINAL - Global Premium Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020617; --card: #0f172a; --gold: #d4af37; --text: #f8fafc; --text-dim: #94a3b8;
            --vip0: #64748b; --vip1: #22c55e; --vip2: #cd7f32; --vip3: #c0c0c0; --vip4: #fbbf24; --vip5: #d946ef; --vip6: #f43f5e;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 90px; }
        h1, h2, .logo { font-family: 'Cinzel', serif; }

        /* General UI */
        .view { display: none; padding: 20px; animation: fadeIn 0.4s ease; }
        .active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--card); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.3s; width: 100%; }
        .btn-gold { background: linear-gradient(45deg, var(--gold), #fef08a); color: #000; }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; background: #1e293b; border: 1px solid #334155; color: white; border-radius: 10px; box-sizing: border-box; }

        /* VIP Tags & Glow */
        .vip-tag { padding: 3px 8px; border-radius: 5px; font-size: 0.65rem; font-weight: bold; margin-right: 5px; }
        .v0 { background: var(--vip0); } .v1 { background: var(--vip1); } .v2 { background: var(--vip2); }
        .v3 { background: var(--vip3); color: #000; } .v4 { background: var(--vip4); color: #000; }
        .v5 { background: var(--vip5); } .v6 { background: var(--vip6); border: 1px solid #fff; box-shadow: 0 0 10px var(--vip6); }

        /* Novel & Reader */
        .novel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .novel-card { border-radius: 12px; overflow: hidden; position: relative; cursor: pointer; transition: 0.3s; }
        .novel-card:hover { transform: scale(1.03); }
        .novel-card img { width: 100%; height: 230px; object-fit: cover; }
        .reader-text { line-height: 2.2; font-size: 1.2rem; white-space: pre-wrap; padding: 15px; text-align: justify; }

        /* Chat UI */
        #chat-box { height: 350px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; display: flex; flex-direction: column-reverse; }
        .chat-msg { margin-bottom: 8px; font-size: 0.9rem; padding: 8px; border-radius: 8px; background: rgba(255,255,255,0.05); }

        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid var(--gold); }
        .nav-item { color: var(--text-dim); font-size: 0.7rem; text-align: center; cursor: pointer; }
        .nav-item.active { color: var(--gold); }

        /* Modal */
        #vipModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<header style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--card); border-bottom: 1px solid var(--gold); position: sticky; top: 0; z-index: 1000;">
    <div class="logo" style="color:var(--gold); letter-spacing: 2px;">FANTINAL</div>
    <div id="authBox">
        <button id="loginBtn" onclick="login()" class="btn-gold" style="padding: 6px 15px; font-size: 0.8rem; width: auto;">SIGN IN</button>
        <div id="userInfo" style="display:none; text-align: right;">
            <div style="color:var(--gold); font-weight: bold;">ü™ô <span id="uCoins">0</span></div>
            <div id="uVip"></div>
        </div>
    </div>
</header>

<div id="home-view" class="view active-view">
    <input type="text" id="search" placeholder="Search stories..." oninput="searchStories()" style="border-radius:20px; padding-left: 15px;">
    <div class="novel-grid" id="novelGrid"></div>
</div>

<div id="detail-view" class="view">
    <div onclick="showView('home-view')" style="color:var(--gold); cursor:pointer; margin-bottom:15px;">‚Üê BACK</div>
    <div id="novelContent"></div>
    <div id="chapterList" class="card"></div>
</div>

<div id="reader-view" class="view">
    <div onclick="showView('detail-view')" style="color:var(--gold); cursor:pointer;">‚Üê BACK</div>
    <h2 id="rTitle" style="color:var(--gold); margin-top:20px;"></h2>
    <div id="rContent" class="reader-text"></div>
    <div style="display:flex; gap:10px; margin-top:30px;">
        <button id="prevBtn" class="btn" style="background:#334155;">Previous</button>
        <button id="nextBtn" class="btn btn-gold">Next Chapter</button>
    </div>
</div>

<div id="shop-view" class="view">
    <div class="card" style="text-align:center; border: 1px solid var(--gold);">
        <h1 style="color:var(--gold); margin:0;">ü™ô <span id="sCoins">0</span></h1>
        <p style="font-size:0.8rem; color:var(--text-dim);">Wallet Balance</p>
    </div>
    <div class="card" style="border-color:var(--green);">
        <h4 style="color:var(--green); margin:0;">Redeem Gift Code</h4>
        <input type="text" id="giftCodeInput" placeholder="Enter Code">
        <button class="btn" style="background:var(--green); color:white;" onclick="redeemGift()">Claim Coins</button>
    </div>
    <h3>Coin Packages</h3>
    <div id="pkgGrid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
    
    <div id="topupForm" class="card" style="display:none; margin-top:20px; border-color:var(--gold);">
        <h4 style="color:var(--gold)">Payment Details</h4>
        <p style="font-size:0.8rem;">KBZ/Wave: 09759731746 (THU KHA AUNG)</p>
        <input type="text" id="topupName" placeholder="Sender Name">
        <input type="text" id="topupID" placeholder="Last 6 Digits">
        <button class="btn btn-gold" onclick="submitTopup()">Submit</button>
    </div>
</div>

<div id="chat-view" class="view">
    <h3>Global Chat</h3>
    <div id="chat-box"></div>
    <div style="display:flex; gap:10px; margin-top:10px;">
        <input type="text" id="chatInput" placeholder="Say something...">
        <button onclick="sendChat()" class="btn-gold" style="width:80px;">Send</button>
    </div>
</div>

<div id="profile-view" class="view">
    <div class="card" style="text-align:center;">
        <h2 id="pName">Name</h2>
        <div id="pVip"></div>
        <p style="font-size:0.9rem; color:var(--text-dim);">Spent: ü™ô <span id="pSpent">0</span></p>
        <button class="btn btn-gold" onclick="openVipModal()" style="margin-top:10px; width:auto; padding:8px 20px;">VIP Levels Info</button>
    </div>
    
    <div class="card">
        <h4>Transfer Coins</h4>
        <input type="text" id="tfEmail" placeholder="Receiver Email">
        <input type="number" id="tfAmt" placeholder="Amount">
        <button class="btn" style="background:var(--blue); color:white;" onclick="transferCoins()">Transfer Now</button>
    </div>

    <h3>History</h3>
    <div class="card" style="overflow-x:auto;">
        <table id="histTable" style="width:100%; font-size:0.8rem;">
            <thead><tr style="text-align:left; color:var(--gold);"><th>Date</th><th>Type</th><th>Amt</th><th>Status</th></tr></thead>
            <tbody id="histBody"></tbody>
        </table>
    </div>

    <div id="admBtn" style="display:none; margin-top:20px;">
        <button class="btn btn-gold" onclick="showView('admin-view')">ADMIN PANEL</button>
    </div>
</div>

<div id="admin-view" class="view">
    <div onclick="showView('profile-view')" style="color:var(--gold); cursor:pointer; margin-bottom:20px;">‚Üê BACK</div>
    <div class="card" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; text-align:center;">
        <div><h4>Views</h4><span id="aViews">0</span></div>
        <div><h4>Revenue</h4><span id="aRev">0</span></div>
    </div>
    <div class="card">
        <h4>Pending Topups</h4>
        <div id="pendingList"></div>
    </div>
    <div class="card">
        <h4>Novels (Add/Edit)</h4>
        <input type="text" id="anID" placeholder="Novel ID (Empty = New)">
        <input type="text" id="anTitle" placeholder="Title">
        <input type="text" id="anAut" placeholder="Author">
        <input type="text" id="anCov" placeholder="Cover URL">
        <textarea id="anDes" placeholder="Desc"></textarea>
        <input type="number" id="anVipP" placeholder="Full Novel VIP Price">
        <button class="btn btn-gold" onclick="saveNovel()">Save Novel</button>
        <div id="admNovelList" style="margin-top:15px;"></div>
    </div>
    <div class="card">
        <h4>Chapters</h4>
        <select id="anSel"></select>
        <input type="number" id="acNum" placeholder="Ch Number">
        <input type="text" id="acTitle" placeholder="Ch Title">
        <textarea id="acCon" rows="5" placeholder="Content"></textarea>
        <input type="number" id="acCost" placeholder="Cost">
        <button class="btn btn-gold" onclick="saveChapter()">Publish Chapter</button>
    </div>
    <div class="card">
        <h4>Generate Gift Code</h4>
        <input type="number" id="agAmt" placeholder="Amount">
        <button class="btn" style="background:var(--green); color:white;" onclick="genGift()">Generate Code</button>
        <p id="gcRes" style="margin-top:10px; color:var(--green); font-weight:bold;"></p>
    </div>
</div>

<div id="vipModal">
    <div class="card" style="max-width:300px; text-align:left;">
        <h3 style="color:var(--gold); text-align:center;">VIP Requirements</h3>
        <p><span class="vip-tag v1">VIP 1</span>: 10,000 Spent</p>
        <p><span class="vip-tag v2">VIP 2</span>: 50,000</p>
        <p><span class="vip-tag v3">VIP 3</span>: 120,000</p>
        <p><span class="vip-tag v4">VIP 4</span>: 400,000 (Master)</p>
        <p><span class="vip-tag v5">VIP 5</span>: 1,000,000 (King)</p>
        <p><span class="vip-tag v6">VIP 6</span>: 3,000,000 (Emperor)</p>
        <button class="btn-gold" onclick="document.getElementById('vipModal').style.display='none'">Close</button>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="showView('home-view')">üè†<br>Home</div>
    <div class="nav-item" onclick="showView('shop-view')">üí∞<br>Shop</div>
    <div class="nav-item" onclick="showView('chat-view')">üí¨<br>Chat</div>
    <div class="nav-item" onclick="showView('profile-view')">üë§<br>Account</div>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, query, getDocs, getDoc, updateDoc, increment, setDoc, addDoc, where, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const config = { apiKey: "AIzaSyBxh92A7E6Egtk4kYB23Wmlelq13YYh1J0", authDomain: "fantinal-publishing-5b960.firebaseapp.com", projectId: "fantinal-publishing-5b960", storageBucket: "fantinal-publishing-5b960.firebasestorage.app", messagingSenderId: "961612304854", appId: "1:961612304854:web:6bf7b03072ed83b58b9477" };
    const app = initializeApp(config);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const prov = new GoogleAuthProvider();

    const ADMIN_EMAIL = "xztka49@gmail.com";
    let curU = null, uData = null, allNovels = [], curNid = null, curChNum = 0, selectedPkgAmt = 0;

    function getVip(spent) {
        if(spent >= 3000000) return {v:6, t:"Emperor", c:"v6"};
        if(spent >= 1000000) return {v:5, t:"King", c:"v5"};
        if(spent >= 400000) return {v:4, t:"Master", c:"v4"};
        if(spent >= 120000) return {v:3, t:"Silver", c:"v3"};
        if(spent >= 50000) return {v:2, t:"Bronze", c:"v2"};
        if(spent >= 10000) return {v:1, t:"Warrior", c:"v1"};
        return {v:0, t:"Newbie", c:"v0"};
    }

    window.login = () => signInWithPopup(auth, prov);

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            curU = user;
            const ref = doc(db, "users", user.uid);
            onSnapshot(ref, (s) => {
                if(s.exists()){
                    uData = s.data();
                    updateUI();
                } else {
                    setDoc(ref, { name: user.displayName, email: user.email, coins: 0, spent: 0 });
                }
            });
            if(user.email === ADMIN_EMAIL) document.getElementById('admBtn').style.display = 'block';
            loadHistory();
        }
    });

    function updateUI() {
        const vip = getVip(uData.spent);
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('userInfo').style.display = 'block';
        document.getElementById('uCoins').innerText = uData.coins;
        document.getElementById('sCoins').innerText = uData.coins;
        document.getElementById('uVip').innerHTML = `<span class="vip-tag ${vip.c}">${vip.t}</span>`;
        document.getElementById('pName').innerText = uData.name;
        document.getElementById('pSpent').innerText = uData.spent;
        document.getElementById('pVip').innerHTML = `<span class="vip-tag ${vip.c}" style="font-size:1rem">${vip.t}</span>`;
    }

    // --- COINS & TOPUP ---
    const pkgs = [1000, 2000, 5000, 10000, 30000, 50000];
    pkgs.forEach(p => {
        document.getElementById('pkgGrid').innerHTML += `<div class="card" onclick="selectPkg(${p})" style="cursor:pointer; text-align:center;">ü™ô ${p}</div>`;
    });
    window.selectPkg = (a) => { selectedPkgAmt = a; document.getElementById('topupForm').style.display = 'block'; };
    window.submitTopup = async () => {
        const name = document.getElementById('topupName').value;
        const tid = document.getElementById('topupID').value;
        if(!name || tid.length < 6) return alert("Invalid details!");
        await addDoc(collection(db, "transactions"), { uid: curU.uid, userName: curU.displayName, amount: selectedPkgAmt, tid, sender: name, type: "Topup", status: "Pending", date: serverTimestamp() });
        alert("Submitted!"); document.getElementById('topupForm').style.display = 'none';
    };

    // --- TRANSFER COINS ---
    window.transferCoins = async () => {
        const email = document.getElementById('tfEmail').value;
        const amt = Number(document.getElementById('tfAmt').value);
        if(uData.coins < amt) return alert("Low balance!");
        const q = query(collection(db, "users"), where("email", "==", email), limit(1));
        const s = await getDocs(q);
        if(s.empty) return alert("User not found!");
        const target = s.docs[0];
        await updateDoc(doc(db, "users", curU.uid), { coins: increment(-amt) });
        await updateDoc(doc(db, "users", target.id), { coins: increment(amt) });
        await addDoc(collection(db, "transactions"), { uid: curU.uid, type: "Transfer Out", amount: amt, status: "Approved", date: serverTimestamp() });
        alert("Transferred!");
    };

    // --- NOVELS & CHAPTERS ---
    async function loadNovels() {
        onSnapshot(collection(db, "novels"), (snap) => {
            const grid = document.getElementById('novelGrid'); grid.innerHTML = "";
            const sel = document.getElementById('anSel'); sel.innerHTML = "";
            const admL = document.getElementById('admNovelList'); admL.innerHTML = "";
            let tViews = 0;
            snap.forEach(d => {
                const n = d.data(); tViews += (n.views || 0);
                grid.innerHTML += `<div class="novel-card" onclick="openNovel('${d.id}')"><img src="${n.cover}"></div>`;
                sel.innerHTML += `<option value="${d.id}">${n.title}</option>`;
                admL.innerHTML += `<div class="card" style="padding:10px; display:flex; justify-content:space-between;">${n.title} <button onclick="editN('${d.id}')">Edit</button></div>`;
            });
            document.getElementById('aViews').innerText = tViews;
        });
    }

    window.openNovel = async (id) => {
        curNid = id;
        const n = (await getDoc(doc(db, "novels", id))).data();
        await updateDoc(doc(db, "novels", id), { views: increment(1) });
        showView('detail-view');
        document.getElementById('novelContent').innerHTML = `<h1>${n.title}</h1><p>By ${n.author}</p><p>${n.desc}</p><button class="btn btn-gold" onclick="buyFull('${id}', ${n.vipPrice})">Lifetime Unlock: ü™ô ${n.vipPrice}</button>`;
        const cSnap = await getDocs(query(collection(db, "novels", id, "chapters"), orderBy("num", "asc")));
        const cL = document.getElementById('chapterList'); cL.innerHTML = "<h4>Chapters</h4>";
        cSnap.forEach(cd => {
            const c = cd.data();
            cL.innerHTML += `<div onclick="readCh('${id}','${cd.id}',${c.cost},${c.num})" style="padding:10px; border-bottom:1px solid #334155; cursor:pointer;">Ch ${c.num}: ${c.title} <span style="float:right; color:var(--gold);">ü™ô ${c.cost}</span></div>`;
        });
    };

    window.readCh = async (nid, cid, cost, num) => {
        const vipSnap = await getDoc(doc(db, "users", curU.uid, "unlocked_novels", nid));
        const chSnap = await getDoc(doc(db, "users", curU.uid, "unlocked_chapters", cid));
        if(vipSnap.exists() || cost === 0 || chSnap.exists()){
            const cData = (await getDoc(doc(db, "novels", nid, "chapters", cid))).data();
            curChNum = num; showView('reader-view');
            document.getElementById('rTitle').innerText = "Chapter " + num + ": " + cData.title;
            document.getElementById('rContent').innerText = cData.content;
            window.scrollTo(0,0);
            updateNavBtns(nid, num);
        } else {
            if(uData.coins < cost) return alert("Need more coins!");
            if(confirm(`Unlock Chapter ${num} for ü™ô ${cost}?`)){
                await updateDoc(doc(db, "users", curU.uid), { coins: increment(-cost), spent: increment(cost) });
                await setDoc(doc(db, "users", curU.uid, "unlocked_chapters", cid), { date: serverTimestamp() });
                readCh(nid, cid, cost, num);
            }
        }
    };

    async function updateNavBtns(nid, num) {
        const next = await getDocs(query(collection(db, "novels", nid, "chapters"), where("num", "==", num + 1), limit(1)));
        const prev = await getDocs(query(collection(db, "novels", nid, "chapters"), where("num", "==", num - 1), limit(1)));
        document.getElementById('nextBtn').onclick = () => next.empty ? alert("Last Chapter") : readCh(nid, next.docs[0].id, next.docs[0].data().cost, num + 1);
        document.getElementById('prevBtn').onclick = () => prev.empty ? alert("First Chapter") : readCh(nid, prev.docs[0].id, prev.docs[0].data().cost, num - 1);
    }

    // --- GLOBAL CHAT ---
    window.sendChat = async () => {
        const t = document.getElementById('chatInput').value; if(!t) return;
        const vip = getVip(uData.spent);
        await addDoc(collection(db, "chat"), { name: curU.displayName, text: t, vTag: vip.t, vCls: vip.c, date: serverTimestamp() });
        document.getElementById('chatInput').value = "";
    };
    onSnapshot(query(collection(db, "chat"), orderBy("date", "desc"), limit(30)), (s) => {
        const b = document.getElementById('chat-box'); b.innerHTML = "";
        s.forEach(d => { const m = d.data(); b.innerHTML += `<div class="chat-msg"><span class="vip-tag ${m.vCls}">${m.vTag}</span><b>${m.name}:</b> ${m.text}</div>`; });
    });

    // --- GIFT CODES ---
    window.genGift = async () => {
        const a = Number(document.getElementById('agAmt').value);
        const code = "FANT-" + Math.random().toString(36).substr(2, 8).toUpperCase();
        await addDoc(collection(db, "gifts"), { code, amount: a, used: false });
        document.getElementById('gcRes').innerText = code;
    };
    window.redeemGift = async () => {
        const c = document.getElementById('giftCodeInput').value.trim();
        const q = query(collection(db, "gifts"), where("code", "==", c), where("used", "==", false), limit(1));
        const s = await getDocs(q);
        if(s.empty) return alert("Invalid Code");
        await updateDoc(doc(db, "users", curU.uid), { coins: increment(s.docs[0].data().amount) });
        await updateDoc(doc(db, "gifts", s.docs[0].id), { used: true });
        alert("Claimed!");
    };

    // --- ADMIN APPROVAL ---
    async function loadAdmReqs() {
        onSnapshot(query(collection(db, "transactions"), where("status", "==", "Pending")), (s) => {
            const l = document.getElementById('pendingList'); l.innerHTML = "";
            s.forEach(d => {
                const r = d.data();
                l.innerHTML += `<div class="card"><b>${r.userName}</b> ü™ô ${r.amount}<br><small>${r.tid} | ${r.sender}</small><br>
                    <button onclick="approveT('${d.id}','${r.uid}',${r.amount})">Approve</button></div>`;
            });
        });
        const revS = await getDocs(query(collection(db, "transactions"), where("status", "==", "Approved"), where("type", "==", "Topup")));
        let rev = 0; revS.forEach(d => rev += d.data().amount);
        document.getElementById('aRev').innerText = "ü™ô " + rev;
    }

    window.approveT = async (id, uid, amt) => {
        await updateDoc(doc(db, "transactions", id), { status: "Approved" });
        await updateDoc(doc(db, "users", uid), { coins: increment(amt) });
        alert("Approved");
    };

    // --- UTILS ---
    window.showView = (id) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
        document.getElementById(id).classList.add('active-view');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(id === 'admin-view') loadAdmReqs();
    };

    window.openVipModal = () => document.getElementById('vipModal').style.display = "flex";

    // Novel Save
    window.saveNovel = async () => {
        const id = document.getElementById('anID').value;
        const d = { title: document.getElementById('anTitle').value, author: document.getElementById('anAut').value, cover: document.getElementById('anCov').value, desc: document.getElementById('anDes').value, vipPrice: Number(document.getElementById('anVipP').value) };
        id ? await updateDoc(doc(db, "novels", id), d) : await addDoc(collection(db, "novels"), { ...d, views: 0 });
        alert("Saved");
    };

    window.saveChapter = async () => {
        const nid = document.getElementById('anSel').value;
        await addDoc(collection(db, "novels", nid, "chapters"), { num: Number(document.getElementById('acNum').value), title: document.getElementById('acTitle').value, content: document.getElementById('acCon').value, cost: Number(document.getElementById('acCost').value) });
        alert("Published");
    };

    loadNovels();
</script>
</body>
</html>
