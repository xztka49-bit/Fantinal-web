<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FANTINAL PRESTIGE LUXURY V25</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;400;600;800&display=swap');
        
        :root { 
            --gold: #d4af37; --dark: #05070a; --glass: rgba(15, 15, 20, 0.8);
            --accent: #1e293b; --premium-grad: linear-gradient(135deg, #d4af37 0%, #f9e29c 50%, #b38728 100%);
        }

        body { 
            background: var(--dark); color: #e2e8f0; font-family: 'Montserrat', sans-serif; 
            -webkit-tap-highlight-color: transparent; scroll-behavior: smooth;
        }

        .luxury-font { font-family: 'Cinzel', serif; }
        .glass-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(212, 175, 55, 0.15); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .gold-border { border: 1px solid var(--gold); }
        .gold-text { background: var(--premium-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-premium { background: var(--premium-grad); color: black; font-weight: 800; border-radius: 12px; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .btn-premium:active { transform: scale(0.9) rotate(-1deg); filter: brightness(1.2); }
        
        .nav-item { transition: 0.3s; cursor: pointer; }
        .nav-item:hover { color: var(--gold); transform: translateY(-2px); }

        input, select, textarea { 
            background: rgba(255,255,255,0.03) !important; border: 1px solid rgba(212, 175, 55, 0.2) !important;
            padding: 16px; border-radius: 14px; color: white; transition: 0.3s;
        }
        input:focus { border-color: var(--gold) !important; box-shadow: 0 0 15px rgba(212, 175, 55, 0.1); }

        .sidebar { position: fixed; right: -100%; top: 0; width: 85%; height: 100%; background: var(--dark); z-index: 5000; transition: 0.6s cubic-bezier(0.77, 0, 0.175, 1); border-left: 1px solid rgba(212, 175, 55, 0.2); }
        .sidebar.active { right: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        @keyframes gold-pulse { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); } }
        .pulse-gold { animation: gold-pulse 2s infinite; }
    </style>
</head>
<body class="no-scrollbar">

    <div id="notiBox" class="fixed top-6 right-6 z-[9999] flex flex-col gap-3"></div>
    <div id="overlay" class="fixed inset-0 bg-black/80 hidden z-[4000] backdrop-blur-md" onclick="toggleMenu()"></div>

    <div id="sidebar" class="sidebar p-8">
        <div class="flex justify-between items-center mb-12">
            <h2 class="luxury-font text-2xl gold-text font-bold">PRESTIGE</h2>
            <button onclick="toggleMenu()" class="text-3xl text-gold">‚úï</button>
        </div>
        <div class="glass-card p-6 mb-8 rounded-2xl border-l-4 border-l-[#d4af37]">
            <p id="userEmail" class="text-[10px] tracking-[3px] opacity-40 uppercase mb-4">MEMBER PROFILE</p>
            <div class="flex flex-col gap-1">
                <p id="uBalance" class="text-3xl font-black luxury-font">0 C</p>
                <p class="text-[9px] text-gold uppercase font-bold tracking-widest">Available Credits</p>
            </div>
        </div>
        <nav class="space-y-4">
            <div onclick="vibrate(); showSection('homeSection'); toggleMenu()" class="nav-item glass-card p-4 rounded-xl flex items-center gap-4"><span class="text-gold">‚óà</span> <span class="text-xs font-bold tracking-widest uppercase">Home Library</span></div>
            <div onclick="vibrate(); showSection('depositSection'); toggleMenu()" class="nav-item btn-premium p-4 rounded-xl flex items-center gap-4 shadow-xl shadow-gold/10"><span>‚óà</span> <span class="text-xs font-black tracking-widest uppercase">Top Up Credits</span></div>
            <div onclick="vibrate(); showSection('giftSection'); toggleMenu()" class="nav-item glass-card p-4 rounded-xl flex items-center gap-4"><span class="text-gold">‚óà</span> <span class="text-xs font-bold tracking-widest uppercase">Redeem Code</span></div>
            <div onclick="vibrate(); showSection('transferSection'); toggleMenu()" class="nav-item glass-card p-4 rounded-xl flex items-center gap-4"><span class="text-gold">‚óà</span> <span class="text-xs font-bold tracking-widest uppercase">Transfer</span></div>
            <div onclick="vibrate(); auth.signOut()" class="nav-item p-4 text-red-500 text-[10px] font-black tracking-widest uppercase text-center mt-10">Termination / Sign Out</div>
        </nav>
    </div>

    <nav class="sticky top-0 z-[3000] px-6 py-5 glass-card border-none flex justify-between items-center">
        <div class="flex items-center gap-3">
            <h1 onclick="vibrate(); location.reload()" class="luxury-font text-2xl font-black tracking-tighter gold-text cursor-pointer">FANTINAL</h1>
            <div id="adminBadge" class="hidden px-3 py-1 bg-red-950 text-red-500 border border-red-500/30 rounded text-[7px] font-black uppercase tracking-widest">Terminal</div>
        </div>
        <button onclick="vibrate(); toggleMenu()" class="p-2 text-gold"><svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 8h20M4 16h20M4 24h20"/></svg></button>
    </nav>

    <main class="max-w-xl mx-auto p-6 pb-32">
        
        <div id="searchWrapper" class="mb-8 hidden">
            <div class="relative">
                <input type="text" id="searchInput" oninput="searchBooks()" placeholder="Search Archives..." class="w-full glass-card h-16 px-6 pl-14 text-sm font-medium tracking-wide">
                <span class="absolute left-6 top-1/2 -translate-y-1/2 opacity-30">‚óà</span>
            </div>
        </div>

        <div id="authSection" class="hidden py-20 text-center">
            <h2 class="luxury-font text-5xl gold-text mb-4">ACCESS</h2>
            <p class="text-[9px] tracking-[5px] opacity-40 uppercase mb-12">The Elite Reading Experience</p>
            <div class="glass-card p-10 space-y-4">
                <input type="email" id="lEmail" placeholder="Email Identificator">
                <input type="password" id="lPass" placeholder="Security Token">
                <button onclick="vibrate(); login()" class="w-full btn-premium py-5 uppercase text-xs tracking-widest mt-4">Initiate Access</button>
                <button onclick="vibrate(); register()" class="w-full text-[9px] font-bold opacity-30 uppercase mt-4 tracking-widest">Create New Archive Account</button>
            </div>
        </div>

        <div id="homeSection" class="hidden">
            <div id="adSlider" class="flex overflow-x-auto gap-4 mb-10 h-56 rounded-[30px] no-scrollbar snap-x"></div>
            
            <div class="flex overflow-x-auto no-scrollbar gap-3 mb-10 pb-2">
                <button onclick="vibrate(); filterBooks('All')" class="px-6 py-2.5 glass-card rounded-full text-[9px] font-black uppercase tracking-widest active">All</button>
                <button onclick="vibrate(); filterBooks('Fan Fiction')" class="px-6 py-2.5 glass-card rounded-full text-[9px] font-black uppercase tracking-widest">Fiction</button>
                <button onclick="vibrate(); filterBooks('Life')" class="px-6 py-2.5 glass-card rounded-full text-[9px] font-black uppercase tracking-widest">Life</button>
                <button onclick="vibrate(); filterBooks('Mega')" class="px-6 py-2.5 glass-card rounded-full text-[9px] font-black uppercase tracking-widest">Mega</button>
            </div>

            <div id="bookGrid" class="grid grid-cols-2 gap-6"></div>

            <div id="adminBtn" class="hidden mt-16 space-y-4">
                <div class="p-0.5 btn-premium rounded-2xl"><button onclick="vibrate(); showSection('vsDashboard')" class="w-full py-5 bg-[#05070a] rounded-[14px] text-gold font-black text-[10px] tracking-widest uppercase">Analytic Intelligence</button></div>
                <div class="p-0.5 bg-red-600 rounded-2xl"><button onclick="vibrate(); showSection('adminDashboard')" class="w-full py-5 bg-[#05070a] rounded-[14px] text-red-500 font-black text-[10px] tracking-widest uppercase">Master Terminal</button></div>
            </div>
        </div>

        <div id="vsDashboard" class="hidden">
            <button onclick="showSection('homeSection')" class="text-gold mb-8 font-black text-[10px] tracking-widest uppercase">‚Üê Escape Terminal</button>
            
            <div class="glass-card p-6 mb-8 space-y-4">
                <p class="text-[9px] gold-text font-black tracking-widest uppercase">Temporal Filter</p>
                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="vsStart" class="text-xs">
                    <input type="date" id="vsEnd" class="text-xs">
                </div>
                <button onclick="vibrate(); loadAnalytics()" class="w-full btn-premium py-3 text-[9px] uppercase tracking-widest">Apply Filter</button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="glass-card p-6 text-center"><p class="text-[8px] opacity-40 uppercase mb-2">Engagements</p><p id="totalViewsStats" class="text-2xl font-black luxury-font">0</p></div>
                <div class="glass-card p-6 text-center"><p class="text-[8px] opacity-40 uppercase mb-2">Royalties</p><p id="totalSalesStats" class="text-2xl font-black luxury-font gold-text">0 C</p></div>
            </div>

            <div class="flex gap-2 bg-white/5 p-1 rounded-xl mb-8">
                <button onclick="vibrate(); setVSTab('v')" class="vs-t flex-1 py-3 rounded-lg text-[9px] font-bold bg-gold/20 text-gold uppercase">Views</button>
                <button onclick="vibrate(); setVSTab('s')" class="vs-t flex-1 py-3 rounded-lg text-[9px] font-bold uppercase">Sales</button>
            </div>
            <div id="vs-v" class="space-y-3"></div>
            <div id="vs-s" class="hidden space-y-3"></div>
        </div>

        <div id="adminDashboard" class="hidden">
            <button onclick="showSection('homeSection')" class="text-red-500 mb-8 font-black text-[10px] tracking-widest uppercase">‚Üê System Exit</button>
            
            <div class="glass-card p-6 mb-8 space-y-4">
                <div class="flex justify-between items-center">
                    <div><p class="text-[8px] opacity-40 uppercase">Global Revenue</p><p id="totalSales" class="text-3xl font-black gold-text">0 C</p></div>
                    <div class="text-right"><p class="text-[8px] opacity-40 uppercase">Population</p><p id="totalUsersCount" class="text-xl font-black">0</p></div>
                </div>
                <hr class="opacity-10">
                <div class="grid grid-cols-2 gap-3">
                    <input type="date" id="incStart" class="text-[10px]">
                    <input type="date" id="incEnd" class="text-[10px]">
                </div>
                <button onclick="vibrate(); calculateIncome()" class="w-full py-3 bg-white/5 text-[9px] font-black uppercase tracking-widest rounded-xl">Generate Report</button>
            </div>

            <div class="flex gap-2 bg-white/5 p-1 rounded-xl mb-8 overflow-x-auto no-scrollbar">
                <button onclick="vibrate(); setAdminTab('nov')" class="adm-t px-6 py-3 rounded-lg text-[9px] font-black bg-gold text-black uppercase">Novels</button>
                <button onclick="vibrate(); setAdminTab('users')" class="adm-t px-6 py-3 rounded-lg text-[9px] font-black uppercase">Users</button>
                <button onclick="vibrate(); setAdminTab('gift')" class="adm-t px-6 py-3 rounded-lg text-[9px] font-black uppercase">Gifts</button>
                <button onclick="vibrate(); setAdminTab('pay')" class="adm-t px-6 py-3 rounded-lg text-[9px] font-black uppercase">Orders</button>
            </div>

            <div id="tab-nov" class="space-y-4">
                <button onclick="vibrate(); openNovelForm()" class="w-full btn-premium py-4 text-[10px] uppercase tracking-tighter shadow-lg shadow-gold/20">+ Register New Masterpiece</button>
                <div id="admNovelList" class="space-y-3"></div>
            </div>

            <div id="tab-users" class="hidden space-y-3">
                <div id="userList" class="space-y-3"></div>
            </div>

            <div id="tab-gift" class="hidden space-y-4">
                <input type="number" id="giftAmtInput" placeholder="Amount of Credit (e.g. 5000)">
                <button onclick="vibrate(); generateGift()" class="w-full btn-premium py-4 text-[10px] uppercase">Generate Secure Code</button>
                <div id="giftCodeList" class="pt-6 space-y-3"></div>
            </div>

            <div id="tab-pay" class="hidden space-y-3"></div>
        </div>

        <div id="chapterView" class="hidden">
            <button onclick="showSection('homeSection')" class="text-gold mb-8 font-black text-[10px] tracking-widest uppercase">‚Üê Library</button>
            <h2 id="bookTitle" class="luxury-font text-4xl font-black gold-text mb-4 leading-tight">...</h2>
            
            <div class="flex items-center gap-6 mb-8">
                <div id="starRating" class="flex gap-1 text-xl text-gold">
                    <span onclick="vibrate(); rateBook(1)" class="cursor-pointer">‚òÜ</span>
                    <span onclick="vibrate(); rateBook(2)" class="cursor-pointer">‚òÜ</span>
                    <span onclick="vibrate(); rateBook(3)" class="cursor-pointer">‚òÜ</span>
                    <span onclick="vibrate(); rateBook(4)" class="cursor-pointer">‚òÜ</span>
                    <span onclick="vibrate(); rateBook(5)" class="cursor-pointer">‚òÜ</span>
                </div>
                <span id="bookRatingNum" class="text-[10px] font-black tracking-widest opacity-40">0.0 RATING</span>
            </div>

            <div class="glass-card p-6 mb-10 flex justify-between items-center pulse-gold">
                <div><p class="text-[8px] gold-text font-black tracking-[3px] uppercase mb-1">Pass Access</p><p id="vipPriceTag" class="text-3xl font-black">0 C</p></div>
                <button onclick="vibrate(); buyVip()" class="btn-premium px-8 py-4 text-[10px] uppercase tracking-widest">Buy Pass</button>
            </div>

            <div id="admChapAdd" class="hidden mb-6"><button onclick="vibrate(); openChapterForm()" class="w-full py-4 border border-gold/30 text-gold text-[9px] font-black uppercase rounded-xl">+ Add New Chapter</button></div>
            <div id="chapterList" class="space-y-4 mb-16"></div>

            <div class="border-t border-gold/10 pt-12">
                <h3 class="luxury-font text-xl gold-text mb-6">Audience Reviews</h3>
                <textarea id="comInput" rows="3" placeholder="Compose your thoughts..." class="w-full mb-4"></textarea>
                <button onclick="vibrate(); postComment()" class="w-full btn-premium py-4 text-[9px] uppercase tracking-widest">Publish Review</button>
                <div id="commentList" class="mt-10 space-y-6"></div>
            </div>
        </div>

        <div id="depositSection" class="hidden">
            <button onclick="showSection('homeSection')" class="text-gold mb-8 font-black text-[10px] tracking-widest uppercase">‚Üê Back</button>
            <div class="glass-card p-8 mb-8 relative overflow-hidden">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-gold/10 rounded-full blur-3xl"></div>
                <h3 class="luxury-font text-xl gold-text mb-2">Video Rewards</h3>
                <p class="text-[9px] opacity-40 mb-6 uppercase tracking-widest">Premium Ad Streaming</p>
                <div id="videoContainer" class="hidden mb-6 rounded-2xl overflow-hidden aspect-video bg-black shadow-2xl">
                    <iframe id="adVideoIframe" class="w-full h-full" src="" frameborder="0"></iframe>
                </div>
                <button id="watchBtn" onclick="vibrate(); startWatchAds()" class="w-full btn-premium py-5 text-xs uppercase tracking-[4px]">Watch & Earn (+20 C)</button>
                <button id="claimBtn" onclick="vibrate(); claimAdCoin()" class="hidden w-full btn-premium py-5 text-xs uppercase animate-bounce">Claim Royalties</button>
            </div>

            <div class="glass-card p-8">
                <h2 class="luxury-font text-xl gold-text mb-6 uppercase">Credit Purchase</h2>
                <select id="coinPackage" class="w-full mb-4">
                    <option value="1000">1,000 MMK ‚Äî 1,000 Credits</option>
                    <option value="2000">2,000 MMK ‚Äî 2,000 Credits</option>
                    <option value="5000">5,000 MMK ‚Äî 5,000 Credits</option>
                    <option value="10000">10,000 MMK ‚Äî 10,000 Credits</option>
                    <option value="25000">25,000 MMK ‚Äî 25,000 Credits</option>
                    <option value="50000">50,000 MMK ‚Äî 50,000 Credits</option>
                </select>
                <input type="text" id="payName" placeholder="Payer Identity" class="mb-4">
                <input type="text" id="payTid" placeholder="Transaction ID (Last 6)" class="mb-6">
                <button onclick="vibrate(); submitDeposit()" class="w-full btn-premium py-5 text-xs uppercase tracking-widest">Submit Order</button>
            </div>
        </div>

        <div id="readerSection" class="hidden fixed inset-0 bg-[#05070a] z-[6000] p-8 overflow-y-auto no-scrollbar">
            <div class="max-w-xl mx-auto pb-40">
                <div class="flex justify-between items-center mb-16">
                    <button onclick="vibrate(); showSection('chapterView')" class="text-gold text-2xl">‚úï</button>
                    <p class="text-[8px] tracking-[5px] gold-text opacity-50 uppercase">Secured Script</p>
                </div>
                <div id="readerBody" class="text-lg leading-[2] italic text-slate-300 select-none"></div>
                <div class="flex gap-4 mt-20">
                    <button id="pBtn" class="flex-1 glass-card py-5 text-[9px] font-black uppercase tracking-widest">Previous</button>
                    <button id="nBtn" class="flex-1 btn-premium py-5 text-[9px] uppercase tracking-widest">Next Chapter</button>
                </div>
            </div>
        </div>

        <div id="novelFormSection" class="hidden">
            <h2 class="luxury-font text-2xl gold-text mb-8">NOVEL REGISTRY</h2>
            <div class="space-y-4">
                <input type="text" id="nTitle" placeholder="Title of Masterpiece">
                <input type="text" id="nCover" placeholder="Cover Image URL">
                <input type="number" id="nVipPrice" placeholder="VIP Pass Amount">
                <select id="nGenre" class="w-full">
                    <option value="Fan Fiction">Fan Fiction</option>
                    <option value="Life">Life</option>
                    <option value="Mega">Mega</option>
                </select>
                <button onclick="vibrate(); saveNovel()" class="w-full btn-premium py-5 text-xs uppercase tracking-widest mt-6">Authorize Registry</button>
            </div>
        </div>

        <div id="chapterForm" class="hidden">
            <h2 class="luxury-font text-2xl gold-text mb-8">CHAPTER EDITOR</h2>
            <div class="space-y-4">
                <input type="text" id="cTitle" placeholder="Chapter Designation">
                <textarea id="cContent" rows="12" placeholder="The Narrative..."></textarea>
                <input type="number" id="cPrice" placeholder="Access Fee (0 = Free)">
                <button onclick="vibrate(); saveChapter()" class="w-full btn-premium py-5 text-xs uppercase tracking-widest">Commit Changes</button>
            </div>
        </div>

        <div id="giftSection" class="hidden"><button onclick="showSection('homeSection')" class="text-gold mb-8 font-black text-[10px] uppercase">‚Üê Back</button><div class="glass-card p-10"><h2 class="luxury-font text-2xl gold-text mb-8">REDEEM</h2><input type="text" id="redeemInput" placeholder="Security Code" class="mb-6"><button onclick="vibrate(); redeemGift()" class="w-full btn-premium py-5 text-xs uppercase tracking-widest">Claim Credits</button></div></div>
        <div id="transferSection" class="hidden"><button onclick="showSection('homeSection')" class="text-gold mb-8 font-black text-[10px] uppercase">‚Üê Back</button><div class="glass-card p-10"><h2 class="luxury-font text-2xl gold-text mb-8">TRANSFER</h2><input type="email" id="tRecipient" placeholder="Recipient Identity" class="mb-4"><input type="number" id="tAmount" placeholder="Credit Amount" class="mb-6"><button onclick="vibrate(); transferCoins()" class="w-full btn-premium py-5 text-xs uppercase tracking-widest">Confirm Transfer</button></div></div>

    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBxh92A7E6Egtk4kYB23Wmlelq13YYh1J0",
            authDomain: "fantinal-publishing-5b960.firebaseapp.com",
            projectId: "fantinal-publishing-5b960",
            storageBucket: "fantinal-publishing-5b960.firebasestorage.app",
            messagingSenderId: "961612304854",
            appId: "1:961612304854:web:6bf7b03072ed83b58b9477",
            measurementId: "G-3X5NP67TX7"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();

        let curB = "", curE = null, curC = null, allB = [], allC = [], users = [];

        // HAPTIC VIBRATION & UI
        function vibrate() { if(navigator.vibrate) navigator.vibrate(20); }
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('hidden'); }
        
        function showSection(id) { 
            document.querySelectorAll('main > div').forEach(s => s.classList.add('hidden')); 
            document.getElementById(id).classList.remove('hidden'); 
            document.getElementById('searchWrapper').classList.toggle('hidden', id !== 'homeSection');
            window.scrollTo(0,0);
        }

        function showNoti(m, t = 'success') {
            const b = document.createElement('div');
            b.className = `p-5 glass-card gold-border border-l-4 ${t === 'success' ? 'border-l-gold' : 'border-l-red-500'} text-[10px] font-bold tracking-widest shadow-2xl`;
            b.innerText = m.toUpperCase(); document.getElementById('notiBox').appendChild(b);
            setTimeout(() => { b.style.opacity = '0'; setTimeout(() => b.remove(), 500); }, 3000);
        }

        // AUTH & CORE LOAD
        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('userEmail').innerText = user.email;
                if(user.email === 'xztka49@gmail.com') {
                    document.getElementById('adminBadge').classList.remove('hidden');
                    document.getElementById('adminBtn').classList.remove('hidden');
                    document.getElementById('admChapAdd').classList.remove('hidden');
                }
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if(doc.exists) document.getElementById('uBalance').innerText = (doc.data().coins || 0) + " C";
                });
                showSection('homeSection'); loadAllBooks(); loadUsers();
            } else showSection('authSection');
        });

        async function login() { try { await auth.signInWithEmailAndPassword(document.getElementById('lEmail').value, document.getElementById('lPass').value); } catch(err) { showNoti(err.message, 'error'); } }
        async function register() { try { const r = await auth.createUserWithEmailAndPassword(document.getElementById('lEmail').value, document.getElementById('lPass').value); await db.collection('users').doc(r.user.uid).set({ email: r.user.email, coins: 0, vips: [], bought: [], date: new Date() }); } catch(err) { showNoti(err.message, 'error'); } }

        // SEARCH & FILTER
        function searchBooks() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allB.filter(b => b.title.toLowerCase().includes(q));
            renderGrid(filtered);
        }

        function filterBooks(g) {
            document.querySelectorAll('.cat-tab').forEach(b => b.classList.remove('active'));
            if(g === 'All') renderGrid(allB);
            else renderGrid(allB.filter(b => b.genre === g));
        }

        // NOVELS & ADMIN
        async function loadAllBooks() {
            const snap = await db.collection('books').get();
            allB = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderGrid(allB);
            renderAdminNovels();
            loadAnalytics();
        }

        function renderGrid(list) {
            document.getElementById('bookGrid').innerHTML = list.map(b => `
                <div class="glass-card overflow-hidden cursor-pointer rounded-3xl" onclick="vibrate(); openBook('${b.id}')">
                    <img src="${b.cover}" class="h-60 w-full object-cover">
                    <div class="p-5">
                        <p class="luxury-font text-[10px] gold-text font-black uppercase tracking-widest mb-1">${b.genre}</p>
                        <p class="font-bold text-xs truncate uppercase tracking-tighter">${b.title}</p>
                    </div>
                </div>`).join('');
        }

        function renderAdminNovels() {
            document.getElementById('admNovelList').innerHTML = allB.map(b => `
                <div class="glass-card p-5 flex justify-between items-center rounded-2xl">
                    <p class="text-[10px] font-bold truncate w-1/2 uppercase">${b.title}</p>
                    <div class="flex gap-4">
                        <button onclick="editNovel('${b.id}')" class="text-gold text-[9px] font-black uppercase">Edit</button>
                        <button onclick="deleteNovel('${b.id}')" class="text-red-500 text-[9px] font-black uppercase">Del</button>
                    </div>
                </div>`).join('');
        }

        function openNovelForm() { curE = null; document.getElementById('nTitle').value = ""; showSection('novelFormSection'); }

        async function saveNovel() {
            const d = { 
                title: document.getElementById('nTitle').value, 
                cover: document.getElementById('nCover').value, 
                genre: document.getElementById('nGenre').value, 
                vipPrice: parseInt(document.getElementById('nVipPrice').value) || 5000 
            };
            if(curE) await db.collection('books').doc(curE).update(d);
            else await db.collection('books').add({...d, views: 0, sales: 0, ratingAvg: 0, ratings: [], date: new Date()});
            showNoti("Library Updated"); loadAllBooks(); showSection('homeSection');
        }

        function editNovel(id) { curE = id; const b = allB.find(x => x.id === id); document.getElementById('nTitle').value = b.title; document.getElementById('nCover').value = b.cover; document.getElementById('nVipPrice').value = b.vipPrice; document.getElementById('nGenre').value = b.genre; showSection('novelFormSection'); }
        async function deleteNovel(id) { if(confirm("Permanently remove this archive?")) { await db.collection('books').doc(id).delete(); loadAllBooks(); } }

        // ANALYTICS & CALENDAR (FIXED)
        async function loadAnalytics() {
            const sDate = document.getElementById('vsStart').value ? new Date(document.getElementById('vsStart').value) : new Date(0);
            const eDate = document.getElementById('vsEnd').value ? new Date(document.getElementById('vsEnd').value) : new Date();

            let tv = 0, ts = 0;
            allB.forEach(b => { tv += (b.views || 0); ts += (b.sales || 0); });
            document.getElementById('totalViewsStats').innerText = tv;
            document.getElementById('totalSalesStats').innerText = ts + " C";

            document.getElementById('vs-v').innerHTML = allB.map(b => `<div class="glass-card p-4 flex justify-between text-[10px] font-bold uppercase"><span>${b.title}</span><span class="text-gold">${b.views||0} üëÅ</span></div>`).join('');
            document.getElementById('vs-s').innerHTML = allB.map(b => `<div class="glass-card p-4 flex justify-between text-[10px] font-bold uppercase"><span>${b.title}</span><span class="gold-text">${b.sales||0} C</span></div>`).join('');
        }

        async function calculateIncome() {
            const s = document.getElementById('incStart').value;
            const e = document.getElementById('incEnd').value;
            let query = db.collection('coinRequests').where('status', '==', 'approved');
            
            const snap = await query.get();
            let total = 0;
            snap.forEach(doc => {
                const date = doc.data().date.toDate();
                if(s && e) {
                    if(date >= new Date(s) && date <= new Date(e)) total += doc.data().amt;
                } else total += doc.data().amt;
            });
            document.getElementById('totalSales').innerText = total + " C";
        }

        // USERS LIST
        async function loadUsers() {
            const snap = await db.collection('users').get();
            users = snap.docs.map(d => d.data());
            document.getElementById('totalUsersCount').innerText = snap.size;
            document.getElementById('userList').innerHTML = users.map(u => `
                <div class="glass-card p-4 flex justify-between items-center text-[9px] font-bold uppercase">
                    <span>${u.email}</span>
                    <span class="text-gold">${u.coins} C</span>
                </div>`).join('');
        }

        // GIFT SYSTEM (AUTO CODE)
        function generateGift() {
            const amt = document.getElementById('giftAmtInput').value;
            if(!amt) return showNoti("Enter Amount", "error");
            const code = "LUXE-" + Math.random().toString(36).substring(2, 8).toUpperCase();
            db.collection('giftCodes').add({ code, amt: parseInt(amt), usedBy: [], date: new Date() });
            showNoti("Secure Code Generated");
            loadGifts();
        }

        async function loadGifts() {
            const snap = await db.collection('giftCodes').get();
            document.getElementById('giftCodeList').innerHTML = snap.docs.map(doc => `
                <div class="glass-card p-4 flex justify-between items-center rounded-xl">
                    <p class="font-bold text-xs gold-text">${doc.data().code} (${doc.data().amt} C)</p>
                    <button onclick="db.collection('giftCodes').doc('${doc.id}').delete(); loadGifts()" class="text-red-500 text-[8px] font-black uppercase">Void</button>
                </div>`).join('');
        }

        // RATING SYSTEM
        async function rateBook(val) {
            const stars = document.getElementById('starRating').children;
            for(let i=0; i<5; i++) stars[i].innerText = i < val ? '‚òÖ' : '‚òÜ';
            
            const bRef = db.collection('books').doc(curB);
            const bDoc = await bRef.get();
            let ratings = bDoc.data().ratings || [];
            ratings.push(val);
            const avg = ratings.reduce((a,b) => a+b, 0) / ratings.length;
            await bRef.update({ ratings, ratingAvg: avg });
            document.getElementById('bookRatingNum').innerText = avg.toFixed(1) + " RATING";
            showNoti("Rating Submitted");
        }

        // ALL ORIGINAL SYSTEMS (RE-INTEGRATED)
        async function openBook(id) { 
            curB = id; showSection('chapterView'); 
            const b = allB.find(x => x.id === id);
            document.getElementById('bookTitle').innerText = b.title;
            document.getElementById('vipPriceTag').innerText = b.vipPrice + " C";
            document.getElementById('bookRatingNum').innerText = (b.ratingAvg || 0).toFixed(1) + " RATING";
            await db.collection('books').doc(id).update({ views: firebase.firestore.FieldValue.increment(1) });
            loadChaps(); loadComments();
        }

        async function loadChaps() {
            const snap = await db.collection('books').doc(curB).collection('chapters').orderBy('date', 'asc').get();
            const uDoc = await db.collection('users').doc(auth.currentUser.uid).get();
            const vips = uDoc.data().vips || [], bought = uDoc.data().bought || [];
            allC = snap.docs.map(d => ({ id: d.id, ...d.data() }));

            document.getElementById('chapterList').innerHTML = allC.map((c, i) => {
                const canRead = c.price === 0 || vips.includes(curB) || bought.includes(c.id) || auth.currentUser.email === 'xztka49@gmail.com';
                return `<div class="glass-card p-5 flex justify-between items-center rounded-2xl">
                    <div><p class="text-[7px] opacity-30 uppercase font-black mb-1">Index ${i+1}</p><p class="text-[10px] font-bold uppercase truncate w-32">${c.title}</p></div>
                    <button onclick="vibrate(); readChapter(${i})" class="${canRead ? 'text-gold' : 'opacity-40'} text-[9px] font-black uppercase tracking-widest">
                        ${canRead ? 'Open' : 'Lock ' + c.price + 'C'}
                    </button>
                </div>`;
            }).join('');
        }

        async function readChapter(idx) {
            const c = allC[idx]; const uRef = db.collection('users').doc(auth.currentUser.uid); const uDoc = await uRef.get();
            const can = c.price === 0 || (uDoc.data().vips || []).includes(curB) || (uDoc.data().bought || []).includes(c.id) || auth.currentUser.email === 'xztka49@gmail.com';
            
            if(!can) {
                if(uDoc.data().coins < c.price) return showNoti("Insufficient Credits", 'error');
                if(!confirm(`Authorize transaction for ${c.price} Credits?`)) return;
                await uRef.update({ coins: firebase.firestore.FieldValue.increment(-c.price), bought: firebase.firestore.FieldValue.arrayUnion(c.id) });
                await db.collection('books').doc(curB).update({ sales: firebase.firestore.FieldValue.increment(c.price) });
                loadChaps(); return;
            }
            document.getElementById('readerBody').innerText = c.content; 
            showSection('readerSection');
        }

        // UI HELPERS
        function setAdminTab(t) {
            document.querySelectorAll('.adm-t').forEach(b => { b.classList.remove('bg-gold', 'text-black'); b.classList.add('text-white'); });
            event.target.classList.add('bg-gold', 'text-black');
            ['tab-nov', 'tab-users', 'tab-gift', 'tab-pay'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('tab-' + t).classList.remove('hidden');
            if(t === 'gift') loadGifts();
            if(t === 'users') loadUsers();
            if(t === 'pay') loadPendingOrders();
        }

        function setVSTab(t) {
            document.querySelectorAll('.vs-t').forEach(b => b.classList.remove('bg-gold/20'));
            event.target.classList.add('bg-gold/20');
            ['vs-v', 'vs-s'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('vs-' + t).classList.remove('hidden');
        }

        async function startWatchAds() {
            document.getElementById('videoContainer').classList.remove('hidden');
            document.getElementById('adVideoIframe').src = "https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1"; // Example
            document.getElementById('watchBtn').classList.add('hidden');
            setTimeout(() => { document.getElementById('claimBtn').classList.remove('hidden'); }, 15000);
        }

        async function claimAdCoin() {
            await db.collection('users').doc(auth.currentUser.uid).update({ coins: firebase.firestore.FieldValue.increment(20) });
            document.getElementById('videoContainer').classList.add('hidden');
            document.getElementById('claimBtn').classList.add('hidden');
            document.getElementById('watchBtn').classList.remove('hidden');
            showNoti("Credits Claimed");
        }

        async function submitDeposit() {
            await db.collection('coinRequests').add({ 
                uid: auth.currentUser.uid, email: auth.currentUser.email, 
                amt: parseInt(document.getElementById('coinPackage').value), 
                status: 'pending', date: new Date() 
            });
            showNoti("Order Submitted"); showSection('homeSection');
        }

        async function loadPendingOrders() {
            const snap = await db.collection('coinRequests').where('status', '==', 'pending').get();
            document.getElementById('tab-pay').innerHTML = snap.docs.map(doc => `
                <div class="glass-card p-5 rounded-2xl">
                    <p class="text-[8px] opacity-40 uppercase mb-2">${doc.data().email}</p>
                    <p class="text-xl font-black gold-text mb-4">${doc.data().amt} Credits</p>
                    <button onclick="approveDep('${doc.id}', '${doc.data().uid}', ${doc.data().amt})" class="w-full py-3 bg-gold text-black text-[9px] font-black uppercase rounded-lg">Approve Order</button>
                </div>`).join('');
        }

        async function approveDep(id, uid, amt) {
            await db.collection('users').doc(uid).update({ coins: firebase.firestore.FieldValue.increment(amt) });
            await db.collection('coinRequests').doc(id).update({ status: 'approved' });
            showNoti("Order Verified"); loadPendingOrders(); calculateIncome();
        }

        // REDEEM GIFT
        async function redeemGift() {
            const code = document.getElementById('redeemInput').value.trim();
            const snap = await db.collection('giftCodes').where('code', '==', code).get();
            if(snap.empty) return showNoti("Invalid Token", "error");
            const g = snap.docs[0];
            if(g.data().usedBy.includes(auth.currentUser.uid)) return showNoti("Token Used", "error");
            
            await db.collection('users').doc(auth.currentUser.uid).update({ coins: firebase.firestore.FieldValue.increment(g.data().amt) });
            await g.ref.update({ usedBy: firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid) });
            showNoti("Credits Redeemed");
        }

        // POST COMMENT
        async function postComment() {
            const txt = document.getElementById('comInput').value;
            if(!txt) return;
            await db.collection('books').doc(curB).collection('comments').add({
                email: auth.currentUser.email, text: txt, date: new Date()
            });
            document.getElementById('comInput').value = "";
            showNoti("Review Published");
        }

        async function loadComments() {
            db.collection('books').doc(curB).collection('comments').orderBy('date', 'desc').onSnapshot(snap => {
                document.getElementById('commentList').innerHTML = snap.docs.map(doc => `
                    <div class="border-l-2 border-gold/20 pl-6 py-2">
                        <p class="text-[9px] font-bold gold-text uppercase mb-2">${doc.data().email}</p>
                        <p class="text-xs opacity-60 leading-relaxed">${doc.data().text}</p>
                        ${auth.currentUser.email === 'xztka49@gmail.com' ? `<button onclick="db.collection('books').doc('${curB}').collection('comments').doc('${doc.id}').delete()" class="text-red-500 text-[7px] font-bold uppercase mt-2">Delete</button>` : ''}
                    </div>`).join('');
            });
        }
    </script>
</body>
</html>
