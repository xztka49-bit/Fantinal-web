<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantinal - Luxury Master Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        :root { --glass: rgba(30, 41, 59, 0.7); --border: rgba(255, 255, 255, 0.1); }
        body { background: #020617; color: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .luxury-card { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid var(--border); border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); }
        .sidebar { position: fixed; left: -100%; top: 0; width: 85%; height: 100%; background: #0f172a; z-index: 100; transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1); padding: 30px; border-right: 1px solid var(--border); }
        .sidebar.active { left: 0; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; z-index: 90; backdrop-filter: blur(4px); }
        .overlay.active { display: block; }
        .btn-luxury { background: linear-gradient(135deg, #2563eb, #7c3aed); transition: 0.3s; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
        .btn-luxury:active { transform: scale(0.95); }
        input, select, textarea { width: 100%; padding: 16px; margin-bottom: 14px; border-radius: 16px; background: #1e293b; color: white; border: 1px solid #334155; outline: none; }
        input:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .admin-tab-btn { flex: 1; padding: 12px 5px; font-size: 10px; font-weight: 800; color: #94a3b8; border-bottom: 2px solid transparent; }
        .admin-tab-btn.active { color: #60a5fa; border-bottom-color: #2563eb; }
    </style>
</head>
<body>
    <div id="overlay" class="overlay" onclick="toggleMenu()"></div>
    
    <div id="sidebar" class="sidebar overflow-y-auto no-scrollbar">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">MY PROFILE</h2>
            <button onclick="toggleMenu()" class="text-gray-400">✕</button>
        </div>
        <div class="luxury-card p-6 mb-8 bg-slate-800/50">
            <p id="userEmail" class="font-bold text-sm mb-4 text-blue-200 truncate">-</p>
            <div class="grid grid-cols-2 gap-4 border-t border-white/5 pt-5">
                <div><p class="text-[10px] text-gray-400 uppercase font-bold">Balance</p><p id="userBalance" class="text-xl font-black text-yellow-500">0 C</p></div>
                <div><p class="text-[10px] text-gray-400 text-right uppercase font-bold">Spent</p><p id="userSpent" class="text-xl font-black text-red-400 text-right">0 C</p></div>
            </div>
            <button onclick="showSection('buyCoinSection')" class="w-full mt-6 btn-luxury py-4 rounded-2xl font-black text-xs">DEPOSITS COINS</button>
            <button onclick="showSection('giftRedeemSection')" class="w-full mt-3 bg-slate-700 py-4 rounded-2xl font-black text-xs border border-white/5">REDEEM GIFT CODE</button>
        </div>
        <div id="userHistory" class="space-y-3 mb-12"></div>
        <button onclick="auth.signOut()" class="w-full bg-red-500/10 text-red-500 py-4 rounded-2xl text-xs font-black border border-red-500/20">LOGOUT</button>
    </div>

    <nav class="bg-slate-950/80 backdrop-blur-2xl p-4 sticky top-0 z-50 flex justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-5">
            <button onclick="toggleMenu()" class="text-2xl">☰</button>
            <h1 class="text-2xl font-black tracking-tighter italic" onclick="location.reload()">FANTINAL</h1>
        </div>
        <div id="adminIndicator" class="hidden bg-red-600/20 border border-red-500 text-red-500 px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">Admin Control</div>
    </nav>

    <main class="max-w-md mx-auto p-5 pb-24">
        
        <div id="authSection" class="hidden mt-10">
            <div class="flex bg-slate-900 p-1.5 rounded-2xl mb-8 border border-white/5">
                <button onclick="switchAuthTab('login')" id="loginTabBtn" class="flex-1 py-3 rounded-xl font-bold text-sm bg-blue-600">Login</button>
                <button onclick="switchAuthTab('register')" id="registerTabBtn" class="flex-1 py-3 rounded-xl font-bold text-sm">Register</button>
            </div>
            <div id="loginForm" class="luxury-card p-8">
                <input type="email" id="logEmail" placeholder="Email Address">
                <input type="password" id="logPass" placeholder="Password">
                <button onclick="login()" class="w-full btn-luxury py-4 rounded-2xl font-black shadow-lg">ENTER STORE</button>
            </div>
            <div id="registerForm" class="luxury-card p-8 hidden">
                <input type="email" id="regEmail" placeholder="Email Address">
                <input type="password" id="regPass" placeholder="Password">
                <button onclick="register()" class="w-full btn-luxury py-4 rounded-2xl font-black shadow-lg">CREATE ACCOUNT</button>
            </div>
        </div>

        <div id="bookStore" class="hidden">
            <div id="adSlider" class="flex overflow-x-auto gap-4 mb-8 no-scrollbar rounded-[30px] h-48 shadow-2xl"></div>
            <div class="flex gap-3 overflow-x-auto mb-8 pb-2 no-scrollbar">
                <button onclick="loadBooks('All')" class="genre-btn bg-blue-600 px-6 py-2 rounded-full text-xs font-bold active">All</button>
                <button onclick="loadBooks('Fan Fiction')" class="genre-btn bg-slate-800 px-6 py-2 rounded-full text-xs font-bold">Fan Fiction</button>
                <button onclick="loadBooks('Life')" class="genre-btn bg-slate-800 px-6 py-2 rounded-full text-xs font-bold">Life</button>
                <button onclick="loadBooks('Mega')" class="genre-btn bg-slate-800 px-6 py-2 rounded-full text-xs font-bold">Mega</button>
            </div>
            <div id="bookList" class="grid grid-cols-2 gap-6"></div>
            <div id="adminEntry" class="hidden mt-16"><button onclick="showSection('adminDashboard')" class="w-full btn-luxury py-5 rounded-3xl text-xs font-black tracking-widest">OPEN ADMIN CONTROL PANEL</button></div>
        </div>

        <div id="buyCoinSection" class="hidden">
            <button onclick="showSection('bookStore')" class="text-blue-400 mb-6 text-sm font-bold">← Back to Store</button>
            <div class="luxury-card p-8">
                <h2 class="text-2xl font-black mb-8 text-yellow-500 italic">Top-Up Coins</h2>
                <div class="bg-blue-600/10 p-6 rounded-2xl mb-8 border border-blue-500/20 text-center">
                    <p class="text-[10px] text-blue-400 font-bold mb-2 uppercase tracking-widest">Kpay / Wave Transfer</p>
                    <p class="text-2xl font-black">09759731746</p>
                    <p class="text-xs text-blue-300 mt-2 italic font-bold">Name: THU KHA AUNG</p>
                </div>
                <select id="coinPackage">
                    <option value="1000">1,000 MMK (1,000 C)</option>
                    <option value="5000">5,000 MMK (5,000 C)</option>
                    <option value="10000">10,000 MMK (10,000 C)</option>
                </select>
                <input type="text" id="buyerName" placeholder="Your Full Name">
                <input type="text" id="transId" placeholder="Trans ID (Last 6 digits)">
                <button onclick="requestCoins()" class="w-full btn-luxury py-4 rounded-2xl font-black shadow-xl mt-4">SEND REQUEST</button>
            </div>
        </div>

        <div id="giftRedeemSection" class="hidden">
            <button onclick="showSection('bookStore')" class="text-blue-400 mb-6 text-sm font-bold">← Back</button>
            <div class="luxury-card p-10 text-center">
                <h2 class="text-2xl font-black mb-2 text-purple-400">Gift Code</h2>
                <p class="text-xs text-gray-500 mb-10">Enter your code to claim free coins</p>
                <input type="text" id="giftInput" placeholder="GiftXXXXXXXX" class="text-center font-black tracking-widest">
                <button onclick="redeemGift()" class="w-full bg-purple-600 py-4 rounded-2xl font-black">CLAIM NOW</button>
            </div>
        </div>

        <div id="adminDashboard" class="hidden">
            <button onclick="showSection('bookStore')" class="text-blue-400 mb-8 text-sm font-bold">← EXIT CONTROL</button>
            <div class="flex gap-1 mb-10 border-b border-white/5">
                <button onclick="switchAdminTab('stats')" class="admin-tab-btn active">ANALYTICS</button>
                <button onclick="switchAdminTab('requests')" class="admin-tab-btn">REQUESTS</button>
                <button onclick="switchAdminTab('gift')" class="admin-tab-btn">COINS/GIFT</button>
                <button onclick="switchAdminTab('finance')" class="admin-tab-btn">FINANCE</button>
                <button onclick="switchAdminTab('users')" class="admin-tab-btn">USERS</button>
                <button onclick="switchAdminTab('upload')" class="admin-tab-btn">CONTENT</button>
            </div>

            <div id="tab-stats">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button onclick="loadCharts('view')" class="py-3 bg-blue-600 rounded-xl font-bold text-xs">VIEWS</button>
                    <button onclick="loadCharts('sale')" class="py-3 bg-slate-800 rounded-xl font-bold text-xs">SALES</button>
                </div>
                <div id="chartContainer" class="luxury-card p-6 text-[11px] space-y-4"></div>
            </div>

            <div id="tab-requests" class="hidden"><div id="requestList" class="space-y-4"></div></div>

            <div id="tab-gift" class="hidden">
                <div class="flex gap-2 mb-6">
                    <button onclick="switchGiftSubTab('gen')" id="gBtn-gen" class="flex-1 py-2 text-[10px] font-bold rounded-lg bg-blue-600">GENERATE</button>
                    <button onclick="switchGiftSubTab('report')" id="gBtn-report" class="flex-1 py-2 text-[10px] font-bold rounded-lg bg-slate-800">REPORTS</button>
                </div>
                <div id="gift-gen-area" class="luxury-card p-6">
                    <input type="number" id="giftAmount" placeholder="Enter Amount (e.g. 100000)">
                    <button onclick="generateGiftCode()" class="w-full bg-purple-600 py-4 rounded-xl font-black mb-4">GENERATE GIFT CODE</button>
                    <div id="generatedCodeBox" class="hidden p-4 bg-black/40 border border-dashed border-purple-500 rounded-xl text-center">
                        <p class="text-[10px] text-gray-500 mb-1 font-bold">YOUR CODE:</p>
                        <p id="newCodeTxt" class="text-xl font-black text-white tracking-widest"></p>
                    </div>
                </div>
                <div id="gift-report-area" class="hidden">
                    <div class="grid grid-cols-4 gap-1 mb-6">
                        <button onclick="loadGiftReports('All')" class="g-filter-btn py-2 text-[8px] bg-blue-600 rounded">All</button>
                        <button onclick="loadGiftReports('Gift1')" class="g-filter-btn py-2 text-[8px] bg-slate-800 rounded">Gift1</button>
                        <button onclick="loadGiftReports('Gift0')" class="g-filter-btn py-2 text-[8px] bg-slate-800 rounded">Gift0</button>
                        <button onclick="loadGiftReports('Gift00')" class="g-filter-btn py-2 text-[8px] bg-slate-800 rounded">Gift00</button>
                    </div>
                    <div class="luxury-card p-4 text-center border-purple-500/20 mb-4 bg-purple-950/20">
                        <p class="text-[10px] text-purple-400 font-black uppercase mb-1">Total Gifted Coins</p>
                        <h2 id="totalGiftDisplay" class="text-3xl font-black text-purple-400">0 C</h2>
                    </div>
                    <div id="giftLog" class="luxury-card p-5 text-[10px] space-y-3 max-h-80 overflow-y-auto"></div>
                </div>
            </div>

            <div id="tab-finance" class="hidden text-center">
                <div class="luxury-card p-8 bg-green-950/20 border-green-500/20 mb-8">
                    <p class="text-[10px] text-green-500 font-black uppercase mb-2">Total Website Revenue</p>
                    <h2 id="totalRevDisplay" class="text-4xl font-black text-green-400">0 MMK</h2>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <input type="date" id="finStart" class="text-xs"><input type="date" id="finEnd" class="text-xs">
                </div>
                <button onclick="calculateFinanceRange()" class="w-full bg-slate-800 py-4 rounded-2xl text-xs font-black mb-8 border border-white/5">FILTER BY DATE</button>
                <div id="financeLog" class="luxury-card p-5 text-left text-[11px] space-y-3"></div>
            </div>

            <div id="tab-users" class="hidden"><div id="totalUsersList" class="space-y-3"></div></div>

            <div id="tab-upload" class="hidden">
                <div class="luxury-card p-6 mb-6">
                    <input type="text" id="bTitle" placeholder="Novel Name">
                    <input type="text" id="bCover" placeholder="Cover Image URL">
                    <select id="bGenre">
                        <option value="Fan Fiction">Fan Fiction</option>
                        <option value="Life">Life</option>
                        <option value="Mega">Mega</option>
                    </select>
                    <button onclick="uploadBook()" class="w-full btn-luxury py-4 rounded-2xl font-black">PUBLISH NOVEL</button>
                </div>
                <div class="luxury-card p-6">
                    <input type="text" id="ad1" placeholder="Ad 1 URL"><input type="text" id="ad2" placeholder="Ad 2 URL">
                    <button onclick="saveAds()" class="bg-green-600 w-full py-4 rounded-2xl font-black">SAVE ADS SLIDER</button>
                </div>
            </div>
        </div>

        <div id="chapterView" class="hidden">
            <button onclick="showSection('bookStore')" class="text-blue-400 mb-8 text-sm font-bold">← Library</button>
            <div class="luxury-card p-8 mb-8 bg-gradient-to-br from-slate-800 to-slate-900 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Unlock All Access</p>
                        <h3 id="vipPriceTag" class="text-3xl font-black text-yellow-500 tracking-tighter">0 C</h3>
                    </div>
                    <button id="buyVipBtn" onclick="handleVipPurchase()" class="bg-yellow-600 px-10 py-3 rounded-2xl text-xs font-black shadow-lg">GET VIP</button>
                </div>
                <div id="adminVipEdit" class="hidden border-t border-white/5 pt-6">
                    <input type="number" id="newVipPrice" placeholder="Set New VIP Price" class="text-sm">
                    <button onclick="updateVipPrice()" class="w-full bg-blue-600 py-3 rounded-xl text-[10px] font-black">UPDATE PRICE</button>
                </div>
            </div>
            <div id="adminChapterBtn" class="hidden mb-10">
                <button onclick="prepareAddChapter()" class="w-full btn-luxury py-4 rounded-2xl text-sm font-black tracking-widest">+ PUBLISH NEW CHAPTER</button>
            </div>
            <div id="chapterList" class="space-y-4"></div>
        </div>

        <div id="addChapterForm" class="hidden">
            <h3 class="text-2xl font-black mb-8 italic">Chapter Workspace</h3>
            <input type="text" id="cTitle" placeholder="Chapter Title">
            <textarea id="cContent" rows="18" placeholder="Begin writing content..."></textarea>
            <input type="number" id="cPrice" placeholder="Price (0 for free)">
            <button onclick="uploadChapter()" class="w-full btn-luxury py-5 rounded-2xl font-black mb-4 text-lg shadow-2xl">SAVE & PUBLISH</button>
            <button onclick="showSection('chapterView')" class="w-full text-gray-500 font-bold">CANCEL</button>
        </div>

        <div id="readerSystem" class="hidden fixed inset-0 bg-[#020617] text-slate-300 z-[200] p-6 overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-10 max-w-md mx-auto">
                <button onclick="showSection('chapterView')" class="text-blue-400 font-bold text-sm bg-blue-400/10 px-6 py-2 rounded-full">← Exit</button>
                <div id="readerTitle" class="text-xs font-black truncate max-w-[150px] uppercase tracking-widest text-gray-500">Title</div>
            </div>
            <div id="readerContent" class="max-w-md mx-auto whitespace-pre-wrap leading-[1.8] text-xl pb-32 font-serif text-slate-200"></div>
            <div class="fixed bottom-0 left-0 right-0 p-4 bg-slate-900/80 backdrop-blur-xl border-t border-white/5">
                <div class="max-w-md mx-auto flex gap-4">
                    <button id="prevBtn" class="flex-1 bg-slate-800 py-4 rounded-2xl text-xs font-black opacity-50 border border-white/5">PREV</button>
                    <button id="nextBtn" class="flex-1 btn-luxury py-4 rounded-2xl text-xs font-black opacity-50 shadow-xl">NEXT</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBxh92A7E6Egtk4kYB23Wmlelq13YYh1J0",
            authDomain: "fantinal-publishing-5b960.firebaseapp.com",
            projectId: "fantinal-publishing-5b960",
            storageBucket: "fantinal-publishing-5b960.firebasestorage.app",
            messagingSenderId: "961612304854",
            appId: "1:961612304854:web:6bf7b03072ed83b58b9477"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore();
        let currentBookId = ""; let currentBookTitle = ""; let editChapterId = null;
        let allChapters = []; let currentIdx = 0;

        // UI Core
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); if(document.getElementById('sidebar').classList.contains('active')) loadUserStats(); }
        function showSection(id) { document.querySelectorAll('main > div').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); if(id === 'bookStore') { document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); } window.scrollTo(0,0); }
        function switchAuthTab(tab) { ['loginForm', 'registerForm'].forEach(f => document.getElementById(f).classList.add('hidden')); document.getElementById(tab+'Form').classList.remove('hidden'); ['loginTabBtn', 'registerTabBtn'].forEach(b => document.getElementById(b).classList.remove('bg-blue-600')); document.getElementById(tab+'TabBtn').classList.add('bg-blue-600'); }
        function switchAdminTab(tab) { document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); ['stats', 'requests', 'gift', 'finance', 'users', 'upload'].forEach(t => document.getElementById('tab-'+t).classList.add('hidden')); document.getElementById('tab-'+tab).classList.remove('hidden'); if(tab==='finance') listenFinance(); if(tab==='gift') listenGift(); if(tab==='stats') loadCharts('view'); if(tab==='users') loadAllUsers(); }
        function switchGiftSubTab(sub) { ['gift-gen-area', 'gift-report-area'].forEach(a => document.getElementById(a).classList.add('hidden')); document.getElementById('gift-'+sub+'-area').classList.remove('hidden'); ['gBtn-gen', 'gBtn-report'].forEach(b => document.getElementById(b).classList.replace('bg-blue-600','bg-slate-800')); document.getElementById('gBtn-'+sub).classList.replace('bg-slate-800','bg-blue-600'); }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('userEmail').innerText = user.email;
                if (user.email === 'xztka49@gmail.com') { 
                    ['adminEntry','adminIndicator','adminChapterBtn','adminVipEdit'].forEach(id => document.getElementById(id).classList.remove('hidden'));
                    loadPendingRequests();
                }
                db.collection('users').doc(user.uid).onSnapshot(doc => { if(doc.exists) { document.getElementById('userBalance').innerText = (doc.data().coins || 0) + " C"; document.getElementById('userSpent').innerText = (doc.data().spent || 0) + " C"; } });
                showSection('bookStore'); loadBooks('All'); loadAds();
            } else { showSection('authSection'); }
        });

        // --- DEPOSITS & FINANCE SYSTEM (Restored & Enhanced) ---
        async function requestCoins() {
            const amt = parseInt(document.getElementById('coinPackage').value);
            const name = document.getElementById('buyerName').value;
            const tid = document.getElementById('transId').value;
            if(!name || tid.length < 5) return alert("Fill details correctly!");
            await db.collection('coinRequests').add({ uid: auth.currentUser.uid, email: auth.currentUser.email, amount: amt, buyerName: name, transId: tid, status: 'pending', date: new Date() });
            alert("Deposit submitted! Wait for approval.");
            showSection('bookStore');
        }

        function loadPendingRequests() { 
            db.collection('coinRequests').where('status', '==', 'pending').onSnapshot(snap => { 
                document.getElementById('requestList').innerHTML = snap.docs.map(doc => `<div class="luxury-card p-6 border-blue-500/30"><div><p class="text-xs text-blue-400 font-bold mb-2">NEW DEPOSIT</p><h4 class="text-lg font-black">${doc.data().buyerName}</h4><p class="text-yellow-500 font-bold">${doc.data().amount} MMK</p><p class="text-[10px] text-gray-500 mt-2">ID: ${doc.data().transId}</p></div><div class="flex gap-3 mt-5"><button onclick="approveCoin('${doc.id}','${doc.data().uid}',${doc.data().amount},'approved')" class="bg-blue-600 py-3 rounded-xl flex-1 font-black text-xs">APPROVE</button><button onclick="approveCoin('${doc.id}','${doc.data().uid}',0,'rejected')" class="bg-red-500/10 text-red-500 py-3 rounded-xl flex-1 font-black text-xs border border-red-500/20">REJECT</button></div></div>`).join(''); 
            }); 
        }

        async function approveCoin(rid, uid, amt, status) {
            if(status === 'approved') {
                await db.collection('users').doc(uid).update({ coins: firebase.firestore.FieldValue.increment(amt) });
                await db.collection('admin').doc('finance').set({ totalIncome: firebase.firestore.FieldValue.increment(amt) }, {merge:true});
            }
            await db.collection('coinRequests').doc(rid).update({ status: status });
            alert("Transaction " + status);
        }

        function listenFinance() {
            db.collection('admin').doc('finance').onSnapshot(doc => { document.getElementById('totalRevDisplay').innerText = (doc.exists ? doc.data().totalIncome : 0) + " MMK"; });
            calculateFinanceRange();
        }

        async function calculateFinanceRange() {
            const start = document.getElementById('finStart').value ? new Date(document.getElementById('finStart').value) : new Date(0);
            const end = document.getElementById('finEnd').value ? new Date(document.getElementById('finEnd').value) : new Date();
            end.setHours(23,59,59);
            const snap = await db.collection('coinRequests').where('status', '==', 'approved').where('date', '>=', start).where('date', '<=', end).get();
            let total = 0; let log = "";
            snap.forEach(d => { total += d.data().amount; log += `<div class="flex justify-between border-b border-white/5 pb-2"><span>${d.data().buyerName}</span><span class="text-green-500 font-bold">+${d.data().amount}</span></div>`; });
            document.getElementById('financeLog').innerHTML = `<p class="font-black text-blue-400 mb-4 uppercase">Subtotal: ${total} MMK</p>` + log;
        }

        // --- GIFT CODE SYSTEM (Message Report Fixed) ---
        async function generateGiftCode() {
            const amt = parseInt(document.getElementById('giftAmount').value); if(!amt) return alert("Enter Amount!");
            let prefix = amt >= 100000 ? "Gift1" : amt >= 10000 ? "Gift0" : amt >= 1000 ? "Gift00" : "Gift000";
            const code = prefix + Math.floor(1000000 + Math.random() * 9000000);
            await db.collection('giftCodes').doc(code).set({ code, amount: amt, prefix, status: 'unused', createdAt: new Date() });
            document.getElementById('newCodeTxt').innerText = code; document.getElementById('generatedCodeBox').classList.remove('hidden');
        }

        async function redeemGift() {
            const code = document.getElementById('giftInput').value.trim();
            const ref = db.collection('giftCodes').doc(code); const doc = await ref.get();
            if(!doc.exists || doc.data().status !== 'unused') return alert("Invalid or Already Used!");
            const amt = doc.data().amount;
            await db.collection('users').doc(auth.currentUser.uid).update({ coins: firebase.firestore.FieldValue.increment(amt) });
            await ref.update({ status: 'used', usedByEmail: auth.currentUser.email, usedByUid: auth.currentUser.uid, usedAt: new Date() });
            await db.collection('admin').doc('finance').set({ totalGifted: firebase.firestore.FieldValue.increment(amt) }, {merge:true});
            alert(`Boom! ${amt} Coins Added.`); showSection('bookStore');
        }

        function listenGift() {
            db.collection('admin').doc('finance').onSnapshot(doc => { document.getElementById('totalGiftDisplay').innerText = (doc.exists ? doc.data().totalGifted : 0) + " C"; });
            loadGiftReports('All');
        }

        async function loadGiftReports(prefix) {
            document.querySelectorAll('.g-filter-btn').forEach(b => b.classList.replace('bg-blue-600','bg-slate-800'));
            event.target.classList.replace('bg-slate-800','bg-blue-600');
            let q = db.collection('giftCodes').where('status', '==', 'used').orderBy('usedAt', 'desc');
            if(prefix !== 'All') q = q.where('prefix', '==', prefix);
            const snap = await q.get(); let html = "";
            snap.forEach(d => { 
                const data = d.data();
                html += `<div class="luxury-card p-4 bg-slate-900/50 border-purple-500/10">
                    <p class="text-purple-400 font-black">${data.code}</p>
                    <p class="text-white text-xs mt-1">User: <span class="text-blue-300">${data.usedByEmail}</span></p>
                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-white/5">
                        <span class="text-gray-500 text-[8px]">${data.usedAt.toDate().toLocaleString()}</span>
                        <span class="text-green-400 font-bold">+${data.amount} C</span>
                    </div>
                </div>`;
            });
            document.getElementById('giftLog').innerHTML = html || "<p class='text-center text-gray-500'>No reports found.</p>";
        }

        // --- CONTENT MANAGEMENT (CRUD Restored) ---
        async function updateVipPrice() { 
            const p = parseInt(document.getElementById('newVipPrice').value);
            if(p) { await db.collection('books').doc(currentBookId).update({ vipPrice: p }); alert("VIP Price Updated!"); } 
        }

        function prepareAddChapter() { editChapterId = null; document.getElementById('cTitle').value = ""; document.getElementById('cContent').value = ""; document.getElementById('cPrice').value = ""; showSection('addChapterForm'); }
        
        async function editChapter(id) { 
            editChapterId = id; const doc = await db.collection('books').doc(currentBookId).collection('chapters').doc(id).get();
            const c = doc.data(); document.getElementById('cTitle').value = c.title; document.getElementById('cContent').value = c.content; document.getElementById('cPrice').value = c.price;
            showSection('addChapterForm');
        }

        async function deleteChapter(id) { 
            if(confirm("Permanently Delete?")) { await db.collection('books').doc(currentBookId).collection('chapters').doc(id).delete(); loadChapters(currentBookId); } 
        }

        async function uploadChapter() {
            const data = { title: document.getElementById('cTitle').value, content: document.getElementById('cContent').value, price: parseInt(document.getElementById('cPrice').value)||0, date: new Date() };
            if(editChapterId) await db.collection('books').doc(currentBookId).collection('chapters').doc(editChapterId).update(data);
            else await db.collection('books').doc(currentBookId).collection('chapters').add(data);
            showSection('chapterView'); loadChapters(currentBookId);
        }

        // --- READER & NAVIGATION ---
        async function loadChapters(bookId) {
            const snap = await db.collection('books').doc(bookId).collection('chapters').orderBy('date', 'asc').get();
            allChapters = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            const uDoc = await db.collection('users').doc(auth.currentUser.uid).get();
            const unlocked = uDoc.data().unlocked || []; const isVip = (uDoc.data().vipBooks || []).includes(bookId);
            const isAdmin = auth.currentUser.email === 'xztka49@gmail.com';
            
            document.getElementById('chapterList').innerHTML = allChapters.map((c, i) => {
                const isLocked = c.price > 0 && !unlocked.includes(c.id) && !isVip;
                return `<div class="luxury-card p-5 flex flex-col gap-3">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold truncate max-w-[150px]">${c.title}</span>
                        <button onclick="handleChapter(${i})" class="${isLocked?'bg-orange-600':'bg-blue-600'} px-6 py-2 rounded-xl text-[10px] font-black">${isLocked? c.price+' C' : 'READ'}</button>
                    </div>
                    ${isAdmin ? `<div class="flex gap-4 border-t border-white/5 pt-3 mt-1"><button onclick="editChapter('${c.id}')" class="text-blue-400 text-[9px] font-bold">EDIT</button><button onclick="deleteChapter('${c.id}')" class="text-red-500 text-[9px] font-bold">DELETE</button></div>` : ''}
                </div>`;
            }).join('');
        }

        async function handleChapter(i) {
            currentIdx = i; const c = allChapters[i];
            const userRef = db.collection('users').doc(auth.currentUser.uid); const uDoc = await userRef.get();
            const isVip = (uDoc.data().vipBooks || []).includes(currentBookId);
            if(c.price > 0 && !(uDoc.data().unlocked||[]).includes(c.id) && !isVip) {
                if((uDoc.data().coins||0) < c.price) return alert("Not enough coins!");
                if(confirm(`Unlock for ${c.price} C?`)) {
                    await userRef.update({ coins: firebase.firestore.FieldValue.increment(-c.price), spent: firebase.firestore.FieldValue.increment(c.price), unlocked: firebase.firestore.FieldValue.arrayUnion(c.id), history: firebase.firestore.FieldValue.arrayUnion({ book: currentBookTitle, chapter: c.title, price: c.price, date: new Date().toLocaleString() }) });
                    await db.collection('books').doc(currentBookId).update({ sales: firebase.firestore.FieldValue.increment(c.price) });
                    openReader(i);
                }
            } else openReader(i);
        }

        function openReader(i) {
            currentIdx = i; const c = allChapters[i];
            document.getElementById('readerTitle').innerText = c.title;
            document.getElementById('readerContent').innerText = c.content;
            showSection('readerSystem');
            const prev = document.getElementById('prevBtn'); const next = document.getElementById('nextBtn');
            prev.onclick = i > 0 ? () => openReader(i-1) : null; prev.style.opacity = i > 0 ? 1 : 0.3;
            next.onclick = i < allChapters.length-1 ? () => handleChapter(i+1) : null; next.style.opacity = i < allChapters.length-1 ? 1 : 0.3;
            window.scrollTo(0,0);
        }

        // --- OTHER CORE FUNCTIONS ---
        async function loadBooks(genre) {
            const snap = await db.collection('books').orderBy('createdAt', 'desc').get();
            document.getElementById('bookList').innerHTML = snap.docs.map(doc => {
                const b = doc.data(); if(genre !== 'All' && b.genre !== genre) return "";
                return `<div class="luxury-card cursor-pointer group" onclick="openBook('${doc.id}', '${b.title}')">
                    <img src="${b.cover}" class="h-52 w-full object-cover rounded-t-[24px]">
                    <div class="p-4 text-[11px] font-black truncate">${b.title}</div>
                </div>`;
            }).join('');
        }

        async function openBook(id, title) { currentBookId = id; currentBookTitle = title; showSection('chapterView'); await db.collection('books').doc(id).update({ views: firebase.firestore.FieldValue.increment(1) }); loadChapters(id); }
        async function loadAds() { const doc = await db.collection('settings').doc('ads').get(); if(doc.exists) document.getElementById('adSlider').innerHTML = doc.data().images.map(i => `<img src="${i}" class="min-w-full h-full object-cover">`).join(''); }
        async function saveAds() { const images = [document.getElementById('ad1').value, document.getElementById('ad2').value].filter(i => i); await db.collection('settings').doc('ads').set({ images }); alert("Ads Saved!"); }
        async function uploadBook() { await db.collection('books').add({ title: document.getElementById('bTitle').value, cover: document.getElementById('bCover').value, genre: document.getElementById('bGenre').value, views: 0, sales: 0, vips: 0, createdAt: new Date() }); alert("Novel Published!"); loadBooks('All'); }
        async function login() { try { await auth.signInWithEmailAndPassword(document.getElementById('logEmail').value, document.getElementById('logPass').value); } catch(e) { alert(e.message); } }
        async function register() { try { const cred = await auth.createUserWithEmailAndPassword(document.getElementById('regEmail').value, document.getElementById('regPass').value); await db.collection('users').doc(cred.user.uid).set({ email: cred.user.email, coins: 0, spent: 0, unlocked: [], vipBooks: [], history: [] }); } catch(e) { alert(e.message); } }
        async function loadAllUsers() { const snap = await db.collection('users').get(); document.getElementById('totalUsersList').innerHTML = `<p class="text-blue-400 font-bold mb-4 text-center">TOTAL USERS: ${snap.size}</p>` + snap.docs.map(doc => `<div class="luxury-card p-4 flex justify-between"><div><p class="font-bold text-sm">${doc.data().email}</p><p class="text-[9px] text-gray-500">${doc.id}</p></div><span class="text-yellow-500 font-black">${doc.data().coins} C</span></div>`).join(''); }
        async function loadCharts(type) { const snap = await db.collection('books').get(); document.getElementById('chartContainer').innerHTML = snap.docs.map(d => `<div class="flex justify-between border-b border-white/5 pb-2"><span>${d.data().title}</span><span class="text-blue-400">${type==='view'? (d.data().views||0)+' Views' : (d.data().sales||0)+' Coins'}</span></div>`).join(''); }
        async function loadUserStats() { const doc = await db.collection('users').doc(auth.currentUser.uid).get(); if(doc.exists) document.getElementById('userHistory').innerHTML = (doc.data().history || []).reverse().slice(0,5).map(h => `<div class="luxury-card p-4 text-[10px] flex justify-between"><div><p class="font-bold">${h.book}</p><p class="text-gray-500">${h.chapter}</p></div><span class="text-red-400">-${h.price} C</span></div>`).join(''); }
        async function handleVipPurchase() {
            const bDoc = await db.collection('books').doc(currentBookId).get(); const price = bDoc.data().vipPrice || 5000;
            const uRef = db.collection('users').doc(auth.currentUser.uid); const uDoc = await uRef.get();
            if((uDoc.data().coins||0) < price) return alert("Not enough coins!");
            if(confirm(`Buy VIP for ${price} C?`)) {
                await uRef.update({ coins: firebase.firestore.FieldValue.increment(-price), spent: firebase.firestore.FieldValue.increment(price), vipBooks: firebase.firestore.FieldValue.arrayUnion(currentBookId) });
                await db.collection('books').doc(currentBookId).update({ vips: firebase.firestore.FieldValue.increment(1), sales: firebase.firestore.FieldValue.increment(price) });
                alert("VIP Activated!"); loadChapters(currentBookId);
            }
        }
    </script>
</body>
</html>
