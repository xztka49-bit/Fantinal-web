<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FANTINAL - Emperor Eternal Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #010409; --card: #0d1117; --gold: #d4af37; --silver: #e2e8f0;
            --purple: #a855f7; --text: #f0f6fc; --text-dim: #8b949e; --red: #ff3e3e; --green: #238636;
            --v0: #8b949e; --v1: #22c55e; --v2: #cd7f32; --v3: #c0c0c0; --v4: #d4af37; --v5: #a855f7; --v6: #ff3e3e;
        }

        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 90px; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .logo { font-family: 'Cinzel', serif; letter-spacing: 2px; }

        /* UI COMPONENTS */
        .view { display: none; padding: 20px; animation: slide 0.4s ease; }
        .active-view { display: block; }
        @keyframes slide { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.05); }
        .btn { padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; text-transform: uppercase; font-size: 0.8rem; }
        .btn-gold { background: linear-gradient(45deg, #d4af37, #fef08a); color: #000; }
        
        input, textarea, select { width: 100%; padding: 14px; margin: 10px 0; background: #161b22; border: 1px solid #30363d; color: white; border-radius: 12px; box-sizing: border-box; }

        /* CHAT BUBBLES */
        .chat-msg { padding: 12px; border-radius: 15px; margin-bottom: 12px; font-size: 0.9rem; border: 1px solid transparent; }
        .v5-frame { border: 2px solid var(--purple); background: rgba(168, 85, 247, 0.1); }
        .v6-frame { border: 2px solid var(--gold); background: rgba(255, 62, 62, 0.1); animation: glow 2s infinite; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px var(--red); } 50% { box-shadow: 0 0 20px var(--red); } }

        .vip-tag { padding: 3px 8px; border-radius: 5px; font-size: 0.6rem; font-weight: 900; margin-right: 5px; }
        .t0{background:var(--v0)} .t1{background:var(--v1)} .t2{background:var(--v2)} .t3{background:var(--v3);color:#000} 
        .t4{background:var(--v4);color:#000} .t5{background:var(--v5)} .t6{background:var(--v6)}

        /* NOVEL DISPLAY */
        .novel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .n-card { border-radius: 15px; overflow: hidden; background: var(--card); cursor: pointer; border: 1px solid transparent; }
        .n-card img { width: 100%; height: 210px; object-fit: cover; }
        .n-card-title { padding: 10px; font-size: 0.8rem; font-weight: 600; text-align: center; color: var(--gold); }

        /* NAVIGATION */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: rgba(13,17,23,0.95); display: flex; padding: 15px 0; border-top: 1px solid var(--gold); z-index: 2000; }
        .nav-item { color: var(--text-dim); font-size: 0.7rem; text-align: center; flex: 1; }
        .nav-item.active { color: var(--gold); font-weight: bold; }

        /* ADMIN TABLES */
        .admin-table { width:100%; border-collapse: collapse; font-size: 0.75rem; }
        .admin-table th, .admin-table td { border: 1px solid #30363d; padding: 10px; text-align: left; }
    </style>
</head>
<body>

<header style="padding: 15px 20px; border-bottom: 1px solid rgba(212,175,55,0.2); display: flex; justify-content: space-between; align-items: center; background: var(--card); position: sticky; top:0; z-index:1000;">
    <div class="logo" style="color:var(--gold); font-size: 1.2rem;">FANTINAL</div>
    <div id="authBox">
        <button id="loginBtn" onclick="login()" class="btn-gold" style="padding: 8px 18px; border-radius: 20px;">SIGN IN</button>
        <div id="userHeader" style="display:none; text-align: right;">
            <div style="color:var(--gold); font-weight: bold;">ü™ô <span id="hCoins">0</span></div>
            <div id="hVip"></div>
        </div>
    </div>
</header>

<div id="home-view" class="view active-view">
    <input type="text" id="searchBar" placeholder="Search novels..." oninput="searchNovel()">
    <div class="novel-grid" id="novelGrid"></div>
</div>

<div id="detail-view" class="view">
    <button class="btn" onclick="showView('home-view')" style="color:var(--gold); background:none;">‚Üê BACK</button>
    <div id="novelInfo"></div>
    <div id="chapterList"></div>
</div>

<div id="reader-view" class="view" style="padding:0;">
    <div style="position: sticky; top: 0; background: var(--card); padding: 15px; border-bottom: 1px solid var(--gold); display:flex; justify-content: space-between; align-items: center;">
        <button onclick="showView('detail-view')" style="background:none; color:var(--gold); border:none;">‚úï EXIT</button>
        <span id="rChNum" style="color:var(--gold)"></span>
    </div>
    <div style="padding: 20px; max-width: 800px; margin: auto;">
        <h2 id="rChTitle" style="text-align:center;"></h2>
        <div id="rContent" style="line-height:2.2; font-size:1.2rem; white-space:pre-wrap;"></div>
        <div style="display:flex; gap:10px; margin-top:30px; margin-bottom: 50px;">
            <button id="prevBtn" class="btn" style="flex:1; background:#334155; color:white;">PREV</button>
            <button id="nextBtn" class="btn btn-gold" style="flex:1;">NEXT</button>
        </div>
    </div>
</div>

<div id="shop-view" class="view">
    <div class="card" style="text-align:center; border: 1px solid var(--gold);">
        <h1 style="color:var(--gold);">ü™ô <span id="sCoins">0</span></h1>
        <p>CURRENT BALANCE</p>
    </div>
    <h3>Topup Packages</h3>
    <div id="packageGrid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
    
    <div id="topupForm" class="card" style="display:none; border: 2px solid var(--gold); margin-top:20px;">
        <div style="background: #0066ff; padding: 15px; border-radius: 10px; text-align: center; color: white; margin-bottom: 10px;">
            <p>KBZPay / WavePay</p>
            <h3>09759731746</h3>
            <p>THU KHA AUNG</p>
        </div>
        <input type="text" id="tpName" placeholder="Account Name">
        <input type="text" id="tpID" placeholder="Last 6 digits of Transaction">
        <button class="btn btn-gold" style="width:100%" onclick="submitTopup()">SUBMIT PAYMENT</button>
    </div>
</div>

<div id="chat-view" class="view">
    <div id="chatBox" class="card" style="height:400px; overflow-y:auto; display:flex; flex-direction:column-reverse;"></div>
    <div style="display:flex; gap:10px;">
        <input type="text" id="chatInput" placeholder="Message..." style="margin:0;">
        <button onclick="sendChat()" class="btn-gold" style="padding:0 20px;">SEND</button>
    </div>
</div>

<div id="profile-view" class="view">
    <div class="card" style="text-align:center;">
        <h2 id="pName">User</h2>
        <div id="pVip"></div>
        <button class="btn" onclick="auth.signOut()" style="color:var(--red); background:none; margin-top:10px;">LOGOUT</button>
    </div>
    <button class="btn" style="width:100%; background:#1e293b; color:white; margin-bottom:10px;" onclick="showView('history-view')">TRANSACTION HISTORY</button>
    <div id="adminPanelBtn" style="display:none;">
        <button class="btn" onclick="showView('admin-view')" style="width:100%; background:var(--red); color:white;">MASTER ADMIN PANEL</button>
    </div>
</div>

<div id="history-view" class="view">
    <button class="btn" onclick="showView('profile-view')" style="color:var(--gold); background:none;">‚Üê BACK</button>
    <h3>History</h3>
    <div id="historyList"></div>
</div>

<div id="admin-view" class="view">
    <button class="btn" onclick="showView('profile-view')" style="color:var(--red); background:none;">‚Üê EXIT ADMIN</button>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
        <button class="btn" style="background:#334155; color:white;" onclick="openAdminTab('adm-req')">Requests</button>
        <button class="btn" style="background:#334155; color:white;" onclick="openAdminTab('adm-novel')">Novel Mgr</button>
    </div>

    <div id="adm-req" class="adm-tab">
        <h4>Pending Payments</h4>
        <div id="pendingReqs"></div>
    </div>

    <div id="adm-novel" class="adm-tab" style="display:none;">
        <div class="card">
            <h4>Add/Edit Novel</h4>
            <input type="text" id="anID" placeholder="Novel ID (Empty for New)">
            <input type="text" id="anTit" placeholder="Title">
            <input type="text" id="anAut" placeholder="Author">
            <input type="text" id="anCov" placeholder="Cover URL">
            <textarea id="anDes" placeholder="Description"></textarea>
            <input type="number" id="anVip" placeholder="Full Access Price">
            <button class="btn btn-gold" onclick="saveNovel()">SAVE NOVEL</button>
        </div>
        <div class="card">
            <h4>Chapter Manager</h4>
            <select id="admNovelSelect" onchange="loadAdmChapters()"></select>
            <input type="number" id="acNum" placeholder="Ch Number">
            <input type="text" id="acTit" placeholder="Ch Title">
            <textarea id="acCon" placeholder="Content OR Bulk (Title|Content||Title|Content)"></textarea>
            <input type="number" id="acCost" placeholder="Cost">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-gold" style="flex:1" onclick="saveChapter()">SINGLE</button>
                <button class="btn" style="flex:1; background:var(--purple); color:white;" onclick="bulkUpload()">BULK</button>
            </div>
            <div id="admChList" style="margin-top:15px; font-size:0.7rem;"></div>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="showView('home-view')">üè†<br>Home</div>
    <div class="nav-item" onclick="showView('shop-view')">üí∞<br>Shop</div>
    <div class="nav-item" onclick="showView('chat-view')">üí¨<br>Chat</div>
    <div class="nav-item" onclick="showView('profile-view')">üë§<br>Account</div>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, query, getDocs, getDoc, updateDoc, increment, setDoc, addDoc, where, orderBy, limit, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const config = { apiKey: "AIzaSyBxh92A7E6Egtk4kYB23Wmlelq13YYh1J0", authDomain: "fantinal-publishing-5b960.firebaseapp.com", projectId: "fantinal-publishing-5b960", storageBucket: "fantinal-publishing-5b960.firebasestorage.app", messagingSenderId: "961612304854", appId: "1:961612304854:web:6bf7b03072ed83b58b9477" };
    const app = initializeApp(config);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const ADMIN_EMAIL = "xztka49@gmail.com";
    let currentUser = null, userData = null, selTopup = 0;

    window.login = () => signInWithPopup(auth, provider);

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            currentUser = user;
            const uRef = doc(db, "users", user.uid);
            const snap = await getDoc(uRef);
            if(!snap.exists()) await setDoc(uRef, { name: user.displayName, email: user.email, coins: 0, spent: 0 });
            
            onSnapshot(uRef, s => { userData = s.data(); updateUI(); });
            if(user.email === ADMIN_EMAIL) document.getElementById('adminPanelBtn').style.display = 'block';
            loadNovels();
            loadHistory();
        } else {
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('userHeader').style.display = 'none';
        }
    });

    function getVip(spent) {
        if(spent >= 3000000) return {n:"Emperor", c:"t6", nc:"name-red", fc:"v6-frame"};
        if(spent >= 1000000) return {n:"King", c:"t5", nc:"name-purple", fc:"v5-frame"};
        if(spent >= 400000) return {n:"Master", c:"t4", nc:"name-gold", fc:""};
        return {n:"Newbie", c:"t0", nc:"name-white", fc:""};
    }

    function updateUI() {
        const vip = getVip(userData.spent);
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('userHeader').style.display = 'block';
        document.getElementById('hCoins').innerText = userData.coins.toLocaleString();
        document.getElementById('sCoins').innerText = userData.coins.toLocaleString();
        document.getElementById('hVip').innerHTML = `<span class="vip-tag ${vip.c}">${vip.n}</span>`;
        document.getElementById('pName').innerText = userData.name;
        document.getElementById('pVip').innerHTML = `<span class="vip-tag ${vip.c}">${vip.n}</span>`;
    }

    // NOVELS
    async function loadNovels() {
        onSnapshot(collection(db, "novels"), snap => {
            const grid = document.getElementById('novelGrid'); grid.innerHTML = "";
            const sel = document.getElementById('admNovelSelect'); sel.innerHTML = "";
            snap.forEach(d => {
                const n = d.data();
                grid.innerHTML += `<div class="n-card" onclick="openNovel('${d.id}')"><img src="${n.cover}"><div class="n-card-title">${n.title}</div></div>`;
                sel.innerHTML += `<option value="${d.id}">${n.title}</option>`;
            });
        });
    }

    window.openNovel = async (id) => {
        const n = (await getDoc(doc(db, "novels", id))).data();
        showView('detail-view');
        const isVip = (await getDoc(doc(db, "users", currentUser.uid, "unlocked_novels", id))).exists();
        document.getElementById('novelInfo').innerHTML = `
            <img src="${n.cover}" style="width:100%; height:250px; object-fit:cover; border-radius:15px;">
            <h2 style="color:var(--gold)">${n.title}</h2>
            <p>${n.desc}</p>
            ${isVip ? `<button class="btn" style="width:100%; background:var(--green); color:white;">LIFETIME UNLOCKED</button>` : `<button class="btn btn-gold" style="width:100%" onclick="buyFull('${id}', ${n.vipPrice})">UNLOCK ALL (ü™ô${n.vipPrice})</button>`}
        `;
        loadChapters(id);
    };

    async function loadChapters(nid) {
        const snap = await getDocs(query(collection(db, "novels", nid, "chapters"), orderBy("num", "asc")));
        const list = document.getElementById('chapterList');
        list.innerHTML = "<h3>Chapters</h3>";
        const isVip = (await getDoc(doc(db, "users", currentUser.uid, "unlocked_novels", nid))).exists();
        
        snap.forEach(async d => {
            const c = d.data();
            const isUnl = (await getDoc(doc(db, "users", currentUser.uid, "unlocked_chapters", d.id))).exists();
            let label = c.cost === 0 || isVip || isUnl ? "READ" : `ü™ô ${c.cost}`;
            list.innerHTML += `<div class="card" onclick="readChapter('${nid}','${d.id}',${c.cost},${c.num})" style="display:flex; justify-content:space-between; cursor:pointer;"><span>Ch ${c.num}: ${c.title}</span><b style="color:var(--gold)">${label}</b></div>`;
        });
    }

    window.readChapter = async (nid, cid, cost, num) => {
        const isVip = (await getDoc(doc(db, "users", currentUser.uid, "unlocked_novels", nid))).exists();
        const isUnl = (await getDoc(doc(db, "users", currentUser.uid, "unlocked_chapters", cid))).exists();
        
        if(cost === 0 || isVip || isUnl) {
            const c = (await getDoc(doc(db, "novels", nid, "chapters", cid))).data();
            showView('reader-view');
            document.getElementById('rChNum').innerText = "Chapter " + num;
            document.getElementById('rChTitle').innerText = c.title;
            document.getElementById('rContent').innerText = c.content;
            window.scrollTo(0,0);
            updateReaderNav(nid, num);
        } else {
            if(userData.coins < cost) return alert("Not enough coins!");
            if(confirm(`Unlock Chapter ${num} for ü™ô${cost}?`)) {
                await updateDoc(doc(db, "users", currentUser.uid), { coins: increment(-cost), spent: increment(cost) });
                await setDoc(doc(db, "users", currentUser.uid, "unlocked_chapters", cid), { date: serverTimestamp() });
                readChapter(nid, cid, cost, num);
            }
        }
    };

    async function updateReaderNav(nid, num) {
        const next = await getDocs(query(collection(db, "novels", nid, "chapters"), where("num", "==", num+1), limit(1)));
        const prev = await getDocs(query(collection(db, "novels", nid, "chapters"), where("num", "==", num-1), limit(1)));
        document.getElementById('nextBtn').onclick = () => next.empty ? alert("Last chapter") : readChapter(nid, next.docs[0].id, next.docs[0].data().cost, num+1);
        document.getElementById('prevBtn').onclick = () => prev.empty ? alert("First chapter") : readChapter(nid, prev.docs[0].id, prev.docs[0].data().cost, num-1);
    }

    // SHOP
    [1000, 2000, 5000, 10000, 30000, 50000].forEach(p => {
        document.getElementById('packageGrid').innerHTML += `<div class="card" onclick="openTopup(${p})" style="text-align:center; cursor:pointer;">ü™ô ${p.toLocaleString()}</div>`;
    });
    window.openTopup = (amt) => { selTopup = amt; document.getElementById('topupForm').style.display='block'; };
    window.submitTopup = async () => {
        const tid = document.getElementById('tpID').value;
        if(tid.length < 6) return alert("Invalid Transaction ID");
        await addDoc(collection(db, "transactions"), { uid: currentUser.uid, name: userData.name, amount: selTopup, tid, status: "Pending", type: "Topup", date: serverTimestamp() });
        alert("Payment submitted for approval!");
        document.getElementById('topupForm').style.display='none';
    };

    // CHAT
    window.sendChat = async () => {
        const msg = document.getElementById('chatInput').value;
        if(!msg) return;
        const vip = getVip(userData.spent);
        await addDoc(collection(db, "chat"), { name: userData.name, text: msg, vName: vip.n, vCls: vip.c, fCls: vip.fc, date: serverTimestamp() });
        document.getElementById('chatInput').value = "";
    };
    onSnapshot(query(collection(db, "chat"), orderBy("date", "desc"), limit(30)), snap => {
        const box = document.getElementById('chatBox'); box.innerHTML = "";
        snap.forEach(d => {
            const m = d.data();
            box.innerHTML += `<div class="chat-msg ${m.fCls}"><span class="vip-tag ${m.vCls}">${m.vName}</span><b>${m.name}</b>: ${m.text}</div>`;
        });
    });

    // ADMIN ACTIONS
    window.openAdminTab = (id) => {
        document.querySelectorAll('.adm-tab').forEach(t => t.style.display='none');
        document.getElementById(id).style.display='block';
        if(id === 'adm-req') loadAdmReqs();
    };

    function loadAdmReqs() {
        onSnapshot(query(collection(db, "transactions"), where("status", "==", "Pending")), snap => {
            const box = document.getElementById('pendingReqs'); box.innerHTML = "";
            snap.forEach(d => {
                const r = d.data();
                box.innerHTML += `<div class="card"><b>${r.name}</b> - ü™ô${r.amount}<br>TID: ${r.tid}<br><button class="btn-gold" onclick="approvePay('${d.id}','${r.uid}',${r.amount})" style="padding:5px 10px; margin-top:5px;">APPROVE</button></div>`;
            });
        });
    }

    window.approvePay = async (id, uid, amt) => {
        await updateDoc(doc(db, "transactions", id), { status: "Approved" });
        await updateDoc(doc(db, "users", uid), { coins: increment(amt) });
        alert("Approved!");
    };

    window.saveNovel = async () => {
        const id = document.getElementById('anID').value;
        const data = { title: document.getElementById('anTit').value, author: document.getElementById('anAut').value, cover: document.getElementById('anCov').value, desc: document.getElementById('anDes').value, vipPrice: Number(document.getElementById('anVip').value) };
        id ? await updateDoc(doc(db, "novels", id), data) : await addDoc(collection(db, "novels"), data);
        alert("Novel Saved!");
    };

    window.loadAdmChapters = async () => {
        const nid = document.getElementById('admNovelSelect').value;
        const snap = await getDocs(query(collection(db, "novels", nid, "chapters"), orderBy("num", "asc")));
        const box = document.getElementById('admChList'); box.innerHTML = "";
        snap.forEach(d => {
            box.innerHTML += `<div>Ch ${d.data().num} | <button onclick="delCh('${nid}','${d.id}')" style="color:red; background:none; border:none;">Del</button></div>`;
        });
    };

    window.saveChapter = async () => {
        const nid = document.getElementById('admNovelSelect').value;
        const data = { num: Number(document.getElementById('acNum').value), title: document.getElementById('acTit').value, content: document.getElementById('acCon').value, cost: Number(document.getElementById('acCost').value) };
        await addDoc(collection(db, "novels", nid, "chapters"), data);
        alert("Chapter Added!");
        loadAdmChapters();
    };

    window.bulkUpload = async () => {
        const nid = document.getElementById('admNovelSelect').value;
        const raw = document.getElementById('acCon').value;
        const cost = Number(document.getElementById('acCost').value) || 0;
        const blocks = raw.split('||');
        let startNum = Number(document.getElementById('acNum').value);
        
        for(let b of blocks) {
            const [t, c] = b.split('|');
            if(t && c) {
                await addDoc(collection(db, "novels", nid, "chapters"), { num: startNum, title: t.trim(), content: c.trim(), cost });
                startNum++;
            }
        }
        alert("Bulk Done!");
        loadAdmChapters();
    };

    window.showView = (id) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
        document.getElementById(id).classList.add('active-view');
        window.scrollTo(0,0);
    };

    function loadHistory() {
        onSnapshot(query(collection(db, "transactions"), where("uid", "==", currentUser.uid), orderBy("date", "desc")), snap => {
            const box = document.getElementById('historyList'); box.innerHTML = "";
            snap.forEach(d => {
                const h = d.data();
                box.innerHTML += `<div class="card" style="font-size:0.8rem;">${h.type} - ü™ô${h.amount} (${h.status})</div>`;
            });
        });
    }
</script>
</body>
</html>
