<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantinal Publishing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --bg: #1a1a1a; --card: #2d2d2d; --text: #f4f4f9; }
        body { background: var(--bg); color: var(--text); transition: 0.3s; font-family: sans-serif; margin: 0; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #444; background: #333; color: white; }
        .btn-blue { background: #2563eb; color: white; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <nav class="bg-blue-600 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-lg">
        <h1 class="text-xl font-bold">Fantinal</h1>
        <div id="navInfo" class="hidden flex items-center gap-3">
            <span id="userCoins" class="font-bold text-yellow-300">üí∞ 0 C</span>
            <button onclick="showSection('buyCoin')" class="text-xs bg-blue-800 px-2 py-1 rounded">+ Buy</button>
            <button onclick="logout()" class="text-xs text-red-200">Logout</button>
        </div>
    </nav>
    <main class="max-w-md mx-auto p-4">
        <div id="authSection" class="card mt-10">
            <h2 class="text-2xl font-bold mb-4 text-center">Login / Register</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()" class="btn-blue mb-2">Login</button>
            <button onclick="register()" class="w-full text-blue-400 font-bold text-sm text-center">Create Account (Register)</button>
        </div>

        <div id="buyCoin" class="card hidden">
            <h2 class="text-lg font-bold mb-4 text-blue-400">üí∞ Coin ·Äù·Äö·Ä∫·Äö·Ä∞·Äõ·Äî·Ä∫</h2>
            <div class="text-xs bg-blue-900 p-3 rounded mb-4 text-blue-100 leading-5">
                KPay / Wave: 09759731746 (THU KHA AUNG)<br>·ÄÑ·ÄΩ·Ä±·Äú·ÄΩ·Äæ·Ä≤·Äï·Äº·ÄÆ·Ä∏·Äô·Äæ ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·Äï·Ä´ Form ·Äñ·Äº·Ää·Ä∑·Ä∫·Äï·Ä´·Åã
            </div>
            <input type="text" id="payName" placeholder="·ÄÑ·ÄΩ·Ä±·Äú·ÄΩ·Äæ·Ä≤·Äû·Ä∞·Ä°·Äô·Ää·Ä∫">
            <input type="text" id="payPhone" placeholder="·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Äê·Ä∫">
            <input type="text" id="payLast6" placeholder="·Äï·Äº·Ä±·ÄÖ·Ä¨·Äî·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏ ·ÅÜ ·Äú·ÄØ·Ä∂·Ä∏">
            <select id="coinPkg">
                <option value="1000">1000 Coins - 1000 MMK</option>
                <option value="5000">5000 Coins - 5000 MMK</option>
            </select>
            <button onclick="submitRequest()" class="btn-blue">Request Approval</button>
            <button onclick="showSection('novelList')" class="w-full mt-4 text-gray-400 text-sm">Back</button>
        </div>

        <div id="novelList" class="hidden">
            <div id="adminPanel" class="card hidden border-t-4 border-blue-500">
                <h3 class="font-bold mb-2">Admin</h3>
                <div class="flex gap-2">
                    <button onclick="showSection('adminNovel')" class="bg-green-600 text-white px-3 py-1 rounded text-xs">Add Novel</button>
                    <button onclick="showSection('adminApprove')" class="bg-orange-600 text-white px-3 py-1 rounded text-xs">Requests (<span id="pendingCount">0</span>)</button>
                </div>
            </div>
            <div id="listDisplay"></div>
        </div>

        <div id="adminNovel" class="card hidden">
            <input type="text" id="nTitle" placeholder="·ÄÖ·Ä¨·Ä°·ÄØ·Äï·Ä∫·Ä°·Äô·Ää·Ä∫">
            <input type="text" id="nChapter" placeholder="·Ä°·Äï·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ (e.g. ·Ä°·Äï·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ ·ÅÅ)">
            <textarea id="nContent" placeholder="·Äá·Ä¨·Äê·Ä∫·Äú·Äô·Ä∫·Ä∏·ÄÖ·Ä¨·Äû·Ä¨·Ä∏..." class="h-40"></textarea>
            <input type="number" id="nPrice" placeholder="Coin (0 ·ÄÜ·Ä≠·ÄØ·Äõ·ÄÑ·Ä∫ Free)">
            <button onclick="uploadNovel()" class="btn-blue">Publish</button>
        </div>

        <div id="adminApprove" class="card hidden">
            <h2 class="font-bold mb-4">·ÄÑ·ÄΩ·Ä±·Äú·ÄΩ·Äæ·Ä≤·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏·Äõ·Äî·Ä∫</h2>
            <div id="requestList"></div>
            <button onclick="showSection('novelList')" class="w-full mt-4 text-gray-400">Back</button>
        </div>
    </main>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBxh92A7E6Egtk4kYB23Wmlelq13YYh1J0",
            authDomain: "fantinal-publishing-5b960.firebaseapp.com",
            projectId: "fantinal-publishing-5b960",
            storageBucket: "fantinal-publishing-5b960.firebasestorage.app",
            messagingSenderId: "961612304854",
            appId: "1:961612304854:web:6bf7b03072ed83b58b9477"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        function showSection(id) {
            ['authSection', 'buyCoin', 'novelList', 'adminNovel', 'adminApprove'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('navInfo').classList.remove('hidden');
                if (user.email === 'xztka49@gmail.com') {
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadPendingRequests();
                }
                syncUserData(user.uid);
                showSection('novelList');
                loadNovels();
            } else { showSection('authSection'); }
        });

        async function register() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try {
                const cred = await auth.createUserWithEmailAndPassword(e, p);
                await db.collection('users').doc(cred.user.uid).set({ email: e, coins: 0 });
                alert("Success!");
            } catch (err) { alert(err.message); }
        }

        async function login() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try { await auth.signInWithEmailAndPassword(e, p); } catch (err) { alert("Error!"); }
        }

        function logout() { auth.signOut(); location.reload(); }

        async function syncUserData(uid) {
            db.collection('users').doc(uid).onSnapshot(doc => {
                if (doc.exists) document.getElementById('userCoins').innerText = `üí∞ ${doc.data().coins || 0} C`;
            });
        }

        async function submitRequest() {
            const data = {
                uid: auth.currentUser.uid,
                email: auth.currentUser.email,
                name: document.getElementById('payName').value,
                phone: document.getElementById('payPhone').value,
                last6: document.getElementById('payLast6').value,
                amount: parseInt(document.getElementById('coinPkg').value),
                status: 'pending',
                date: new Date()
            };
            await db.collection('coinRequests').add(data);
            alert("Sent Request!");
            showSection('novelList');
        }

        function loadPendingRequests() {
            db.collection('coinRequests').where('status', '==', 'pending').onSnapshot(snap => {
                document.getElementById('pendingCount').innerText = snap.size;
                const list = document.getElementById('requestList');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const req = doc.data();
                    list.innerHTML += `<div class="border-b border-gray-600 py-3">
                        <p class="text-sm">User: ${req.email} (${req.amount}C)</p>
                        <p class="text-xs text-gray-400">Code: ${req.last6}</p>
                        <button onclick="approveCoin('${doc.id}','${req.uid}',${req.amount})" class="bg-blue-600 px-3 py-1 rounded text-xs mt-2">Approve</button>
                    </div>`;
                });
            });
        }

        async function approveCoin(rid, uid, amt) {
            const ref = db.collection('users').doc(uid);
            const doc = await ref.get();
            await ref.update({ coins: (doc.data().coins || 0) + amt });
            await db.collection('coinRequests').doc(rid).update({ status: 'approved' });
            alert("Approved!");
        }

        async function uploadNovel() {
            await db.collection('novels').add({
                title: document.getElementById('nTitle').value,
                chapter: document.getElementById('nChapter').value,
                content: document.getElementById('nContent').value,
                price: parseInt(document.getElementById('nPrice').value) || 0,
                createdAt: new Date()
            });
            alert("Published!");
            showSection('novelList');
        }

        function loadNovels() {
            db.collection('novels').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const list = document.getElementById('listDisplay');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const n = doc.data();
                    list.innerHTML += `<div class="card flex justify-between items-center">
                        <div><h4 class="font-bold text-blue-400">${n.title}</h4><p class="text-xs">${n.chapter} (${n.price}C)</p></div>
                        <button onclick="readNovel('${doc.id}',${n.price})" class="bg-blue-600 px-4 py-1 rounded-full text-xs">Read</button>
                    </div>`;
                });
            });
        }

        async function readNovel(id, pr) {
            const uid = auth.currentUser.uid;
            const user = await db.collection('users').doc(uid).get();
            const coins = user.data().coins || 0;
            if (pr > 0 && coins < pr) return alert("No Coins!");
            if (pr > 0) await db.collection('users').doc(uid).update({ coins: coins - pr });
            const doc = await db.collection('novels').doc(id).get();
            document.body.innerHTML = `<div class="p-6 bg-gray-900 text-gray-100 min-h-screen">
                <button onclick="location.reload()" class="text-blue-400 mb-4">‚Üê Back</button>
                <h1 class="text-2xl font-bold">${doc.data().title}</h1><h2 class="mb-4">${doc.data().chapter}</h2>
                <div class="whitespace-pre-wrap text-lg">${doc.data().content}</div>
            </div>`;
        }
    </script>
</body>
</html>
