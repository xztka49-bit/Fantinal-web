<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantinal - Premium Reader</title>
    <style>
        :root { --gold: #D4AF37; --bg: #0B1120; --card: #111827; --text: #E5E7EB; --blue: #3B82F6; --glass: rgba(17, 24, 39, 0.8); }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 70px; overflow-x: hidden; }

        /* Header & Drawer */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--card); border-bottom: 1px solid rgba(212,175,55,0.2); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .logo { color: var(--gold); font-size: 1.3rem; font-weight: bold; letter-spacing: 1px; }
        .top-balance { background: rgba(212,175,55,0.1); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--gold); color: var(--gold); font-weight: bold; font-size: 0.9rem; }
        
        .drawer { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: var(--glass); z-index: 1000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-right: 1px solid var(--gold); backdrop-filter: blur(15px); }
        .drawer.active { left: 0; }
        .drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 999; }

        /* Views */
        .view { display: none; padding: 20px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Search Bar */
        .search-box { position: relative; margin-bottom: 25px; }
        .search-input { width: 100%; padding: 14px 20px; border-radius: 30px; border: 1px solid #1F2937; background: #1F2937; color: white; box-sizing: border-box; outline: none; transition: 0.3s; }
        .search-input:focus { border-color: var(--gold); box-shadow: 0 0 10px rgba(212,175,55,0.2); }

        /* Novel Grid */
        .novel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; }
        .novel-card { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid #1F2937; transition: 0.3s; cursor: pointer; }
        .novel-card:hover { transform: translateY(-5px); border-color: var(--gold); }
        .novel-card img { width: 100%; height: 210px; object-fit: cover; }
        .novel-info { padding: 12px; }
        .novel-title { color: var(--gold); font-weight: bold; font-size: 0.85rem; height: 2.5em; overflow: hidden; }
        .novel-meta { font-size: 0.7rem; color: #9CA3AF; margin-top: 5px; }

        /* VIP & Chapter UI */
        .vip-banner { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); padding: 20px; border-radius: 15px; border: 1px solid var(--gold); margin-bottom: 25px; text-align: center; }
        .chapter-row { background: var(--card); padding: 16px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #1F2937; cursor: pointer; }
        .chapter-row:hover { background: #1F2937; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #1F2937; z-index: 100; }
        .nav-item { color: #6B7280; font-size: 0.75rem; text-align: center; cursor: pointer; }
        .nav-item.active { color: var(--gold); }

        /* Buttons */
        .btn-gold { background: var(--gold); color: black; border: none; padding: 12px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-gold:active { transform: scale(0.98); }
    </style>
</head>
<body>

<header id="mainHeader" style="display:none;">
    <div onclick="toggleDrawer()" style="font-size:24px; color:var(--gold); cursor:pointer;">‚ò∞</div>
    <div class="logo">FANTINAL</div>
    <div class="top-balance">ü™ô <span id="topBalance">0</span></div>
</header>

<div class="drawer-overlay" id="overlay" onclick="toggleDrawer()"></div>
<div class="drawer" id="sidebar">
    <div style="padding:40px 20px; text-align:center; border-bottom:1px solid #1F2937;">
        <div style="font-size:50px; margin-bottom:10px;">üë§</div>
        <h3 id="sideName" style="margin:0;">Reader</h3>
        <p id="sideRole" style="color:var(--gold); font-size:0.8rem; margin:5px 0;"></p>
    </div>
    <div style="padding:20px;">
        <div class="menu-item" onclick="showView('home-view'); toggleDrawer();" style="padding:15px 0; cursor:pointer;">üè† Home Explore</div>
        <div class="menu-item" onclick="showView('shop-view'); toggleDrawer();" style="padding:15px 0; cursor:pointer;">üí∞ Buy Coins</div>
        <div id="adminPanelLink" style="display:none; color:#3B82F6; padding:15px 0; cursor:pointer;" onclick="location.href='admin.html'">‚öôÔ∏è Admin Master</div>
        <div style="padding:15px 0; color:var(--red); cursor:pointer; margin-top:50px;" onclick="auth.signOut()">üö™ Logout</div>
    </div>
</div>

<div id="home-view" class="view">
    <div class="search-box">
        <input type="text" id="searchBar" class="search-input" placeholder="Search your favorite novels..." oninput="searchNovels()">
    </div>
    <h3 style="margin-top:0;">Featured Stories</h3>
    <div class="novel-grid" id="novelList"></div>
</div>

<div id="detail-view" class="view">
    <div onclick="showView('home-view')" style="color:var(--gold); margin-bottom:15px; cursor:pointer;">‚Üê Back to Home</div>
    <div id="vipBannerArea"></div>
    <h3 style="margin-bottom:15px;">Chapters</h3>
    <div id="chapterList"></div>
</div>

<div id="reader-view" class="view">
    <div onclick="showView('detail-view')" style="color:var(--gold); margin-bottom:15px; cursor:pointer;">‚Üê Back to Chapters</div>
    <h2 id="readTitle" style="color:var(--gold); margin-bottom:20px;"></h2>
    <div id="readContent" style="line-height:2; font-size:1.15rem; white-space:pre-wrap; text-align:justify; color:#D1D5DB;"></div>
</div>

<div id="shop-view" class="view">
    <h3>Coin Store</h3>
    <div id="packageList"></div>
</div>

<nav class="bottom-nav" id="bottomNav" style="display:none;">
    <div class="nav-item active" onclick="showView('home-view')">üè†<br>Home</div>
    <div class="nav-item" onclick="showView('shop-view')">üí∞<br>Coins</div>
    <div class="nav-item" onclick="toggleDrawer()">üë§<br>Menu</div>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, collection, query, getDocs, getDoc, updateDoc, increment, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyBxh92A7E6Egtk4kYB23Wmlelq13YYh1J0", 
        authDomain: "fantinal-publishing-5b960.firebaseapp.com", 
        projectId: "fantinal-publishing-5b960", 
        storageBucket: "fantinal-publishing-5b960.firebasestorage.app", 
        messagingSenderId: "961612304854", 
        appId: "1:961612304854:web:6bf7b03072ed83b58b9477" 
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userUid, allNovels = [], currentNovel;

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            userUid = user.uid;
            document.getElementById('mainHeader').style.display = 'flex';
            document.getElementById('bottomNav').style.display = 'flex';
            showView('home-view');
            
            onSnapshot(doc(db, "users", user.uid), (s) => {
                const data = s.data();
                const bal = data?.coin_balance || 0;
                document.getElementById('topBalance').innerText = bal;
                document.getElementById('sideName').innerText = data?.username || "Reader";
                document.getElementById('sideRole').innerText = "VIP: " + (data?.role || "User");
                if(data?.role === "admin") document.getElementById('adminPanelLink').style.display = 'block';
            });
            loadNovels();
            loadPackages();
        } else {
            // Redirect to a login page if needed
            alert("Please login first!");
        }
    });

    // --- Novel Management ---
    async function loadNovels() {
        const snap = await getDocs(collection(db, "novels"));
        allNovels = snap.docs.map(d => ({id: d.id, ...d.data()}));
        displayNovels(allNovels);
    }

    function displayNovels(list) {
        const grid = document.getElementById('novelList');
        grid.innerHTML = "";
        list.forEach(n => {
            grid.innerHTML += `
                <div class="novel-card" onclick="openNovel('${n.id}')">
                    <img src="${n.cover}">
                    <div class="novel-info">
                        <div class="novel-title">${n.title}</div>
                        <div class="novel-meta">${n.author} ‚Ä¢ ${n.category || 'Novel'}</div>
                    </div>
                </div>`;
        });
    }

    window.searchNovels = () => {
        const term = document.getElementById('searchBar').value.toLowerCase();
        const filtered = allNovels.filter(n => n.title.toLowerCase().includes(term) || n.author.toLowerCase().includes(term));
        displayNovels(filtered);
    };

    window.openNovel = async (id) => {
        currentNovel = allNovels.find(n => n.id === id);
        showView('detail-view');
        
        const vipSnap = await getDoc(doc(db, "users", userUid, "unlocked_novels", id));
        const isVip = vipSnap.exists();

        const banner = document.getElementById('vipBannerArea');
        banner.innerHTML = isVip ? 
            `<div class="vip-banner" style="background:var(--gold); color:black;"><b>üåü PREMIUM ACCESS ACTIVE</b><br><small>All chapters are free for you</small></div>` :
            `<div class="vip-banner">
                <h4 style="margin:0; color:var(--gold);">Buy Lifetime Access</h4>
                <p style="font-size:0.8rem; margin:10px 0;">Unlock all current and future chapters of this novel.</p>
                <button class="btn-gold" onclick="buyVipLifetime('${id}', ${currentNovel.vipPrice || 5000})">Unlock Full Novel: ü™ô ${currentNovel.vipPrice || 5000}</button>
            </div>`;

        const cSnap = await getDocs(collection(db, "novels", id, "chapters"));
        const cList = document.getElementById('chapterList');
        cList.innerHTML = "";
        
        for (let d of cSnap.docs) {
            const ch = d.data();
            const unlocked = await getDoc(doc(db, "users", userUid, "unlocked_chapters", d.id));
            const statusText = (isVip || ch.cost === 0 || unlocked.exists()) ? "Read Now" : `ü™ô ${ch.cost}`;
            
            cList.innerHTML += `
                <div class="chapter-row" onclick="readChapter('${d.id}', ${ch.cost}, ${isVip})">
                    <span>Chapter ${ch.num}: ${ch.title}</span>
                    <span style="color:var(--gold); font-weight:bold; font-size:0.85rem;">${statusText}</span>
                </div>`;
        }
    };

    // --- Unlock Logic ---
    window.buyVipLifetime = async (nid, price) => {
        const uSnap = await getDoc(doc(db, "users", userUid));
        if(uSnap.data().coin_balance < price) return alert("Insufficient coins in your wallet!");
        
        if(confirm(`Do you want to buy Lifetime Access for ${price} coins?`)) {
            await updateDoc(doc(db, "users", userUid), { coin_balance: increment(-price) });
            await setDoc(doc(db, "users", userUid, "unlocked_novels", nid), { unlockedAt: serverTimestamp() });
            alert("Novel Unlocked Successfully!");
            openNovel(nid);
        }
    };

    window.readChapter = async (cid, cost, isVip) => {
        const unlockRef = doc(db, "users", userUid, "unlocked_chapters", cid);
        const unlocked = await getDoc(unlockRef);

        if(isVip || cost === 0 || unlocked.exists()) {
            const snap = await getDoc(doc(db, "novels", currentNovel.id, "chapters", cid));
            showView('reader-view');
            document.getElementById('readTitle').innerText = "Chapter " + snap.data().num + ": " + snap.data().title;
            document.getElementById('readContent').innerText = snap.data().content;
            window.scrollTo(0,0);
        } else {
            if(confirm(`Unlock this chapter for ${cost} coins?`)) {
                const uSnap = await getDoc(doc(db, "users", userUid));
                if(uSnap.data().coin_balance < cost) return alert("Not enough coins!");
                await updateDoc(doc(db, "users", userUid), { coin_balance: increment(-cost) });
                await setDoc(unlockRef, { unlockedAt: serverTimestamp() });
                readChapter(cid, cost, isVip);
            }
        }
    };

    // --- Shop Management ---
    async function loadPackages() {
        const snap = await getDocs(collection(db, "coin_packages"));
        const list = document.getElementById('packageList');
        list.innerHTML = "";
        snap.forEach(d => {
            const p = d.data();
            list.innerHTML += `
                <div style="padding:20px; background:var(--card); margin-bottom:12px; border:1px solid #1F2937; display:flex; justify-content:space-between; align-items:center; border-radius:15px;">
                    <div><b style="font-size:1.1rem; color:var(--gold);">ü™ô ${p.coins} Coins</b><br><small style="color:#9CA3AF;">Price: ${p.price} MMK</small></div>
                    <button class="btn-gold" style="width:auto; padding:8px 20px;" onclick="buyCoins(${p.coins})">Buy</button>
                </div>`;
        });
    }

    window.buyCoins = async (amt) => {
        await updateDoc(doc(db, "users", userUid), { coin_balance: increment(amt) });
        alert(amt + " coins have been added to your balance!");
    };

    // --- UI Helpers ---
    window.showView = (id) => {
        document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        if(id === 'home-view') document.querySelectorAll('.nav-item')[0].classList.add('active');
        if(id === 'shop-view') document.querySelectorAll('.nav-item')[1].classList.add('active');
    };

    window.toggleDrawer = () => {
        const side = document.getElementById('sidebar');
        const over = document.getElementById('overlay');
        side.classList.toggle('active');
        over.style.display = side.classList.contains('active') ? 'block' : 'none';
    };

</script>
</body>
</html>
